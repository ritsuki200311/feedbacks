<div class="max-w-4xl mx-auto p-6">
  <div class="bg-white rounded-lg shadow-md p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">é€ä¿¡ç›¸æ‰‹ã‚’é¸æŠ</h1>
    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
      <p class="text-sm text-yellow-800">
        <span class="font-semibold">ğŸ“‹ æ³¨æ„:</span> é€ä¿¡ç›¸æ‰‹ã¯æœ€å¤§5äººã¾ã§é¸æŠã§ãã¾ã™ã€‚
      </p>
    </div>
    
    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
      <h3 class="font-bold text-blue-800 mb-2">æŠ•ç¨¿å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <p class="text-lg font-semibold"><%= @post.title %></p>
      <p class="text-gray-600 mt-2"><%= truncate(@post.body, length: 100) %></p>
    </div>

    <%= form_with url: post_send_to_user_path(@post), method: :post, local: true, class: "space-y-8" do |form| %>
      
      <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="space-y-6" id="recipient-filters">
        <h2 class="text-xl font-bold text-gray-800 mb-4">é€ä¿¡ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§çµã‚Šè¾¼ã‚€</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="age_group" class="block text-sm font-medium text-gray-700 mb-1">å¹´é½¢å±¤</label>
            <%= select_tag :age_group, options_for_select(recipient_age_group_options), prompt: "æŒ‡å®šã—ãªã„", class: "w-full p-2 border border-gray-300 rounded-lg" %>
          </div>
          <div>
            <label for="creation_experience" class="block text-sm font-medium text-gray-700 mb-1">å‰µä½œçµŒé¨“</label>
            <%= select_tag :creation_experience, options_for_select(recipient_creation_experience_options), prompt: "æŒ‡å®šã—ãªã„", class: "w-full p-2 border border-gray-300 rounded-lg" %>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">å‰µä½œã‚¸ãƒ£ãƒ³ãƒ«</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            <% recipient_support_genres_options.each do |option| %>
              <label class="flex items-center">
                <input type="checkbox" name="support_genres[]" value="<%= option %>" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                <span class="ml-2 text-sm text-gray-700"><%= option %></span>
              </label>
            <% end %>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">ç²¾é€šã—ã¦ã„ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            <% recipient_interests_options.each do |option| %>
              <label class="flex items-center">
                <input type="checkbox" name="interests[]" value="<%= option %>" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                <span class="ml-2 text-sm text-gray-700"><%= option %></span>
              </label>
            <% end %>
          </div>
        </div>
      </div>

      <!-- ãƒãƒƒãƒãƒ³ã‚°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="matching-results" class="hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ãŠã™ã™ã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</h2>
        <p class="text-gray-600 mb-4">çµã‚Šè¾¼ã¿æ¡ä»¶ã«åˆè‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
        <div id="user-list" class="space-y-3">
          <!-- JavaScriptã§å‹•çš„ã«æŒ¿å…¥ -->
        </div>
      </div>

      <!-- æ‰‹å‹•ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="border-t pt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ã¾ãŸã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢</h2>
        <div class="flex gap-4 mb-4">
          <input type="text" id="user-search" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢..." 
                 class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          <button type="button" id="search-btn" 
                  class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            æ¤œç´¢
          </button>
        </div>
        <div id="search-results" class="space-y-2">
          <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
      </div>

      <!-- é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º -->
      <div id="selected-users" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
        <h3 class="font-semibold text-green-800 mb-2">é€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
        <div id="selected-users-list" class="space-y-2"></div>
        <%= form.hidden_field :selected_user_ids, id: "selected_user_ids" %>
      </div>

      <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
      <div class="text-center pt-6">
        <%= form.submit "é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡", 
            class: "px-8 py-3 bg-indigo-600 text-white rounded-lg font-bold text-lg hover:bg-indigo-700 transition-colors disabled:bg-gray-400", 
            id: "submit-btn", 
            disabled: true %>
      </div>
    <% end %>
  </div>
</div>

<script>
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã«ãƒãƒƒãƒãƒ³ã‚°çµæœã‚’æ›´æ–°
document.addEventListener('DOMContentLoaded', function() {
  const filters = document.getElementById('recipient-filters');
  
  filters.addEventListener('change', () => {
    showMatchingUsers();
  });

  // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚å®Ÿè¡Œ
  showMatchingUsers();
});

async function showMatchingUsers() {
  try {
    const ageGroup = document.getElementById('age_group').value;
    const creationExperience = document.getElementById('creation_experience').value;
    const supportGenres = Array.from(document.querySelectorAll('input[name="support_genres[]"]:checked')).map(cb => cb.value);
    const interests = Array.from(document.querySelectorAll('input[name="interests[]"]:checked')).map(cb => cb.value);

    const params = new URLSearchParams();
    if (ageGroup) params.append('age_group', ageGroup);
    if (creationExperience) params.append('creation_experience', creationExperience);
    supportGenres.forEach(g => params.append('support_genres[]', g));
    interests.forEach(i => params.append('interests[]', i));
    
    const response = await fetch(`<%= post_match_users_path(@post) %>?${params.toString()}`);
    const data = await response.json();
    
    if (data.error) {
      console.error('Matching error:', data.error);
      return;
    }
    
    const userListDiv = document.getElementById('user-list');
    
    userListDiv.innerHTML = '';
    if (data.users.length > 0) {
      data.users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer';
        userDiv.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold">${user.name}</h4>
              <p class="text-sm text-gray-600">${user.description}</p>
              <p class="text-xs text-indigo-600 mt-1">ãƒãƒƒãƒåº¦: ${user.score}%</p>
            </div>
            <button type="button" onclick="selectUser(${user.id}, '${user.name}')" 
                    class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                    id="select-btn-${user.id}">
              é¸æŠ
            </button>
          </div>
        `;
        userListDiv.appendChild(userDiv);
      });
    } else {
      userListDiv.innerHTML = '<p class="text-gray-500">æ¡ä»¶ã«åˆã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
    }
    document.getElementById('matching-results').classList.remove('hidden');
    
  } catch (error) {
    console.error('Matching API error:', error);
  }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢æ©Ÿèƒ½
document.getElementById('search-btn').addEventListener('click', async () => {
  const query = document.getElementById('user-search').value.trim();
  if (!query) return;
  
  try {
    const response = await fetch(`/search_simple?query=${encodeURIComponent(query)}&search_type=users`);
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '';
    
    const users = doc.querySelectorAll('.user-card');
    if (users.length === 0) {
      resultsDiv.innerHTML = '<p class="text-gray-500">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
    } else {
      resultsDiv.innerHTML = '<p class="text-green-600">æ¤œç´¢æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™</p>';
    }
  } catch (error) {
    console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
  }
});

// é¸æŠæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†ã™ã‚‹é…åˆ—
let selectedUsers = [];

// ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠé–¢æ•°ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œãƒ»5äººåˆ¶é™ï¼‰
function selectUser(userId, userName) {
  const existingIndex = selectedUsers.findIndex(user => user.id === userId);
  const button = document.getElementById(`select-btn-${userId}`);
  
  if (existingIndex !== -1) {
    // æ—¢ã«é¸æŠæ¸ˆã¿ - é¸æŠè§£é™¤
    selectedUsers.splice(existingIndex, 1);
    button.textContent = 'é¸æŠ';
    button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    
    // é¸æŠè§£é™¤æ™‚ã€ä»–ã®ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
    updateButtonStates();
  } else {
    // æ–°è¦é¸æŠ - 5äººåˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (selectedUsers.length >= 5) {
      alert('é€ä¿¡ç›¸æ‰‹ã¯æœ€å¤§5äººã¾ã§é¸æŠã§ãã¾ã™ã€‚');
      return;
    }
    
    selectedUsers.push({ id: userId, name: userName });
    button.textContent = 'é¸æŠæ¸ˆã¿';
    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    button.classList.add('bg-gray-500', 'hover:bg-gray-600');
    
    // 5äººã«é”ã—ãŸå ´åˆã€ä»–ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    if (selectedUsers.length >= 5) {
      updateButtonStates();
    }
  }
  
  updateSelectedUsersDisplay();
}

// é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
function updateSelectedUsersDisplay() {
  const container = document.getElementById('selected-users');
  const list = document.getElementById('selected-users-list');
  const submitBtn = document.getElementById('submit-btn');
  const hiddenInput = document.getElementById('selected_user_ids');
  
  if (selectedUsers.length > 0) {
    // é¸æŠæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º
    list.innerHTML = selectedUsers.map(user => `
      <div class="flex items-center justify-between bg-white p-2 rounded border">
        <span><strong>${user.name}</strong></span>
        <button type="button" onclick="removeUser(${user.id})" 
                class="text-red-500 hover:text-red-700 text-sm">
          å‰Šé™¤
        </button>
      </div>
    `).join('');
    
    container.classList.remove('hidden');
    submitBtn.disabled = false;
    
    // é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
    hiddenInput.value = selectedUsers.map(user => user.id).join(',');
    
    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
    submitBtn.textContent = `${selectedUsers.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡ (${selectedUsers.length}/5)`;
  } else {
    // é¸æŠãªã—ã®çŠ¶æ…‹
    container.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡';
    hiddenInput.value = '';
  }
}

// ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°é–¢æ•°
function updateButtonStates() {
  const allSelectButtons = document.querySelectorAll('[id^="select-btn-"]');
  
  allSelectButtons.forEach(button => {
    const userId = parseInt(button.id.replace('select-btn-', ''));
    const isSelected = selectedUsers.some(user => user.id === userId);
    
    if (!isSelected) {
      if (selectedUsers.length >= 5) {
        // 5äººã«é”ã—ã¦ã„ã‚‹å ´åˆã€æœªé¸æŠãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        button.classList.remove('hover:bg-indigo-700');
      } else {
        // 5äººæœªæº€ã®å ´åˆã€æœªé¸æŠãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        button.disabled = false;
        button.classList.remove('opacity-50', 'cursor-not-allowed');
        button.classList.add('hover:bg-indigo-700');
      }
    }
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤é–¢æ•°
function removeUser(userId) {
  const index = selectedUsers.findIndex(user => user.id === userId);
  if (index !== -1) {
    selectedUsers.splice(index, 1);
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
    const button = document.getElementById(`select-btn-${userId}`);
    if (button) {
      button.textContent = 'é¸æŠ';
      button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
      button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }
    
    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
    updateButtonStates();
    updateSelectedUsersDisplay();
  }
}
</script>
