<!DOCTYPE html>
<html>
  <head>
    <title>ã‚¢ãƒ—ãƒªå</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "tailwind", "application", "data-turbo-track": "reload", preload: false %>
    
    <!-- Application CSS ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŸ‹ã‚è¾¼ã¿ -->
    <style>
      .thumbnail {
          max-width: 200px;
          max-height: 200px;
          object-fit: cover;
          display: block;
        }

      /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚³ãƒ¡ãƒ³ãƒˆãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
      .compact-comment-highlight {
        background-color: #fef3c7 !important;
        border-color: #f59e0b !important;
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.3) !important;
        transform: scale(1.02);
        transition: all 0.3s ease-in-out;
      }

      /* line-clamp-2 utility for text truncation */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
      @media (max-width: 1279px) {
        .xl\\:col-span-6 {
          grid-column: span 12 / span 12;
        }
        .xl\\:col-span-3 {
          grid-column: span 12 / span 12;
        }
      }

      /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .custom-video {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
      }

      .custom-video::-webkit-media-controls-panel {
        background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.7));
      }

      .custom-audio {
        border-radius: 8px;
        height: 54px;
        background: transparent;
      }

      .custom-audio::-webkit-media-controls-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      .custom-audio::-webkit-media-controls-play-button,
      .custom-audio::-webkit-media-controls-pause-button {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .custom-audio::-webkit-media-controls-timeline {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’å®Œå…¨ã«éš ã™ */
      video::-webkit-media-controls-download-button,
      audio::-webkit-media-controls-download-button {
        display: none !important;
      }

      video::-internal-media-controls-download-button,
      audio::-internal-media-controls-download-button {
        display: none !important;
      }

      /* å³ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .no-context-menu {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }


      /* LINEé¢¨ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #79a2d1;
      }

      .chat-header {
        background-color: #3d4a5d;
        color: white;
        padding: 15px;
        text-align: center;
      }

      .chat-header h2 {
        margin: 0;
        font-size: 1.2em;
      }

      .chat-box {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .message-row {
        display: flex;
        margin-bottom: 15px;
      }

      .message-row.sent {
        justify-content: flex-end;
      }

      .message-row.received {
        justify-content: flex-start;
      }

      .message {
        max-width: 70%;
        display: flex;
        align-items: flex-end;
      }

      .message-body {
        padding: 10px 15px;
        border-radius: 20px;
        color: #333;
        word-wrap: break-word;
      }

      .sent .message-body {
        background-color: #8de055;
        color: black;
      }

      .received .message-body {
        background-color: #ffffff;
      }

      .message-time {
        font-size: 0.75em;
        color: #999;
        margin: 0 5px;
        white-space: nowrap;
      }

      .message-form-container {
        padding: 10px;
        background-color: #f0f0f0;
        border-top: 1px solid #ddd;
      }

      .message-form {
        display: flex;
        align-items: center;
      }

      .message-form textarea {
        flex-grow: 1;
        border-radius: 20px;
        border: 1px solid #ccc;
        padding: 10px 15px;
        resize: none;
        min-height: 20px;
        max-height: 100px;
        overflow-y: auto;
      }

      .send-button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        margin-left: 10px;
        cursor: pointer;
      }

      .send-button:hover {
        background-color: #45a049;
      }


      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚µã‚¤ãƒ‰ãƒãƒ¼å¼·åˆ¶ã‚¹ã‚¿ã‚¤ãƒ« */
      #sidebar {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        z-index: 50 !important;
        width: 16rem !important;
        height: 100vh !important;
        background-color: #f9fafb !important;
        border-right: 1px solid #d1d5db !important;
        padding: 1rem !important;
        display: flex !important;
        flex-direction: column !important;
        transition: transform 0.3s ease-in-out !important;
        transform: translateX(0) !important;
        overflow-y: auto !important;
      }

      @media (max-width: 767px) {
        #sidebar {
          transform: translateX(-100%) !important;
          box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #sidebar.show-mobile {
          transform: translateX(0) !important;
        }
        #hamburger-btn {
          display: block !important;
        }
        #main-content {
          margin-left: 0 !important;
          padding-left: 1rem !important;
        }
        
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºæ™‚ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #overlay:not(.hidden) + .flex #sidebar {
          transform: translateX(0) !important;
        }
      }

      @media (min-width: 768px) {
        #sidebar {
          transform: translateX(0) !important;
        }
        #hamburger-btn {
          display: none !important;
        }
        #main-content {
          margin-left: 16rem !important;
        }
      }

      #main-content {
        flex: 1;
        padding: 1rem;
        padding-top: 4rem;
        padding-bottom: 6rem; /* ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼åˆ†ã®ãƒãƒ¼ã‚¸ãƒ³ */
        width: 100%;
      }

      @media (min-width: 768px) {
        #main-content {
          padding: 2rem;
          padding-top: 2rem;
          padding-bottom: 2rem; /* PCã§ã¯ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒãªã„ã®ã§é€šå¸¸ãƒãƒ¼ã‚¸ãƒ³ */
        }
      }
      
      /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®æ¥µå°ãƒ†ã‚­ã‚¹ãƒˆ */
      .text-2xs {
        font-size: 0.55rem; /* 8.8px */
        line-height: 0.65rem; /* 10.4px */
        letter-spacing: -0.025em; /* æ–‡å­—é–“ã‚’å°‘ã—è©°ã‚ã‚‹ */
        white-space: nowrap; /* æ”¹è¡Œã‚’é˜²ã */
      }
    </style>
    
    <!-- Stimulus JavaScript -->
    <script type="module">
      import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"
      
      const application = Application.start()
      
      // Image Test Controller
      class ImageTestController extends Controller {
        static targets = ["image"]
        
        connect() {
          console.log("Image Test Controller connected!")
        }

        imageClicked() {
          console.log("Image clicked via test controller!")
          alert("Image click detected!")
        }
      }
      
      // Image Comments Controller  
      class ImageCommentsController extends Controller {
        static targets = ["image", "form", "commentForm", "markersContainer", "toggleButton", "toggleIcon", "toggleText", "markerCount"]
        static values = { postId: Number, readOnly: Boolean }

        connect() {
          console.log("Image Comments Controller connected!")
          console.log("Post ID:", this.postIdValue)
          console.log("Read Only:", this.readOnlyValue)
          console.log("Available targets:", this.targets)
          console.log("Has toggleButton target:", this.hasToggleButtonTarget)
          
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šãŒã‚ã‚Œã°åˆæœŸçŠ¶æ…‹ã¯ãã‚Œã«å¾“ã†ã€èª­ã¿å–ã‚Šå°‚ç”¨ã®å ´åˆ
          if (this.readOnlyValue) {
            this.markersVisible = localStorage.getItem('globalCommentPinsVisible') === 'true'
          } else {
            this.markersVisible = false // è©³ç´°ãƒšãƒ¼ã‚¸ã§ã¯å¾“æ¥é€šã‚Š
          }
          
          // èª­ã¿å–ã‚Šå°‚ç”¨ã§ãªã„å ´åˆã®ã¿ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
          if (!this.readOnlyValue) {
            this.setupImageClickListener()
          }
          
          this.loadExistingComments()
          this.setupResizeListener()
          this.updateToggleButton()
          
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ”ãƒ³åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ï¼ˆã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ‰ã§ï¼‰
          window.addEventListener('globalCommentPinsToggled', this.handleGlobalToggle.bind(this))
        }

        setupResizeListener() {
          // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’å†è¨ˆç®—
          let resizeTimeout
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout)
            resizeTimeout = setTimeout(() => {
              if (this.existingComments) {
                console.log("Recalculating marker positions after resize")
                this.renderComments(this.existingComments)
              }
            }, 150) // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
          })
        }

        setupImageClickListener() {
          console.log("Setting up image click listener...")
          if (!this.hasImageTarget) {
            console.error("Image target not found!")
            return
          }
          
          this.imageTarget.addEventListener("click", (event) => {
            console.log("Image clicked!")
            const rect = this.imageTarget.getBoundingClientRect()
            const x = event.clientX - rect.left
            const y = event.clientY - rect.top
            
            // ç”»åƒã«å¯¾ã™ã‚‹ç›¸å¯¾çš„ãªä½ç½®ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰ã§ä¿å­˜
            const xPercent = (x / rect.width) * 100
            const yPercent = (y / rect.height) * 100
            
            console.log(`Click position: ${x}, ${y} (${xPercent.toFixed(2)}%, ${yPercent.toFixed(2)}%)`)
            
            this.hideForm()
            this.showFormAt(x, y, xPercent, yPercent)
          })
        }

        showFormAt(x, y, xPercent, yPercent) {
          console.log("Showing form at:", x, y, `(${xPercent}%, ${yPercent}%)`)
          if (!this.hasFormTarget) {
            console.error("Form target not found!")
            return
          }
          
          this.formTarget.style.left = x + "px"
          this.formTarget.style.top = y + "px"
          this.formTarget.classList.remove("hidden")
          console.log("Form should be visible now")
          
          // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§ä½ç½®ã‚’ä¿å­˜
          const xField = this.formTarget.querySelector("input[name='comment[x_position]']")
          const yField = this.formTarget.querySelector("input[name='comment[y_position]']")
          
          if (xField) xField.value = xPercent.toFixed(2)
          if (yField) yField.value = yPercent.toFixed(2)
          
          const textarea = this.formTarget.querySelector("textarea")
          if (textarea) {
            textarea.focus()
            textarea.value = ""
          }
        }

        hideForm() {
          if (this.hasFormTarget) {
            this.formTarget.classList.add("hidden")
          }
        }

        async loadExistingComments() {
          console.log("Loading existing comments...")
          
          try {
            const response = await fetch(`/posts/${this.postIdValue}/comments.json`)
            if (response.ok) {
              const comments = await response.json()
              const imageComments = comments.filter(comment => 
                comment.x_position !== null && comment.y_position !== null
              )
              console.log("Loaded image comments:", imageComments)
              this.existingComments = imageComments
              
              // ç”»åƒãŒèª­ã¿è¾¼ã¿å®Œäº†ã—ã¦ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’æç”»
              if (this.hasImageTarget) {
                if (this.imageTarget.complete && this.imageTarget.naturalWidth > 0) {
                  this.renderComments(imageComments)
                } else {
                  this.imageTarget.addEventListener('load', () => {
                    this.renderComments(imageComments)
                  }, { once: true })
                  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                  setTimeout(() => {
                    this.renderComments(imageComments)
                  }, 200)
                }
              }
              
              // èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯åˆæœŸçŠ¶æ…‹ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
              if (this.readOnlyValue && imageComments.length > 0) {
                this.markersVisible = localStorage.getItem('globalCommentPinsVisible') === 'true'
              } else if (imageComments.length > 0) {
                this.markersVisible = true
              }
            } else {
              console.log("Could not load comments via API, using fallback")
              this.loadCommentsFromDOM()
            }
          } catch (error) {
            console.error("Error loading comments:", error)
            this.loadCommentsFromDOM()
          }
        }

        loadCommentsFromDOM() {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: DOMè¦ç´ ã‹ã‚‰èª­ã¿è¾¼ã¿
          const commentElements = document.querySelectorAll('[data-comment-id]')
          const comments = []
          
          commentElements.forEach((element, index) => {
            const commentId = element.dataset.commentId
            const commentText = element.querySelector('p')?.textContent
            
            if (commentText && element.closest('.bg-blue-50')) {
              comments.push({
                id: commentId,
                body: commentText.trim(),
                x_position: 25 + (index * 10), // ä»®ã®ä½ç½®ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰
                y_position: 25 + (index * 5),
                number: index + 1
              })
            }
          })
          
          this.existingComments = comments
          this.renderComments(comments)
          
          // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯åˆæœŸçŠ¶æ…‹ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
          if (comments.length > 0) {
            this.markersVisible = true
          }
        }

        renderComments(comments) {
          if (!this.hasMarkersContainerTarget) {
            console.error("Markers container not found!")
            return
          }
          
          const container = this.markersContainerTarget
          container.innerHTML = "" // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
          
          comments.forEach((comment, index) => {
            this.createMarker(comment, index + 1)
          })
          
          // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
          if (this.hasMarkersContainerTarget) {
            this.markersContainerTarget.style.display = this.markersVisible ? 'block' : 'none'
          }
          this.updateToggleButton()
        }

        createMarker(comment, number) {
          if (!this.hasImageTarget) {
            console.error("Image target not found for marker creation!")
            return
          }
          
          const marker = document.createElement("div")
          marker.className = "absolute w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold cursor-pointer z-10 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-200 hover:scale-110"
          marker.textContent = number
          marker.dataset.commentId = comment.id
          marker.style.pointerEvents = "auto"
          
          // ç”»åƒãŒèª­ã¿è¾¼ã¿å®Œäº†ã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’è¨­å®š
          const positionMarker = () => {
            const imageRect = this.imageTarget.getBoundingClientRect()
            console.log(`Image rect for marker ${number}:`, imageRect.width, 'x', imageRect.height)
            
            // ç”»åƒã‚µã‚¤ã‚ºãŒ0ã®å ´åˆã¯å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
            if (imageRect.width === 0 || imageRect.height === 0) {
              console.log(`Image not ready for marker ${number}, retrying...`)
              setTimeout(positionMarker, 100)
              return
            }
            
            const xPixel = (comment.x_position / 100) * imageRect.width
            const yPixel = (comment.y_position / 100) * imageRect.height
            
            marker.style.left = `${xPixel}px`
            marker.style.top = `${yPixel}px`
            
            console.log(`Marker #${number} positioned at (${xPixel}, ${yPixel}) from (${comment.x_position}%, ${comment.y_position}%)`)
          }
          
          // ç”»åƒãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (this.imageTarget.complete && this.imageTarget.naturalWidth > 0) {
            positionMarker()
          } else {
            // ç”»åƒã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
            this.imageTarget.addEventListener('load', positionMarker, { once: true })
            // æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            setTimeout(positionMarker, 100)
          }
          
          // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä½œæˆ
          const tooltip = document.createElement("div")
          tooltip.className = "absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-gray-800 text-white text-xs rounded py-1 px-2 whitespace-nowrap z-20 opacity-0 transition-opacity duration-200 pointer-events-none"
          tooltip.textContent = comment.body
          tooltip.style.maxWidth = "300px"
          tooltip.style.whiteSpace = "nowrap"
          tooltip.style.overflow = "hidden"
          tooltip.style.textOverflow = "ellipsis"
          
          // ãƒãƒ¼ã‚«ãƒ¼ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¿½åŠ 
          marker.appendChild(tooltip)
          
          // ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
          marker.addEventListener("mouseenter", () => {
            tooltip.style.opacity = "1"
          })
          
          marker.addEventListener("mouseleave", () => {
            tooltip.style.opacity = "0"
          })
          
          // ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã«è¿½åŠ 
          this.markersContainerTarget.appendChild(marker)
          console.log(`Created marker #${number} at (${comment.x_position}, ${comment.y_position})`)
        }

        async submitComment(event) {
          event.preventDefault()
          console.log("Submitting comment...")
          
          const form = event.target
          const formData = new FormData(form)
          
          try {
            const response = await fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
              }
            })
            
            if (response.ok) {
              const comment = await response.json()
              console.log("Comment submitted successfully:", comment)
              
              // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
              const currentMarkersCount = this.markersContainerTarget.children.length
              this.createMarker(comment, currentMarkersCount + 1)
              
              // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºçŠ¶æ…‹ã«åˆ‡ã‚Šæ›¿ãˆ
              this.markersVisible = true
              if (this.hasMarkersContainerTarget) {
                this.markersContainerTarget.style.display = 'block'
              }
              this.updateToggleButton()
              
              // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«ã™ã‚‹
              this.hideForm()
              
              // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
              this.showSuccessMessage()
              
              // 1ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚‚æ›´æ–°
              setTimeout(() => {
                window.location.reload()
              }, 1000)
            } else {
              const errorData = await response.json()
              console.error('Comment submission failed:', errorData)
              alert('ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚')
            }
          } catch (error) {
            console.error('Error submitting comment:', error)
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚')
          }
        }

        showSuccessMessage() {
          const message = document.createElement('div')
          message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50'
          message.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼'
          document.body.appendChild(message)
          
          setTimeout(() => {
            message.remove()
          }, 3000)
        }

        toggleMarkers() {
          console.log("Toggling markers visibility")
          console.log("Current state:", this.markersVisible)
          console.log("Has markers container:", this.hasMarkersContainerTarget)
          
          this.markersVisible = !this.markersVisible
          console.log("New state:", this.markersVisible)
          
          if (this.hasMarkersContainerTarget) {
            const container = this.markersContainerTarget
            console.log("Container children count:", container.children.length)
            container.style.display = this.markersVisible ? 'block' : 'none'
            console.log("Container display set to:", container.style.display)
          }
          
          this.updateToggleButton()
          
          // è©³ç´°ãƒšãƒ¼ã‚¸ã§å€‹åˆ¥ãƒˆã‚°ãƒ«ã‚’æ“ä½œã—ãŸå ´åˆã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚‚æ›´æ–°
          if (!this.readOnlyValue) {
            localStorage.setItem('globalCommentPinsVisible', this.markersVisible)
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«ã‚‚é€šçŸ¥
            const globalController = document.querySelector('[data-controller*="global-comment-pins"]')
            if (globalController) {
              const controller = this.application.getControllerForElementAndIdentifier(globalController, 'global-comment-pins')
              if (controller) {
                controller.syncFromIndividual(this.markersVisible)
              }
            }
          }
        }

        updateToggleButton() {
          if (!this.hasToggleButtonTarget) return
          
          const button = this.toggleButtonTarget
          const icon = this.hasToggleIconTarget ? this.toggleIconTarget : null
          const text = this.hasToggleTextTarget ? this.toggleTextTarget : null
          const count = this.hasMarkerCountTarget ? this.markerCountTarget : null
          
          if (this.markersVisible) {
            // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºä¸­ã®çŠ¶æ…‹
            button.classList.remove('border-gray-300', 'hover:bg-gray-50')
            button.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700')
            if (icon) icon.textContent = 'ğŸ™ˆ'
            if (text) text.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆãƒ”ãƒ³ã‚’éè¡¨ç¤º'
          } else {
            // ãƒãƒ¼ã‚«ãƒ¼éè¡¨ç¤ºä¸­ã®çŠ¶æ…‹
            button.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700')
            button.classList.add('border-gray-300', 'hover:bg-gray-50')
            if (icon) icon.textContent = 'ğŸ‘ï¸'
            if (text) text.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆãƒ”ãƒ³ã‚’è¡¨ç¤º'
          }
          
          // ãƒãƒ¼ã‚«ãƒ¼æ•°ã‚’è¡¨ç¤º
          if (count && this.hasMarkersContainerTarget) {
            const markerCount = this.markersContainerTarget.children.length
            if (markerCount > 0) {
              count.textContent = `(${markerCount}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆ)`
            } else {
              count.textContent = ''
            }
          }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ”ãƒ³åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        handleGlobalToggle(event) {
          console.log("Global toggle received:", event.detail.visible, "ReadOnly:", this.readOnlyValue)
          this.markersVisible = event.detail.visible
          if (this.hasMarkersContainerTarget) {
            this.markersContainerTarget.style.display = this.markersVisible ? 'block' : 'none'
          }
          this.updateToggleButton()
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
        setGlobalMarkersVisibility(visible) {
          console.log("Setting global visibility:", visible, "ReadOnly:", this.readOnlyValue)
          this.markersVisible = visible
          if (this.hasMarkersContainerTarget) {
            this.markersContainerTarget.style.display = this.markersVisible ? 'block' : 'none'
          }
          this.updateToggleButton()
        }

        disconnect() {
          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ‰ã§ï¼‰
          window.removeEventListener('globalCommentPinsToggled', this.handleGlobalToggle.bind(this))
        }
      }

      // Global Comment Pins Controller
      class GlobalCommentPinsController extends Controller {
        static targets = ["toggleButton", "toggleIcon", "toggleText"]

        connect() {
          console.log("Global Comment Pins Controller connected!")
          this.globalPinsVisible = localStorage.getItem('globalCommentPinsVisible') === 'true'
          this.updateButtonState()
          this.updateAllPins()
        }

        toggleGlobalPins() {
          console.log("Toggling global comment pins")
          this.globalPinsVisible = !this.globalPinsVisible
          localStorage.setItem('globalCommentPinsVisible', this.globalPinsVisible)
          
          this.updateButtonState()
          this.updateAllPins()
          
          // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦ä»–ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«é€šçŸ¥
          window.dispatchEvent(new CustomEvent('globalCommentPinsToggled', {
            detail: { visible: this.globalPinsVisible }
          }))
        }

        updateButtonState() {
          this.updateAllButtons()
        }
        
        updateAllButtons() {
          // ã™ã¹ã¦ã®global-comment-pinsã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
          const allElements = document.querySelectorAll('[data-controller*="global-comment-pins"]')
          allElements.forEach(element => {
            this.updateButton(element)
          })
        }
        
        updateButton(element) {
          const button = element.querySelector('[data-global-comment-pins-target="toggleButton"]')
          const icon = element.querySelector('[data-global-comment-pins-target="toggleIcon"]')
          const text = element.querySelector('[data-global-comment-pins-target="toggleText"]')

          if (!button) return

          if (this.globalPinsVisible) {
            // ONçŠ¶æ…‹: ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ã¯ã»ã¼ç™½ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³ã¯é’
            if (element.closest('.md\\:hidden')) {
              // ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ï¼ˆä¸¸ã„ãƒœã‚¿ãƒ³ï¼‰
              button.classList.remove('bg-emerald-300', 'hover:bg-emerald-400', 'text-white')
              button.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-600')
              if (icon) icon.textContent = 'ğŸ“'
            } else {
              // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³
              button.classList.remove('border-gray-300', 'hover:bg-gray-50')
              button.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700')
              if (icon) icon.textContent = 'ğŸ™ˆ'
              if (text) text.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆãƒ”ãƒ³ä¸€æ‹¬éè¡¨ç¤º'
            }
          } else {
            // OFFçŠ¶æ…‹
            if (element.closest('.md\\:hidden')) {
              // ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ï¼ˆä¸¸ã„ãƒœã‚¿ãƒ³ï¼‰
              button.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-600')
              button.classList.add('bg-emerald-300', 'hover:bg-emerald-400', 'text-white')
              if (icon) icon.textContent = 'ğŸ“'
            } else {
              // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³
              button.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700')
              button.classList.add('border-gray-300', 'hover:bg-gray-50')
              if (icon) icon.textContent = 'ğŸ‘ï¸'
              if (text) text.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆãƒ”ãƒ³ä¸€æ‹¬è¡¨ç¤º'
            }
          }
        }

        updateAllPins() {
          // ã™ã¹ã¦ã®image-commentsã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒãƒ¼ã‚«ãƒ¼ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
          const imageCommentsElements = document.querySelectorAll('[data-controller*="image-comments"]')
          imageCommentsElements.forEach(element => {
            const controller = this.application.getControllerForElementAndIdentifier(element, 'image-comments')
            if (controller) {
              controller.setGlobalMarkersVisibility(this.globalPinsVisible)
            }
          })
        }

        // å€‹åˆ¥ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰ã®åŒæœŸ
        syncFromIndividual(visible) {
          this.globalPinsVisible = visible
          this.updateAllButtons()
        }
      }
      
      // AI Comment Assistant Controller
      class AiCommentAssistantController extends Controller {
        static targets = [
          "toggleButton", "assistantContent", "loading", "results", "error",
          "commentExamples", "observationPoints", "observationToggle", "observationIcon"
        ]
        static values = { postId: Number }

        connect() {
          console.log("AI Comment Assistant Controller connected!")
          console.log("Post ID:", this.postIdValue)
        }

        async toggleAssistant() {
          const isHidden = this.assistantContentTarget.classList.contains('hidden')
          
          if (isHidden) {
            // è£œåŠ©æ©Ÿèƒ½ã‚’é–‹å§‹
            this.assistantContentTarget.classList.remove('hidden')
            this.toggleButtonTarget.textContent = 'è£œåŠ©ã‚’é–‰ã˜ã‚‹'
            this.toggleButtonTarget.classList.remove('bg-blue-600', 'hover:bg-blue-700')
            this.toggleButtonTarget.classList.add('bg-gray-500', 'hover:bg-gray-600')
            
            // æ—¢ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (!this.resultsTarget.classList.contains('hidden')) {
              return
            }
            
            // AIåˆ†æã‚’é–‹å§‹
            await this.analyzePost()
          } else {
            // è£œåŠ©æ©Ÿèƒ½ã‚’é–‰ã˜ã‚‹
            this.assistantContentTarget.classList.add('hidden')
            this.toggleButtonTarget.textContent = 'è£œåŠ©ã‚’é–‹å§‹'
            this.toggleButtonTarget.classList.remove('bg-gray-500', 'hover:bg-gray-600')
            this.toggleButtonTarget.classList.add('bg-blue-600', 'hover:bg-blue-700')
          }
        }

        async analyzePost() {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
          this.showLoading()
          
          try {
            const response = await fetch(`/posts/${this.postIdValue}/ai_comment_assistant/analyze`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
              }
            })
            
            const data = await response.json()
            
            if (data.success) {
              this.displayResults(data.comment_examples, data.observation_points)
            } else {
              this.showError(data.error || 'AIåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚')
            }
          } catch (error) {
            console.error('AI Comment Assistant Error:', error)
            this.showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
          }
        }

        showLoading() {
          this.hideAllStates()
          this.loadingTarget.classList.remove('hidden')
        }

        displayResults(commentExamples, observationPoints) {
          this.hideAllStates()
          
          // ã‚³ãƒ¡ãƒ³ãƒˆä¾‹ã‚’è¡¨ç¤º
          this.renderCommentExamples(commentExamples)
          
          // è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
          this.renderObservationPoints(observationPoints)
          
          this.resultsTarget.classList.remove('hidden')
        }

        showError(message) {
          this.hideAllStates()
          this.errorTarget.textContent = message
          this.errorTarget.classList.remove('hidden')
        }

        hideAllStates() {
          this.loadingTarget.classList.add('hidden')
          this.resultsTarget.classList.add('hidden')
          this.errorTarget.classList.add('hidden')
        }

        renderCommentExamples(examples) {
          this.commentExamplesTarget.innerHTML = ''
          
          examples.forEach((example, index) => {
            const exampleDiv = document.createElement('div')
            exampleDiv.className = 'p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer'
            exampleDiv.innerHTML = `
              <div class="flex items-start gap-3">
                <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-semibold">${index + 1}</span>
                <div class="flex-1">
                  <p class="text-gray-800 leading-relaxed">${this.escapeHtml(example)}</p>
                  <div class="mt-2 flex gap-2">
                    <button type="button" 
                            class="text-xs text-blue-600 hover:text-blue-800 font-medium"
                            data-action="click->ai-comment-assistant#useComment"
                            data-comment="${this.escapeHtml(example)}">
                      ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨
                    </button>
                    <button type="button" 
                            class="text-xs text-gray-500 hover:text-gray-700 font-medium"
                            data-action="click->ai-comment-assistant#editComment"
                            data-comment="${this.escapeHtml(example)}">
                      ç·¨é›†ã—ã¦ä½¿ç”¨
                    </button>
                  </div>
                </div>
              </div>
            `
            this.commentExamplesTarget.appendChild(exampleDiv)
          })
        }

        renderObservationPoints(points) {
          this.observationPointsTarget.innerHTML = ''
          
          const pointsList = document.createElement('ul')
          pointsList.className = 'space-y-2'
          
          points.forEach(point => {
            const li = document.createElement('li')
            li.className = 'flex items-start gap-2 text-gray-700'
            li.innerHTML = `
              <span class="flex-shrink-0 w-2 h-2 bg-blue-400 rounded-full mt-2"></span>
              <span>${this.escapeHtml(point)}</span>
            `
            pointsList.appendChild(li)
          })
          
          this.observationPointsTarget.appendChild(pointsList)
        }

        toggleObservationPoints() {
          const isHidden = this.observationPointsTarget.classList.contains('hidden')
          
          if (isHidden) {
            this.observationPointsTarget.classList.remove('hidden')
            this.observationIconTarget.textContent = 'â–²'
          } else {
            this.observationPointsTarget.classList.add('hidden')
            this.observationIconTarget.textContent = 'â–¼'
          }
        }

        useComment(event) {
          const comment = event.currentTarget.dataset.comment
          this.insertCommentIntoForm(comment)
        }

        editComment(event) {
          const comment = event.currentTarget.dataset.comment
          this.insertCommentIntoForm(comment)
          
          // ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
          const commentTextArea = document.querySelector('textarea[name="comment[body]"]')
          if (commentTextArea) {
            commentTextArea.focus()
            // ãƒ†ã‚­ã‚¹ãƒˆã®æœ€å¾Œã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç§»å‹•
            commentTextArea.setSelectionRange(commentTextArea.value.length, commentTextArea.value.length)
          }
        }

        insertCommentIntoForm(comment) {
          const commentTextArea = document.querySelector('textarea[name="comment[body]"]')
          if (commentTextArea) {
            commentTextArea.value = comment
            
            // é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ï¼ˆã‚‚ã—auto-resizeãŒã‚ã‚‹å ´åˆï¼‰
            commentTextArea.dispatchEvent(new Event('input', { bubbles: true }))
            
            // æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            this.showSuccessMessage('ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«æŒ¿å…¥ã—ã¾ã—ãŸ')
          } else {
            console.error('Comment textarea not found')
            alert('ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
          }
        }

        showSuccessMessage(message) {
          const successDiv = document.createElement('div')
          successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-0 opacity-100 transition-all duration-300'
          successDiv.textContent = message
          
          document.body.appendChild(successDiv)
          
          // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          setTimeout(() => {
            successDiv.classList.add('translate-x-full', 'opacity-0')
            setTimeout(() => {
              if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv)
              }
            }, 300)
          }, 3000)
        }

        escapeHtml(text) {
          const div = document.createElement('div')
          div.textContent = text
          return div.innerHTML
        }
      }
      
      // Compact Comments Controller
      class CompactCommentsController extends Controller {
        static targets = ["toggleButton", "toggleIcon", "commentsList"]

        connect() {
          console.log("Compact Comments Controller connected!")
          this.isExpanded = false
        }

        toggleComments() {
          this.isExpanded = !this.isExpanded
          
          if (this.isExpanded) {
            // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
            this.commentsListTarget.classList.remove('hidden')
            this.toggleIconTarget.textContent = 'â–²'
          } else {
            // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’éè¡¨ç¤º
            this.commentsListTarget.classList.add('hidden')
            this.toggleIconTarget.textContent = 'â–¼'
          }
        }

        // ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚³ãƒ¡ãƒ³ãƒˆãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        highlightComment(event) {
          const commentElement = event.currentTarget
          const commentId = commentElement.dataset.commentId
          
          // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
          document.querySelectorAll('.compact-comment-highlight').forEach(el => {
            el.classList.remove('compact-comment-highlight')
          })
          
          // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          commentElement.classList.add('compact-comment-highlight')
          
          // å¯¾å¿œã™ã‚‹ãƒ”ãƒ³ãŒã‚ã‚Œã°ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆæ—¢å­˜ã®æ©Ÿèƒ½ã‚’æ´»ç”¨ï¼‰
          if (commentId) {
            const imageController = document.querySelector('[data-controller*="image-comments"]')
            if (imageController) {
              const event = new CustomEvent('highlightMarker', {
                detail: { commentId: commentId }
              })
              imageController.dispatchEvent(event)
            }
          }
          
          // 2ç§’å¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
          setTimeout(() => {
            commentElement.classList.remove('compact-comment-highlight')
          }, 2000)
        }
      }
      
      // AI Sidebar Controller (updated)
      class AiSidebarController extends Controller {
        static targets = [
          "toggleButton", "toggleIcon", "toggleText", 
          "initialMessage", "loading", "aiContent",
          "vocabularies", "summary"
        ]
        static values = { postId: Number }

        connect() {
          console.log("AI Sidebar Controller connected!")
          this.aiLoaded = false
        }

        toggleAI() {
          const isAIVisible = !this.aiContentTarget.classList.contains('hidden')
          
          if (isAIVisible) {
            // AIæ©Ÿèƒ½ã‚’é–‰ã˜ã‚‹
            this.closeAI()
          } else {
            // AIæ©Ÿèƒ½ã‚’é–‹å§‹
            this.startAI()
          }
        }

        async startAI() {
          // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
          this.initialMessageTarget.classList.add('hidden')
          
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
          this.loadingTarget.classList.remove('hidden')
          
          // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          this.toggleIconTarget.textContent = 'â³'
          this.toggleTextTarget.textContent = 'AIåˆ†æä¸­...'
          this.toggleButtonTarget.disabled = true

          try {
            if (!this.aiLoaded) {
              // AIæ©Ÿèƒ½ã‚’åˆå›ã®ã¿èª­ã¿è¾¼ã¿
              await this.loadAIContent()
              this.aiLoaded = true
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            this.loadingTarget.classList.add('hidden')
            this.aiContentTarget.classList.remove('hidden')
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            this.toggleIconTarget.textContent = 'âœ–ï¸'
            this.toggleTextTarget.textContent = 'AIè£œåŠ©ã‚’é–‰ã˜ã‚‹'
            this.toggleButtonTarget.classList.remove('bg-purple-600', 'hover:bg-purple-700')
            this.toggleButtonTarget.classList.add('bg-gray-600', 'hover:bg-gray-700')
            
          } catch (error) {
            console.error('AI loading error:', error)
            this.showError(error.message)
          } finally {
            this.toggleButtonTarget.disabled = false
          }
        }

        closeAI() {
          // ã™ã¹ã¦ã®AIé–¢é€£è¦ç´ ã‚’éš ã™
          this.loadingTarget.classList.add('hidden')
          this.aiContentTarget.classList.add('hidden')
          
          // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          this.initialMessageTarget.classList.remove('hidden')
          
          // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          this.toggleIconTarget.textContent = 'ğŸ¤–'
          this.toggleTextTarget.textContent = 'AIè£œåŠ©ã‚’é–‹å§‹'
          this.toggleButtonTarget.classList.remove('bg-gray-600', 'hover:bg-gray-700')
          this.toggleButtonTarget.classList.add('bg-purple-600', 'hover:bg-purple-700')
        }

        async loadAIContent() {
          try {
            console.log('Starting AI analysis for post:', this.postIdValue)
            
            const response = await fetch(`/posts/${this.postIdValue}/ai_comment_assistant/analyze`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
              },
              body: JSON.stringify({})
            })

            console.log('Response status:', response.status)

            if (!response.ok) {
              const errorText = await response.text()
              console.error('API error response:', errorText)
              throw new Error(`AI API ã‚¨ãƒ©ãƒ¼ (${response.status}): ${errorText}`)
            }

            const data = await response.json()
            console.log('AI analysis result:', data)
            
            if (!data.success) {
              throw new Error(data.error || 'AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ')
            }
            
            // èªå½™ãƒ»è¡¨ç¾ã‚’è¡¨ç¤º
            this.renderVocabularies(data.vocabularies || [])
            
            // è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
            if (this.hasSummaryTarget) {
              this.summaryTarget.innerHTML = ''
              data.observation_points.slice(0, 4).forEach((point, index) => {
                const pointDiv = document.createElement('div')
                pointDiv.className = 'flex items-start gap-3 p-3 bg-white rounded-lg border border-purple-200 shadow-sm'
                pointDiv.innerHTML = `
                  <div class="w-6 h-6 bg-gradient-to-r from-purple-400 to-indigo-400 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span class="text-white text-xs font-bold">${index + 1}</span>
                  </div>
                  <p class="text-sm text-gray-700 leading-relaxed font-medium">${point}</p>
                `
                this.summaryTarget.appendChild(pointDiv)
              })
            }
            console.log('AI content rendered successfully')
          } catch (error) {
            console.error('Error loading AI content:', error)
            this.showError(error.message)
          }
        }

        renderVocabularies(vocabularies) {
          if (this.hasVocabulariesTarget) {
            this.vocabulariesTarget.innerHTML = ''
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èªå½™ãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            const vocabsToShow = vocabularies.length > 0 ? vocabularies.slice(0, 8) : [
              'ç¾ã—ã„', 'å°è±¡çš„', 'ç¹Šç´°', 'åŠ›å¼·ã„', 
              'èª¿å’Œ', 'è¡¨ç¾åŠ›', 'å‰µé€ æ€§', 'ç‹¬å‰µçš„'
            ]
            
            vocabsToShow.forEach(vocab => {
              const vocabButton = document.createElement('button')
              vocabButton.type = 'button' // typeã‚’æ˜ç¤ºçš„ã«è¨­å®š
              vocabButton.className = 'px-3 py-2 bg-white border-2 border-emerald-300 rounded-full text-sm font-medium text-emerald-700 hover:bg-emerald-50 hover:border-emerald-400 transition-all transform hover:scale-105 cursor-pointer'
              vocabButton.textContent = vocab
              
              // ã‚ˆã‚Šç¢ºå®Ÿãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
              vocabButton.addEventListener('click', (e) => {
                e.preventDefault()
                e.stopPropagation()
                console.log('Vocabulary button clicked:', vocab)
                this.insertVocabulary(vocab)
              })
              
              this.vocabulariesTarget.appendChild(vocabButton)
            })
            
            console.log('Rendered vocabularies:', vocabsToShow.length)
          } else {
            console.error('Vocabularies target not found!')
          }
        }

        insertVocabulary(vocabulary) {
          console.log('insertVocabulary called with:', vocabulary)
          
          // ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å„ªå…ˆã—ã¦æ¤œç´¢
          let commentForm = document.querySelector('textarea[data-comment-form-target="textarea"]')
          console.log('Found main comment form:', commentForm)
          
          if (!commentForm) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚ˆã‚Šå¤§ããªtextareaã‚’æ¢ã™
            const allTextareas = document.querySelectorAll('textarea[name="comment[body]"]')
            console.log('All comment textareas:', allTextareas)
            
            // æœ€ã‚‚å¤§ããªtextareaï¼ˆrowså±æ€§ã‚„classã§åˆ¤å®šï¼‰ã‚’é¸æŠ
            let mainTextarea = null
            let maxSize = 0
            
            allTextareas.forEach(textarea => {
              const rows = parseInt(textarea.getAttribute('rows') || '1')
              const isMainForm = textarea.classList.contains('w-full') || textarea.getAttribute('data-comment-form-target')
              const size = isMainForm ? rows + 100 : rows // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é‡ã¿ä»˜ã‘
              
              console.log('Textarea analysis:', {
                element: textarea,
                rows: rows,
                isMainForm: isMainForm,
                calculatedSize: size,
                classes: textarea.className
              })
              
              if (size > maxSize) {
                maxSize = size
                mainTextarea = textarea
              }
            })
            
            commentForm = mainTextarea
            console.log('Selected textarea:', commentForm, 'with size:', maxSize)
          }
          
          if (commentForm) {
            const currentText = commentForm.value
            const cursorPos = commentForm.selectionStart || currentText.length
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«èªå½™ã‚’æŒ¿å…¥
            const newText = currentText.slice(0, cursorPos) + vocabulary + currentText.slice(cursorPos)
            commentForm.value = newText
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
            const newCursorPos = cursorPos + vocabulary.length
            commentForm.setSelectionRange(newCursorPos, newCursorPos)
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
            commentForm.focus()
            
            // inputã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦Stimulusã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«é€šçŸ¥
            commentForm.dispatchEvent(new Event('input', { bubbles: true }))
            commentForm.dispatchEvent(new Event('change', { bubbles: true }))
            
            // æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            this.showInsertionFeedback(vocabulary)
            console.log('Successfully inserted vocabulary into:', commentForm.className)
          } else {
            console.error('Comment form not found!')
            // ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            this.showInsertionFeedback('ã‚¨ãƒ©ãƒ¼ï¼šãƒ¡ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
          }
        }

        showInsertionFeedback(vocabulary) {
          const feedback = document.createElement('div')
          feedback.className = 'fixed top-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform scale-100 opacity-100 transition-all'
          feedback.textContent = `ã€Œ${vocabulary}ã€ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ`
          document.body.appendChild(feedback)
          
          setTimeout(() => {
            feedback.classList.add('scale-95', 'opacity-0')
            setTimeout(() => feedback.remove(), 200)
          }, 2000)
        }

        showError(message = 'AIåˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã™
          this.loadingTarget.classList.add('hidden')
          
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          this.aiContentTarget.classList.remove('hidden')
          this.aiContentTarget.innerHTML = `
            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
              <div class="flex items-center gap-2 mb-2">
                <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                  <span class="text-white text-xs">âš ï¸</span>
                </div>
                <h3 class="text-sm font-bold text-red-800">ã‚¨ãƒ©ãƒ¼</h3>
              </div>
              <p class="text-sm text-red-700 mb-3">${message}</p>
              <button 
                type="button" 
                data-action="click->ai-sidebar#retryAI"
                class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">
                å†è©¦è¡Œ
              </button>
            </div>
          `
          
          // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          this.toggleIconTarget.textContent = 'âš ï¸'
          this.toggleTextTarget.textContent = 'ã‚¨ãƒ©ãƒ¼ - å†è©¦è¡Œ'
          this.toggleButtonTarget.classList.remove('bg-purple-600', 'hover:bg-purple-700')
          this.toggleButtonTarget.classList.add('bg-red-600', 'hover:bg-red-700')
        }

        retryAI() {
          // AIã‚’å†è©¦è¡Œ
          this.aiLoaded = false
          this.startAI()
        }


        insertCommentIntoForm(comment) {
          // ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æ¤œç´¢
          let commentForm = document.querySelector('textarea[data-comment-form-target="textarea"]')
          
          if (!commentForm) {
            const allTextareas = document.querySelectorAll('textarea[name="comment[body]"]')
            let mainTextarea = null
            let maxSize = 0
            
            allTextareas.forEach(textarea => {
              const rows = parseInt(textarea.getAttribute('rows') || '1')
              const isMainForm = textarea.classList.contains('w-full') || textarea.getAttribute('data-comment-form-target')
              const size = isMainForm ? rows + 100 : rows
              
              if (size > maxSize) {
                maxSize = size
                mainTextarea = textarea
              }
            })
            
            commentForm = mainTextarea
          }
          
          if (commentForm) {
            commentForm.value = comment
            commentForm.focus()
            commentForm.dispatchEvent(new Event('input', { bubbles: true }))
            commentForm.dispatchEvent(new Event('change', { bubbles: true }))
          }
        }
      }

      // Vote Controller (AJAX)
      class VoteController extends Controller {
        static targets = ["barPos", "barNeg", "barLabel", "barWrapper", "up", "down"]
        static values = { votableType: String, votableId: Number, upCount: Number, downCount: Number, userVote: Number }

        connect() {
          this.updateBar()
          this.updateActive()
        }

        upvote() { this.submit(1) }
        downvote() { this.submit(-1) }

        async submit(value) {
          try {
            const params = new URLSearchParams({
              votable_type: this.votableTypeValue,
              votable_id: String(this.votableIdValue),
              value: String(value)
            })
            const response = await fetch(`/vote?${params.toString()}`, {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
              }
            })

            if (!response.ok) {
              console.error('Vote failed with status', response.status)
              return
            }
            const data = await response.json()
            if (response.status === 403 && data && data.user_vote) {
              // æ—¢ã«æŠ•ç¥¨æ¸ˆã¿: ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã§åæ˜ 
              this.userVoteValue = data.user_vote
            } else if (data && data.success) {
              // æ–°è¦æŠ•ç¥¨æˆåŠŸ
              this.userVoteValue = data.user_vote
              this.upCountValue = data.up_count
              this.downCountValue = data.down_count
            }
            this.updateBar()
            this.updateActive()
          } catch (e) {
            console.error('Vote error', e)
          }
        }

        
        updateBar() {
          const up = this.upCountValue || 0
          const down = this.downCountValue || 0
          const total = up + down
          const hasVoted = (this.userVoteValue || 0) !== 0

          if (hasVoted) {
            // è‰²åˆ†ã‘è¡¨ç¤º + çµ¶å¯¾å€¤ã®å†…è¨³ãƒ©ãƒ™ãƒ«
            let upPct = 0, downPct = 0
            if (total > 0) {
              upPct = Math.round((up / total) * 100)
              downPct = 100 - upPct
            }
            if (this.hasBarPosTarget) this.barPosTarget.style.width = upPct + '%'
            if (this.hasBarNegTarget) this.barNegTarget.style.width = downPct + '%'
            if (this.hasBarLabelTarget) this.barLabelTarget.textContent = `è³›æˆ ${up} / åå¯¾ ${down}`
          } else {
            // æœªæŠ•ç¥¨: ã‚°ãƒ¬ãƒ¼ãƒãƒ¼ã®ã¿ + åˆè¨ˆãƒ©ãƒ™ãƒ«ã€è‰²ã®å¹…ã¯0
            if (this.hasBarPosTarget) this.barPosTarget.style.width = '0%'
            if (this.hasBarNegTarget) this.barNegTarget.style.width = '0%'
            if (this.hasBarLabelTarget) this.barLabelTarget.textContent = `|${total}|`
          }
        }

        updateActive() {
          const voted = (this.userVoteValue || 0)
          const disableButtons = () => {
            ;[this.upTarget, this.downTarget].forEach(btn => {
              if (!btn) return
              btn.disabled = true
              btn.classList.add('opacity-50', 'cursor-not-allowed')
            })
          }
          // Reset
          if (this.hasUpTarget) this.upTarget.classList.remove('text-green-600')
          if (this.hasDownTarget) this.downTarget.classList.remove('text-red-600')

          if (voted === 1) {
            if (this.hasUpTarget) this.upTarget.classList.add('text-green-600')
            disableButtons()
          } else if (voted === -1) {
            if (this.hasDownTarget) this.downTarget.classList.add('text-red-600')
            disableButtons()
          }
        }
      }

      // Profile Wizard Controller
      class ProfileWizardController extends Controller {
        static targets = ["step", "progressBar", "stepIndicator", "prevButton", "nextButton", "submitButton"]
        static values = { totalSteps: Number }
        
        connect() {
          console.log("Profile Wizard Controller connected!")
          this.currentStep = 1
          this.updateUI()
          setTimeout(() => this.initializeSelections(), 100)
        }

        nextStep() {
          if (this.currentStep < this.totalStepsValue) {
            this.currentStep += 1
            this.updateUI()
            this.scrollToTop()
          }
        }

        previousStep() {
          if (this.currentStep > 1) {
            this.currentStep -= 1
            this.updateUI()
            this.scrollToTop()
          }
        }

        selectOption(event) {
          const card = event.currentTarget
          const checkbox = card.querySelector('input[type="checkbox"]')
          
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
          checkbox.checked = !checkbox.checked
          
          // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          this.updateCardAppearance(card, checkbox.checked)
        }

        selectSingle(event) {
          const card = event.currentTarget
          const radio = card.querySelector('input[type="radio"]')
          const fieldName = radio.name
          
          // åŒã˜åå‰ã®ä»–ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
          document.querySelectorAll(`input[name="${fieldName}"]`).forEach(input => {
            const inputCard = input.closest('.option-card')
            this.updateCardAppearance(inputCard, false)
            input.checked = false
          })
          
          // é¸æŠã•ã‚ŒãŸãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          radio.checked = true
          this.updateCardAppearance(card, true)
        }

        updateCardAppearance(card, isSelected) {
          const cardDiv = card.querySelector('div')
          
          if (isSelected) {
            cardDiv.classList.remove('border-gray-200', 'bg-white', 'text-gray-700')
            cardDiv.classList.add('border-blue-600', 'bg-blue-200', 'text-blue-900')
            cardDiv.style.borderWidth = '4px'
            cardDiv.style.boxShadow = '0 0 0 4px rgba(37, 99, 235, 0.4), 0 4px 12px rgba(37, 99, 235, 0.3)'
            cardDiv.style.transform = 'scale(1.02)'
          } else {
            cardDiv.classList.remove('border-blue-600', 'bg-blue-200', 'text-blue-900')
            cardDiv.classList.add('border-gray-200', 'bg-white', 'text-gray-700')
            cardDiv.style.borderWidth = '2px'
            cardDiv.style.boxShadow = 'none'
            cardDiv.style.transform = 'scale(1.0)'
          }
        }

        updateUI() {
          // ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤º/éè¡¨ç¤º
          this.stepTargets.forEach((step, index) => {
            const stepNumber = parseInt(step.dataset.step)
            if (stepNumber === this.currentStep) {
              step.classList.remove('hidden')
              step.classList.add('animate-fade-in')
            } else {
              step.classList.add('hidden')
              step.classList.remove('animate-fade-in')
            }
          })

          // é€²æ—ãƒãƒ¼ã®æ›´æ–°
          const progress = (this.currentStep / this.totalStepsValue) * 100
          this.progressBarTarget.style.width = `${progress}%`

          // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°
          this.stepIndicatorTarget.textContent = `${this.currentStep} / ${this.totalStepsValue}`

          // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
          if (this.currentStep === 1) {
            this.prevButtonTarget.classList.add('hidden')
          } else {
            this.prevButtonTarget.classList.remove('hidden')
          }

          if (this.currentStep === this.totalStepsValue) {
            this.nextButtonTarget.classList.add('hidden')
            this.submitButtonTarget.classList.remove('hidden')
          } else {
            this.nextButtonTarget.classList.remove('hidden')
            this.submitButtonTarget.classList.add('hidden')
          }
        }

        scrollToTop() {
          window.scrollTo({ top: 0, behavior: 'smooth' })
        }

        // åˆæœŸåŒ–æ™‚ã«æ—¢å­˜ã®é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
        initializeSelections() {
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸçŠ¶æ…‹ã‚’åæ˜ 
          document.querySelectorAll('.option-card input[type="checkbox"]:checked').forEach(checkbox => {
            const card = checkbox.closest('.option-card')
            this.updateCardAppearance(card, true)
          })

          // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’åæ˜ 
          document.querySelectorAll('.option-card input[type="radio"]:checked').forEach(radio => {
            const card = radio.closest('.option-card')
            this.updateCardAppearance(card, true)
          })
        }
      }

      // File Preview Controller
      class FilePreviewController extends Controller {
        static targets = ["imageInput", "videoInput", "audioInput", "mediaPreview"]

        connect() {
          console.log("File Preview Controller connected!")
          console.log("Media preview target:", this.hasMediaPreviewTarget)
        }

        previewFiles(event) {
          console.log("previewFiles called with event:", event)
          const files = event.target.files
          console.log("Selected files:", files)
          
          if (files.length === 0) {
            console.log("No files selected")
            return
          }

          // å„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
          Array.from(files).forEach((file, index) => {
            console.log(`Processing file ${index + 1}:`, file.name, file.type)
            if (file.type.startsWith('image/')) {
              console.log("Creating image preview for:", file.name)
              this.createImagePreview(file, index, this.mediaPreviewTarget)
            } else if (file.type.startsWith('video/')) {
              console.log("Creating video preview for:", file.name)
              this.createVideoPreview(file, index, this.mediaPreviewTarget)
            } else if (file.type.startsWith('audio/')) {
              console.log("Creating audio preview for:", file.name)
              this.createAudioPreview(file, index, this.mediaPreviewTarget)
            }
          })
        }

        createImagePreview(file, index, container) {
          const reader = new FileReader()
          
          reader.onload = (e) => {
            const previewDiv = document.createElement('div')
            previewDiv.className = 'relative mb-6'
            
            const img = document.createElement('img')
            img.src = e.target.result
            img.className = 'w-full max-w-lg h-auto rounded-lg shadow-lg'
            img.alt = `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ${index + 1}`
            
            const removeBtn = document.createElement('button')
            removeBtn.type = 'button'
            removeBtn.className = 'absolute top-2 left-20 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg hover:bg-red-600 shadow-lg'
            removeBtn.innerHTML = 'Ã—'
            removeBtn.onclick = () => previewDiv.remove()
            
            const fileName = document.createElement('p')
            fileName.textContent = file.name
            fileName.className = 'text-sm text-gray-700 mt-3 font-medium'
            
            const fileSize = document.createElement('p')
            fileSize.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)} MB`
            fileSize.className = 'text-xs text-gray-500'
            
            previewDiv.appendChild(img)
            previewDiv.appendChild(removeBtn)
            previewDiv.appendChild(fileName)
            previewDiv.appendChild(fileSize)
            container.appendChild(previewDiv)
          }
          
          reader.readAsDataURL(file)
        }

        createVideoPreview(file, index, container) {
          const previewDiv = document.createElement('div')
          previewDiv.className = 'relative mb-6'
          
          const video = document.createElement('video')
          video.src = URL.createObjectURL(file)
          video.className = 'w-full max-w-lg h-auto rounded-lg shadow-lg'
          video.controls = true
          video.preload = 'metadata'
          
          const removeBtn = document.createElement('button')
          removeBtn.type = 'button'
          removeBtn.className = 'absolute top-2 left-20 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg hover:bg-red-600 shadow-lg'
          removeBtn.innerHTML = 'Ã—'
          removeBtn.onclick = () => {
            URL.revokeObjectURL(video.src)
            previewDiv.remove()
          }
          
          const fileName = document.createElement('p')
          fileName.textContent = file.name
          fileName.className = 'text-sm text-gray-700 mt-3 font-medium'
          
          const fileSize = document.createElement('p')
          fileSize.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)} MB`
          fileSize.className = 'text-xs text-gray-500'
          
          previewDiv.appendChild(video)
          previewDiv.appendChild(removeBtn)
          previewDiv.appendChild(fileName)
          previewDiv.appendChild(fileSize)
          container.appendChild(previewDiv)
        }

        createAudioPreview(file, index, container) {
          const previewDiv = document.createElement('div')
          previewDiv.className = 'relative mb-6 p-6 bg-gray-100 rounded-lg max-w-lg'
          
          const audioElement = document.createElement('audio')
          audioElement.src = URL.createObjectURL(file)
          audioElement.controls = true
          audioElement.className = 'w-full mb-4'
          
          const audioIcon = document.createElement('div')
          audioIcon.className = 'w-32 h-32 flex items-center justify-center bg-blue-100 rounded-lg mx-auto mb-4'
          audioIcon.innerHTML = '<svg class="w-16 h-16 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 12c0-2.21-.895-4.21-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 12a5.983 5.983 0 01-.757 2.828 1 1 0 01-1.415-1.414A3.987 3.987 0 0013 12a3.987 3.987 0 00-.172-1.414 1 1 0 010-1.415z" clip-rule="evenodd"/></svg>'
          
          const removeBtn = document.createElement('button')
          removeBtn.type = 'button'
          removeBtn.className = 'absolute top-2 left-20 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg hover:bg-red-600 shadow-lg'
          removeBtn.innerHTML = 'Ã—'
          removeBtn.onclick = () => {
            URL.revokeObjectURL(audioElement.src)
            previewDiv.remove()
          }
          
          const fileName = document.createElement('p')
          fileName.textContent = file.name
          fileName.className = 'text-sm text-gray-700 font-medium text-center'
          
          const fileSize = document.createElement('p')
          fileSize.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)} MB`
          fileSize.className = 'text-xs text-gray-500 text-center'
          
          previewDiv.appendChild(audioIcon)
          previewDiv.appendChild(audioElement)
          previewDiv.appendChild(removeBtn)
          previewDiv.appendChild(fileName)
          previewDiv.appendChild(fileSize)
          container.appendChild(previewDiv)
        }
      }

      // Register controllers
      application.register("image-test", ImageTestController)
      application.register("image-comments", ImageCommentsController)
      application.register("global-comment-pins", GlobalCommentPinsController)
      application.register("ai-comment-assistant", AiCommentAssistantController)
      application.register("compact-comments", CompactCommentsController)
      application.register("ai-sidebar", AiSidebarController)
      application.register("vote", VoteController)
      application.register("profile-wizard", ProfileWizardController)
      application.register("file-preview", FilePreviewController)
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
      window.application = application
      
      console.log("Stimulus application started and controllers registered!")
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚µã‚¤ãƒ‰ãƒãƒ¼æ©Ÿèƒ½
      document.addEventListener('DOMContentLoaded', function() {
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        console.log('Hamburger elements:', { hamburgerBtn, sidebar, overlay });
        
        if (hamburgerBtn && sidebar && overlay) {
          // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
          hamburgerBtn.addEventListener('click', function() {
            console.log('Hamburger button clicked');
            sidebar.classList.toggle('show-mobile');
            overlay.classList.toggle('hidden');
            console.log('Sidebar classes:', sidebar.className);
            console.log('Overlay classes:', overlay.className);
          });
          
          // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
          overlay.addEventListener('click', function() {
            console.log('Overlay clicked');
            sidebar.classList.remove('show-mobile');
            overlay.classList.add('hidden');
          });
          
          // ESCã‚­ãƒ¼ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
          document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
              console.log('Escape key pressed');
              sidebar.classList.remove('show-mobile');
              overlay.classList.add('hidden');
            }
          });
        } else {
          console.error('Missing elements for hamburger menu');
        }
      });
    </script>
  </head>

  <body class="bg-gray-100 text-gray-800">

    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div class="md:hidden fixed top-4 right-4 z-50">
      <button id="hamburger-btn" class="bg-white p-2 rounded-md shadow-lg border">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>



    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¹ãƒãƒ›ã®ã¿ï¼‰ -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <div class="flex">
      <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
      <div id="sidebar">
        <%= render 'layouts/sidebar' %>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->

      <main id="main-content">
        <div class="max-w-6xl mx-auto">
        <% if notice %>
          <div class="bg-green-100 text-green-800 p-4 rounded mb-4"><%= notice %></div>
        <% end %>

        <% if alert %>
          <div class="bg-red-100 text-red-800 p-4 rounded mb-4"><%= alert %></div>
        <% end %>

        <%= yield %>
        </div>
      </main>
    </div>

    <!-- Bottom navigation for mobile -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
      <div class="grid grid-cols-5 h-20">
        <!-- Home -->
        <%= link_to root_path, class: "flex flex-col items-center justify-center py-1 mt-1 #{'text-blue-600' if request.path == root_path} #{'text-gray-600' if request.path != root_path} hover:text-blue-600 transition-colors" do %>
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
          </svg>
          <span class="text-xs">ãƒ›ãƒ¼ãƒ </span>
        <% end %>
        
        <!-- Search -->
        <%= link_to search_path, class: "flex flex-col items-center justify-center py-1 mt-1 #{'text-blue-600' if request.path == search_path} #{'text-gray-600' if request.path != search_path} hover:text-blue-600 transition-colors" do %>
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <span class="text-xs">æ¤œç´¢</span>
        <% end %>
        
        <!-- New Post -->
        <%= link_to new_post_path, class: "flex flex-col items-center justify-center py-1 mt-1 #{'text-blue-600' if request.path == new_post_path} #{'text-gray-600' if request.path != new_post_path} hover:text-blue-600 transition-colors" do %>
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span class="text-xs">æ–°è¦æŠ•ç¨¿</span>
        <% end %>
        
        <!-- Direct Messages -->
        <% if user_signed_in? %>
          <%= link_to rooms_path, class: "flex flex-col items-center justify-center py-1 mt-1 #{'text-blue-600' if request.path == rooms_path} #{'text-gray-600' if request.path != rooms_path} hover:text-blue-600 transition-colors" do %>
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z"></path>
            </svg>
            <span class="text-2xs">DM</span>
          <% end %>
        <% else %>
          <div class="flex flex-col items-center justify-center py-1 mt-1 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z"></path>
            </svg>
            <span class="text-2xs">DM</span>
          </div>
        <% end %>
        
        <!-- My Page -->
        <% if user_signed_in? %>
          <%= link_to mypage_path, class: "flex flex-col items-center justify-center py-1 mt-1 #{'text-blue-600' if request.path == mypage_path} #{'text-gray-600' if request.path != mypage_path} hover:text-blue-600 transition-colors" do %>
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="text-xs">ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
          <% end %>
        <% else %>
          <%= link_to new_user_session_path, class: "flex flex-col items-center justify-center py-1 mt-1 text-gray-600 hover:text-blue-600 transition-colors" do %>
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="text-xs">ãƒ­ã‚°ã‚¤ãƒ³</span>
          <% end %>
        <% end %>
      </div>
    </nav>

    <!-- Mobile comment pins toggle button (bottom-right) -->
    <div class="md:hidden fixed bottom-24 right-4 z-40" data-controller="global-comment-pins">
      <button type="button" 
              data-action="click->global-comment-pins#toggleGlobalPins"
              data-global-comment-pins-target="toggleButton"
              class="w-16 h-16 bg-emerald-300 text-white rounded-full shadow-xl hover:bg-emerald-400 transition-all duration-300 active:scale-95 flex items-center justify-center">
        <span data-global-comment-pins-target="toggleIcon" class="text-2xl">ğŸ“</span>
      </button>
    </div>


  </body>
</html>
