<!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
<div class="mt-4 px-4">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- å·¦å´: æŠ•ç¨¿è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆç´„70%ï¼‰ -->
    <div class="lg:col-span-2">
      <% if @is_private_view %>
        <!-- éå…¬é–‹æŠ•ç¨¿è¡¨ç¤ºãƒãƒŠãƒ¼ -->
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-sm font-semibold text-amber-800">é™å®šå…¬é–‹æŠ•ç¨¿</h3>
              <p class="text-xs text-amber-600 mt-1">
                ã“ã®æŠ•ç¨¿ã¯<strong><%= @post.user.name %></strong>ã•ã‚“ã‹ã‚‰ç›´æ¥å…±æœ‰ã•ã‚ŒãŸéå…¬é–‹ã®ä½œå“ã§ã™ã€‚ã‚ãªãŸã ã‘ãŒé–²è¦§ã§ãã¾ã™ã€‚
              </p>
            </div>
          </div>
        </div>
      <% end %>
      
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <h1 class="text-lg font-bold mb-2 text-gray-900 flex items-center gap-2">
          <%= @post.title %>
          <% if @post.is_private? %>
            <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-medium">ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</span>
            <% if user_signed_in? && @post.user != current_user %>
              <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">ğŸ“¨ å—ä¿¡æ¸ˆã¿</span>
            <% end %>
          <% end %>
        </h1>
        
        <div class="flex items-center gap-2 mb-2 text-sm">
          <span class="font-medium text-gray-600">æŠ•ç¨¿è€…:</span>
          <%= link_to @post.user.name, user_path(@post.user), class: "text-blue-500 hover:underline" %>
        </div>

        <div class="flex items-center gap-2 mb-2 text-sm text-gray-500">
          <span class="font-medium">æŠ•ç¨¿æ—¥æ™‚:</span>
          <%= @post.created_at.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M") %>
        </div>

        <p class="mb-3 text-sm text-gray-600 leading-relaxed"><%= @post.body %></p>

        <% if @post.request_tag.present? %>
          <p class="mb-2">
            <span class="font-medium text-gray-500 text-xs">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:</span>
            <span class="bg-green-50 text-green-500 px-2 py-1 rounded-full text-xs"><%= @post.request_tag %></span>
          </p>
        <% end %>

        <!-- ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <% if @post.images.attached? %>
          <div class="mb-4">
            <% if @post.images.count == 1 %>
              <!-- å˜ä¸€ç”»åƒã®å ´åˆ -->
              <% image = @post.images.first %>
              <div class="text-center">
                <div class="relative inline-block image-container" data-controller="image-comments" data-image-comments-post-id-value="<%= @post.id %>" data-image-comments-image-index-value="0">
                  <%= image_tag image, class: "max-w-md rounded-lg shadow cursor-crosshair", data: { "image-comments-target": "image" }, onclick: "testClickIndicator(event)" %>

                  <!-- å³ä¸‹ã®æ‹¡å¤§ãƒãƒ¼ã‚¯ -->
                  <button type="button"
                          onclick="showImageModal('<%= url_for(image) %>')"
                          class="absolute bottom-1 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-opacity z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                    </svg>
                  </button>

                  <!-- ç”»åƒä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                  <div class="absolute inset-0 pointer-events-none" data-image-comments-target="markersContainer"></div>

                  <!-- ç”»åƒä¸Šã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
                  <div class="hidden absolute z-50 bg-white border border-gray-300 rounded p-0.5 shadow-lg image-comment-form" data-image-comments-target="form" style="min-width: 90px; max-width: min(60vw, 150px); width: max-content;">
                    <%= form_with model: [@post, Comment.new], local: false, data: { turbo: false, "image-comments-target": "commentForm", action: "submit->image-comments#submitComment" } do |f| %>
                      <%= f.hidden_field :x_position %>
                      <%= f.hidden_field :y_position %>
                      <%= f.hidden_field :image_index %>
                      <div class="flex items-center gap-0.5">
                        <%= f.text_area :body, rows: 1, placeholder: "", class: "w-full min-w-[60px] p-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-300 resize-none", required: true, data: { action: "keydown->image-comments#handleKeydown" }, style: "font-size: 16px !important; -webkit-text-size-adjust: 100%; line-height: 1.2;" %>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white w-6 h-6 flex-shrink-0 rounded-full flex items-center justify-center transition-colors" title="é€ä¿¡">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 19V5M5 12l7-7 7 7"/>
                          </svg>
                        </button>
                      </div>
                    <% end %>
                  </div>

                  <!-- ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                  <div class="mt-2 flex items-center gap-2 justify-center">
                    <button type="button"
                            data-action="click->image-comments#toggleMarkers"
                            data-image-comments-target="toggleButton"
                            class="flex items-center gap-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                      <span data-image-comments-target="toggleIcon">ğŸ‘ï¸</span>
                      <span data-image-comments-target="toggleText">ãƒ”ãƒ³è¡¨ç¤º</span>
                    </button>
                    <span data-image-comments-target="markerCount" class="text-xs text-gray-500"></span>
                  </div>
                </div>
              </div>
            <% else %>
              <!-- è¤‡æ•°ç”»åƒã®å ´åˆï¼šç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å½¢å¼ -->
              <div class="space-y-3">
                <div class="text-center text-sm text-gray-600 mb-3">
                  <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">ğŸ“· <%= @post.images.count %>æšã®ç”»åƒ</span>
                </div>
                <% @post.images.each_with_index do |image, index| %>
                  <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <div class="text-center mb-2">
                      <span class="text-sm font-medium text-gray-700"><%= index + 1 %>æšç›®</span>
                    </div>
                    <div class="text-center">
                      <div class="relative inline-block image-container" data-controller="image-comments" data-image-comments-post-id-value="<%= @post.id %>" data-image-comments-image-index-value="<%= index %>">
                        <%= image_tag image, class: "max-w-md rounded-lg shadow cursor-crosshair", data: { "image-comments-target": "image" }, onclick: "testClickIndicator(event)" %>

                        <!-- å³ä¸‹ã®æ‹¡å¤§ãƒãƒ¼ã‚¯ -->
                        <button type="button"
                                onclick="showImageModal('<%= url_for(image) %>')"
                                class="absolute bottom-1 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-opacity z-10">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                          </svg>
                        </button>

                        <!-- ç”»åƒä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div class="absolute inset-0 pointer-events-none" data-image-comments-target="markersContainer"></div>

                        <!-- ç”»åƒä¸Šã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
                        <div class="hidden absolute z-50 bg-white border border-gray-300 rounded p-0.5 shadow-lg image-comment-form" data-image-comments-target="form" style="min-width: 90px; max-width: min(60vw, 150px); width: max-content;">
                          <%= form_with model: [@post, Comment.new], local: false, data: { turbo: false, "image-comments-target": "commentForm", action: "submit->image-comments#submitComment" } do |f| %>
                            <%= f.hidden_field :x_position %>
                            <%= f.hidden_field :y_position %>
                            <%= f.hidden_field :image_index %>
                            <div class="flex items-center gap-0.5">
                              <%= f.text_area :body, rows: 1, placeholder: "", class: "w-full min-w-[60px] p-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-300 resize-none", required: true, data: { action: "keydown->image-comments#handleKeydown" }, style: "font-size: 16px !important; -webkit-text-size-adjust: 100%; line-height: 1.2;" %>
                              <button type="submit" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white w-6 h-6 flex-shrink-0 rounded-full flex items-center justify-center transition-colors" title="é€ä¿¡">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M12 19V5M5 12l7-7 7 7"/>
                                </svg>
                              </button>
                            </div>
                          <% end %>
                        </div>

                        <!-- ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                        <div class="mt-2 flex items-center gap-2 justify-center">
                          <button type="button"
                                  data-action="click->image-comments#toggleMarkers"
                                  data-image-comments-target="toggleButton"
                                  class="flex items-center gap-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                            <span data-image-comments-target="toggleIcon">ğŸ‘ï¸</span>
                            <span data-image-comments-target="toggleText">ãƒ”ãƒ³è¡¨ç¤º</span>
                          </button>
                          <span data-image-comments-target="markerCount" class="text-xs text-gray-500"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if @post.present? && @post.videos.attached? %>
          <div class="mb-4">
            <% @post.videos.each_with_index do |video, index| %>
              <div class="bg-gray-900 rounded-xl overflow-hidden shadow-lg mb-4">
                <video class="custom-video no-context-menu w-full max-w-md" 
                       controls 
                       controlsList="nodownload noremoteplayback"
                       oncontextmenu="return false;"
                       preload="metadata"
                       style="outline: none;">
                  <source src="<%= url_for(video) %>" type="video/mp4">
                  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ video ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </video>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if @post.present? && @post.audios.attached? %>
          <div class="mb-4">
            <% @post.audios.each_with_index do |audio, index| %>
              <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-xl p-3 mb-3 border border-purple-200">
                <audio class="custom-audio no-context-menu w-full" 
                       controls 
                       controlsList="nodownload noremoteplayback"
                       oncontextmenu="return false;"
                       preload="metadata"
                       style="outline: none;">
                  <source src="<%= url_for(audio) %>" type="audio/mpeg">
                  <source src="<%= url_for(audio) %>" type="audio/wav">
                  <source src="<%= url_for(audio) %>" type="audio/ogg">
                  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ audio ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </audio>
              </div>
            <% end %>
          </div>
        <% end %>

        <p class="mb-4">
          <span class="font-semibold text-gray-600">ã‚¿ã‚°:</span>
          <span class="bg-blue-50 text-blue-500 px-2 py-1 rounded-full text-sm"><%= @post.tag %></span>
        </p>

        <!-- æŠ•ç¥¨ãƒœã‚¿ãƒ³ï¼ˆAJAXï¼‹å‰²åˆãƒãƒ¼ï¼‰ -->
        <div class="flex items-center justify-end gap-4 mt-6 border-t pt-4">
          
          <!-- ä¸€æ™‚çš„ã«é™çš„ãªè¡¨ç¤ºã«ã—ã¦ã€åŸºæœ¬çš„ãªæŠ•ç¥¨æ©Ÿèƒ½ã‚’å‹•ã‹ã™ -->
          <% up_count = @post.votes.where(value: 1).count %>
          <% down_count = @post.votes.where(value: -1).count %>
          <% user_vote = current_user ? (@post.votes.find_by(user: current_user)&.value || 0) : 0 %>
          <% total_votes = up_count + down_count %>
          <% net_score = up_count - down_count %>
          
          <!-- ãƒ—ãƒ©ã‚¹æŠ•ç¥¨ãƒœã‚¿ãƒ³ -->
          <% if user_vote == 0 %>
            <button type="button" 
                    class="text-gray-500 hover:text-green-600"
                    onclick="showVoteModal(1, <%= @post.id %>)">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% else %>
            <button type="button" 
                    class="<%= user_vote == 1 ? 'text-green-600 bg-green-100 rounded px-2 py-1 font-bold' : 'text-gray-400' %>"
                    disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% end %>
          
          <div class="relative w-36 h-6 bg-gray-300 rounded overflow-hidden">
            <% if user_vote == 0 %>
              <!-- æœªæŠ•ç¥¨ã®å ´åˆï¼šã‚°ãƒ¬ãƒ¼ã®ãƒãƒ¼ -->
              <div class="absolute inset-0 flex items-center justify-center text-xs text-gray-700 font-semibold select-none">
                <%= total_votes %>
              </div>
            <% else %>
              <!-- æŠ•ç¥¨æ¸ˆã¿ã®å ´åˆï¼šã‚«ãƒ©ãƒ•ãƒ«ãªãƒãƒ¼ã¨å†…è¨³è¡¨ç¤º -->
              <div class="absolute inset-0 flex">
                <% if total_votes > 0 %>
                  <% up_percentage = (up_count.to_f / total_votes * 100).round(1) %>
                  <% down_percentage = (down_count.to_f / total_votes * 100).round(1) %>
                  
                  <!-- ãƒ—ãƒ©ã‚¹ç¥¨ã®ãƒãƒ¼ -->
                  <div class="h-full bg-green-500 relative flex items-center justify-center" style="width: <%= up_percentage %>%">
                    <% if up_count > 0 %>
                      <span class="text-xs text-white font-bold"><%= up_count %></span>
                    <% end %>
                  </div>
                  
                  <!-- ãƒã‚¤ãƒŠã‚¹ç¥¨ã®ãƒãƒ¼ -->
                  <div class="h-full bg-red-500 relative flex items-center justify-center" style="width: <%= down_percentage %>%">
                    <% if down_count > 0 %>
                      <span class="text-xs text-white font-bold"><%= down_count %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <!-- ãƒã‚¤ãƒŠã‚¹æŠ•ç¥¨ãƒœã‚¿ãƒ³ -->
          <% if user_vote == 0 %>
            <button type="button" 
                    class="text-gray-500 hover:text-red-600"
                    onclick="showVoteModal(-1, <%= @post.id %>)">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% else %>
            <button type="button" 
                    class="<%= user_vote == -1 ? 'text-red-600 bg-red-100 rounded px-2 py-1 font-bold' : 'text-gray-400' %>"
                    disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- AIã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå³å´ï¼‰ -->
    <div class="lg:col-span-1">
      <div class="bg-gradient-to-br from-purple-100 to-indigo-200 border-2 border-purple-300 rounded-2xl shadow-lg p-4 sticky top-4" data-controller="ai-sidebar" data-ai-sidebar-post-id-value="<%= @post.id %>">
        <!-- AIè£œåŠ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="flex items-center justify-center gap-2 mb-4">
          <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
            <span class="text-white text-xs font-bold">AI</span>
          </div>
          <h2 class="text-sm font-bold text-gray-900">ã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©</h2>
        </div>

          <!-- åˆæœŸçŠ¶æ…‹ã®èª¬æ˜ -->
          <div data-ai-sidebar-target="initialMessage" class="text-center py-4">
            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <span class="text-lg">ğŸ¤–</span>
            </div>
            <h3 class="text-sm font-semibold text-gray-800 mb-2">AIã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©</h3>
            <p class="text-xs text-gray-600 mb-4">
              AIãŒã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’ã‚µãƒãƒ¼ãƒˆ
            </p>

            <!-- AIèµ·å‹•ãƒœã‚¿ãƒ³ -->
            <button type="button"
                    data-action="click->ai-sidebar#toggleAI"
                    data-ai-sidebar-target="toggleButton"
                    class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-sm font-bold rounded-lg shadow-md hover:from-purple-700 hover:to-indigo-700 transition-all transform hover:scale-105 flex items-center gap-2 mx-auto">
              <span data-ai-sidebar-target="toggleIcon">ğŸ¤–</span>
              <span data-ai-sidebar-target="toggleText">é–‹å§‹</span>
            </button>
          </div>

          <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
          <div data-ai-sidebar-target="loading" class="hidden text-center py-4">
            <div class="w-8 h-8 border-2 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-xs text-gray-600">AIåˆ†æä¸­...</p>
          </div>

          <!-- AIè£œåŠ©ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
          <div data-ai-sidebar-target="aiContent" class="hidden space-y-3">

            <!-- èªå½™ãƒ»è¡¨ç¾ã®è£œåŠ© -->
            <div class="bg-gradient-to-br from-emerald-50 to-teal-100 rounded-lg p-4 border-2 border-emerald-200">
              <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                <div class="w-6 h-6 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full flex items-center justify-center">
                  <span class="text-white text-xs">ğŸ“</span>
                </div>
                èªå½™ãƒ»è¡¨ç¾ã®è£œåŠ©
              </h3>
              <div data-ai-sidebar-target="vocabularies" class="flex flex-wrap gap-2">
                <!-- èªå½™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
              <div class="mt-3 pt-3 border-t border-emerald-200">
                <p class="text-xs text-emerald-600 italic text-center">
                  ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«æŒ¿å…¥ã§ãã¾ã™
                </p>
              </div>
            </div>

            <!-- AIåˆ†æçµæœ -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-100 rounded-lg p-4 border-2 border-purple-200">
              <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
                  <span class="text-white text-xs">ğŸ”</span>
                </div>
                AIåˆ†æãƒã‚¤ãƒ³ãƒˆ
              </h3>
              <div data-ai-sidebar-target="summary" class="space-y-2">
                <!-- AIç”»åƒèªè­˜ãƒ»åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
              <div class="mt-3 pt-3 border-t border-purple-200">
                <p class="text-xs text-purple-600 italic text-center">
                  <% if @post.images.attached? %>
                    ğŸ“¸ ç”»åƒã‚’åˆ†æã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ’ãƒ³ãƒˆã‚’æä¾›ã—ã¾ã™
                  <% else %>
                    ğŸ“ æŠ•ç¨¿å†…å®¹ã‚’åˆ†æã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ’ãƒ³ãƒˆã‚’æä¾›ã—ã¾ã™
                  <% end %>
                </p>
              </div>
            </div>

            <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
            <div class="text-center pt-1">
              <button type="button"
                      data-action="click->ai-sidebar#closeAI"
                      class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                é–‰ã˜ã‚‹
              </button>
            </div>
          </div>
      </div>
    </div>
    
  </div>
</div>

<!-- æŠ•ç¥¨ã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="voteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div id="voteModalContent" class="bg-white rounded-lg p-6 max-w-7xl w-full mx-2 shadow-xl max-h-[98vh] overflow-y-auto">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">è©•ä¾¡ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„</h3>
    
    <!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå‹•çš„ã«å¤‰æ›´ï¼‰ -->
    <div id="modalLayout" class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3">
      
      <!-- å·¦å´: æŠ•ç¨¿å†…å®¹è¡¨ç¤º -->
      <div id="postContent" class="lg:col-span-2 space-y-4">
        <!-- æŠ•ç¨¿å†…å®¹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <span>ğŸ“</span>
            <%= @post.title %>
          </h4>
          <div class="text-base text-gray-800">
            
            <!-- ç”»åƒè¡¨ç¤º -->
            <% if @post.images.attached? %>
              <div class="mb-4">
                <% if @post.images.count == 1 %>
                  <div class="flex justify-center">
                    <div class="relative">
                      <%= image_tag @post.images.first, class: "max-h-80 object-contain rounded border shadow-md", id: "primaryImage", onload: "checkImageAspectRatio(this)" %>
                      <!-- å³ä¸‹ã®æ‹¡å¤§ãƒãƒ¼ã‚¯ -->
                      <button type="button" 
                              onclick="showImageModal('<%= url_for(@post.images.first) %>')"
                              class="absolute bottom-1 right-1 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-opacity z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                        </svg>
                      </button>
                    </div>
                  </div>
                <% else %>
                  <div class="grid grid-cols-1 gap-3">
                    <% @post.images.limit(2).each_with_index do |image, index| %>
                      <div class="relative inline-block mx-auto">
                        <%= image_tag image, class: "max-h-64 object-contain rounded border shadow-sm", id: "image_#{index}", onload: index == 0 ? "checkImageAspectRatio(this)" : "" %>
                        <!-- å³ä¸‹ã®æ‹¡å¤§ãƒãƒ¼ã‚¯ -->
                        <button type="button" 
                                onclick="showImageModal('<%= url_for(image) %>')"
                                class="absolute bottom-1 right-1 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-opacity z-10">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                          </svg>
                        </button>
                      </div>
                    <% end %>
                    <% if @post.images.count > 2 %>
                      <div class="w-full h-64 bg-gray-200 rounded border flex items-center justify-center">
                        <span class="text-base text-gray-600">+<%= @post.images.count - 2 %>æš</span>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
            
            <p class="text-gray-700 mb-4 leading-relaxed text-base"><%= @post.body %></p>
            <% if @post.tag.present? %>
              <div class="flex flex-wrap gap-2">
                <% @post.tag.split(',').each do |tag| %>
                  <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full font-medium"><%= tag.strip %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- å³å´: AIè£œåŠ© -->
      <div id="aiContent" class="lg:col-span-1 space-y-4">
        <!-- AIã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©ã‚¨ãƒªã‚¢ -->
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-3 border border-purple-100 min-h-[180px] flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-gray-800 flex items-center gap-1">
              <div class="w-4 h-4 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
                <span class="text-white text-xs font-bold">AI</span>
              </div>
              ã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©
            </h4>
            <button type="button"
                    onclick="toggleVoteModalAI()"
                    id="voteModalAIToggle"
                    class="px-2 py-1 bg-purple-600 text-white text-xs font-medium rounded hover:bg-purple-700 transition-colors flex items-center gap-1">
              <span>ğŸ¤–</span>
              <span>é–‹å§‹</span>
            </button>
          </div>

          <!-- åˆæœŸçŠ¶æ…‹ã®èª¬æ˜ -->
          <div id="voteModalAIInitial" class="text-center py-2">
            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-1">
              <span class="text-xs">ğŸ¤–</span>
            </div>
            <p class="text-xs text-gray-600">
              AIãŒã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’ã‚µãƒãƒ¼ãƒˆ
            </p>
          </div>

          <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
          <div id="voteModalAILoading" class="hidden text-center py-2">
            <div class="w-5 h-5 border-2 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-1"></div>
            <p class="text-xs text-gray-600">AIåˆ†æä¸­...</p>
          </div>

          <!-- AIè£œåŠ©ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
          <div id="voteModalAIContent" class="hidden space-y-3 flex-1">

          </div>
        </div>
      </div>
    </div>

    <!-- ä¸‹éƒ¨: ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆä½ç½®ã¯å‹•çš„ã«å¤‰æ›´ï¼‰ -->
    <div id="commentSection" class="border-t pt-4">
      <p id="modalMessage" class="text-base text-gray-700 mb-4 text-center font-medium">
        ãªãœãã†æ€ã£ãŸã®ã‹ã‚’æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚
      </p>

      <!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <%= form_with url: vote_path, method: :post, local: true, id: "voteForm", class: "space-y-4", onsubmit: "document.body.style.overflow = ''; const commentFormBar = document.getElementById('comment-form-bar'); if (commentFormBar) commentFormBar.style.display = 'block';" do |f| %>
        <%= f.hidden_field :votable_type, value: "Post" %>
        <%= f.hidden_field :votable_id, value: @post.id %>
        <%= f.hidden_field :value, id: "voteValue" %>
        <%= f.text_area :comment, id: "voteComment", rows: 5, 
            placeholder: "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰",
            class: "w-full p-3 text-sm border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" %>
        <div class="flex gap-3 justify-center">
          <button type="submit" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-sm shadow-sm">
            é€ä¿¡
          </button>
          <button type="button" onclick="submitVoteWithoutComment()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors text-sm shadow-sm">
            ã‚³ãƒ¡ãƒ³ãƒˆãªã—ã§è©•ä¾¡
          </button>
        </div>
      <% end %>
    </div>

    <button type="button" onclick="hideVoteModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl leading-none">
      Ã—
    </button>
  </div>
</div>

<!-- ç”»åƒæ‹¡å¤§è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center hidden p-4" style="z-index: 10000;">
  <div class="relative w-full h-full flex items-center justify-center">
    <div class="relative" data-controller="image-comments" data-image-comments-post-id-value="<%= @post.id %>" data-image-comments-image-index-value="0">
      <img id="modalImage" src="" alt="æ‹¡å¤§ç”»åƒ" class="max-w-full max-h-full object-contain rounded shadow-xl cursor-crosshair" data-image-comments-target="image">

      <!-- ç”»åƒä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="absolute inset-0 pointer-events-none" data-image-comments-target="markersContainer"></div>

      <!-- ç”»åƒä¸Šã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºã€å°ã•ã„ç”»åƒã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
      <div class="hidden absolute bg-white border border-gray-300 rounded p-0.5 shadow-lg image-comment-form" data-image-comments-target="form" style="min-width: 90px; max-width: min(60vw, 150px); width: max-content; z-index: 10001;">
        <%= form_with model: [@post, Comment.new], local: false, data: { turbo: false, "image-comments-target": "commentForm", action: "submit->image-comments#submitComment" } do |f| %>
          <%= f.hidden_field :x_position %>
          <%= f.hidden_field :y_position %>
          <%= f.hidden_field :image_index %>
          <div class="flex items-center gap-0.5">
            <%= f.text_area :body, rows: 1, placeholder: "", class: "w-full min-w-[60px] p-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-300 resize-none", required: true, data: { action: "keydown->image-comments#handleKeydown" }, style: "font-size: 16px !important; -webkit-text-size-adjust: 100%; line-height: 1.2;" %>
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white w-6 h-6 flex-shrink-0 rounded-full flex items-center justify-center transition-colors" title="é€ä¿¡">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19V5M5 12l7-7 7 7"/>
              </svg>
            </button>
          </div>
        <% end %>
      </div>
    </div>
    
    <button type="button" onclick="hideImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-2xl leading-none bg-black bg-opacity-60 rounded-full w-12 h-12 flex items-center justify-center transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
</div>

<!-- æŠ•ç¥¨æ©Ÿèƒ½ã®JavaScriptï¼ˆç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼‰ -->
<script>
  console.log('Inline vote script loaded!')
  
  let currentVoteValue = 0
  let currentPostId = 0

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
  window.showVoteModal = function(value, postId) {
    console.log('Showing vote modal:', value, postId)
    currentVoteValue = value
    currentPostId = postId
    
    const modal = document.getElementById('voteModal')
    const modalContent = document.getElementById('voteModalContent')
    const messageElement = document.getElementById('modalMessage')
    const voteValueInput = document.getElementById('voteValue')
    const commentTextarea = document.getElementById('voteComment')
    
    if (modal) {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
      messageElement.textContent = value === 1 ? 
        'ãªãœãƒ—ãƒ©ã‚¹è©•ä¾¡ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚' : 
        'ãªãœãƒã‚¤ãƒŠã‚¹è©•ä¾¡ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚'
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯è‰²ã¯ç™½ã®ã¾ã¾ç¶­æŒ
      
      // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
      voteValueInput.value = value
      
      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
      document.body.style.overflow = 'hidden'
      
      // å›ºå®šã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
      const commentFormBar = document.getElementById('comment-form-bar')
      if (commentFormBar) {
        commentFormBar.style.display = 'none'
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      modal.classList.remove('hidden')
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      if (commentTextarea) {
        setTimeout(() => commentTextarea.focus(), 100)
      }
      
      console.log('Modal shown successfully')
    } else {
      console.error('Modal element not found')
    }
  }

  window.hideVoteModal = function() {
    const modal = document.getElementById('voteModal')
    const modalContent = document.getElementById('voteModalContent')
    const commentTextarea = document.getElementById('voteComment')
    
    if (modal) {
      modal.classList.add('hidden')
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      if (commentTextarea) {
        commentTextarea.value = ''
      }
      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯è‰²ã¯ãã®ã¾ã¾
      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å†æœ‰åŠ¹åŒ–
      document.body.style.overflow = ''
      
      // å›ºå®šã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å†è¡¨ç¤º
      const commentFormBar = document.getElementById('comment-form-bar')
      if (commentFormBar) {
        commentFormBar.style.display = 'block'
      }
    }
  }

  window.submitVoteWithoutComment = function() {
    const commentTextarea = document.getElementById('voteComment')
    if (commentTextarea) {
      commentTextarea.value = '' // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç©ºã«ã™ã‚‹
    }
    
    // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å†æœ‰åŠ¹åŒ–
    document.body.style.overflow = ''
    
    // å›ºå®šã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å†è¡¨ç¤º
    const commentFormBar = document.getElementById('comment-form-bar')
    if (commentFormBar) {
      commentFormBar.style.display = 'block'
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
    const form = document.getElementById('voteForm')
    if (form) {
      form.submit()
    }
  }

  // æŠ•ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨AIæ©Ÿèƒ½ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œï¼‰
  let voteModalAILoaded = false
  let voteModalAICache = null
  
  window.toggleVoteModalAI = function() {
    const initialDiv = document.getElementById('voteModalAIInitial')
    const loadingDiv = document.getElementById('voteModalAILoading')
    const contentDiv = document.getElementById('voteModalAIContent')
    const toggleButton = document.getElementById('voteModalAIToggle')
    
    if (contentDiv.classList.contains('hidden')) {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿
      if (voteModalAILoaded && voteModalAICache) {
        contentDiv.innerHTML = voteModalAICache
        initialDiv.classList.add('hidden')
        contentDiv.classList.remove('hidden')
        toggleButton.innerHTML = '<span>ğŸ¤–</span><span>é–‰ã˜ã‚‹</span>'
        adjustLayoutForAI(true)
        return
      }
      
      // AIæ©Ÿèƒ½ã‚’é–‹å§‹
      initialDiv.classList.add('hidden')
      loadingDiv.classList.remove('hidden')
      toggleButton.innerHTML = '<span>ğŸ¤–</span><span>åˆ†æä¸­...</span>'
      toggleButton.disabled = true
      
      // ãƒ¢ãƒƒã‚¯AIåˆ†æï¼ˆå®Ÿéš›ã®APIã¯å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã¿ã§ä½¿ç”¨ï¼‰
      setTimeout(() => {
        const mockContent = `
          <div class="space-y-3">
            <div class="bg-emerald-50 rounded-lg p-3 border border-emerald-200">
              <h4 class="text-sm font-bold text-emerald-800 mb-2">ğŸ’¡ è©•ä¾¡ã®ãƒ’ãƒ³ãƒˆ</h4>
              <div class="text-xs text-emerald-700 space-y-1">
                <p>â€¢ ä½œå“ã®æŠ€è¡“çš„ãªå´é¢ã«æ³¨ç›®ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
                <p>â€¢ æ„Ÿæƒ…çš„ãªå°è±¡ã‚’å…·ä½“çš„ã«è¡¨ç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
                <p>â€¢ å»ºè¨­çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†</p>
              </div>
            </div>
            <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
              <h4 class="text-sm font-bold text-purple-800 mb-2">ğŸ“ è¡¨ç¾ä¾‹</h4>
              <div class="flex flex-wrap gap-1">
                <span class="px-2 py-1 bg-white border border-purple-300 rounded text-xs text-purple-700 cursor-pointer hover:bg-purple-100" onclick="insertToVoteComment('å°è±¡çš„')">å°è±¡çš„</span>
                <span class="px-2 py-1 bg-white border border-purple-300 rounded text-xs text-purple-700 cursor-pointer hover:bg-purple-100" onclick="insertToVoteComment('ä¸å¯§')">ä¸å¯§</span>
                <span class="px-2 py-1 bg-white border border-purple-300 rounded text-xs text-purple-700 cursor-pointer hover:bg-purple-100" onclick="insertToVoteComment('å‰µé€ çš„')">å‰µé€ çš„</span>
              </div>
            </div>
          </div>
        `
        
        contentDiv.innerHTML = mockContent
        voteModalAICache = mockContent
        voteModalAILoaded = true
        
        loadingDiv.classList.add('hidden')
        contentDiv.classList.remove('hidden')
        toggleButton.innerHTML = '<span>ğŸ¤–</span><span>é–‰ã˜ã‚‹</span>'
        toggleButton.disabled = false
        
        // AIè¡¨ç¤ºæ™‚ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´
        adjustLayoutForAI(true)
      }, 1000) // APIå‘¼ã³å‡ºã—ã§ã¯ãªã„ã®ã§çŸ­æ™‚é–“
    } else {
      // AIæ©Ÿèƒ½ã‚’é–‰ã˜ã‚‹
      contentDiv.classList.add('hidden')
      initialDiv.classList.remove('hidden')
      toggleButton.innerHTML = '<span>ğŸ¤–</span><span>é–‹å§‹</span>'
      
      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å…ƒã«æˆ»ã™
      adjustLayoutForAI(false)
    }
  }
  
  // æŠ•ç¥¨ã‚³ãƒ¡ãƒ³ãƒˆã«èªå½™ã‚’æŒ¿å…¥
  window.insertToVoteComment = function(text) {
    const textarea = document.getElementById('voteComment')
    if (textarea) {
      const cursorPos = textarea.selectionStart || textarea.value.length
      const newText = textarea.value.slice(0, cursorPos) + text + textarea.value.slice(cursorPos)
      textarea.value = newText
      textarea.focus()
      textarea.setSelectionRange(cursorPos + text.length, cursorPos + text.length)
    }
  }




  // ç”»åƒæ‹¡å¤§è¡¨ç¤ºæ©Ÿèƒ½
  window.showImageModal = function(imageSrc) {
    console.log('ğŸ” showImageModal called');

    // ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤ï¼ˆã‚ã‚‹å ´åˆï¼‰
    if (window.removePinCommentOverlay) {
      window.removePinCommentOverlay();
      console.log('ğŸ” Overlay removed');
    }

    // å°ã•ã„ç”»åƒã®ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚‚ã®ã¯é™¤å¤–ï¼‰
    const imageContainers = document.querySelectorAll('[data-controller="image-comments"]');
    imageContainers.forEach(container => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¯é™¤å¤–
      if (container.closest('#imageModal')) {
        return;
      }
      const controller = container.imageCommentsController;
      if (controller && typeof controller.hideForm === 'function') {
        controller.hideForm();
      }
    });
    console.log('ğŸ” Forms hidden via controller');

    // ã™ã¹ã¦ã®ä¸€æ™‚ãƒ”ãƒ³ï¼ˆé»„è‰²ã®xï¼‰ã‚’å‰Šé™¤
    const tempPins = document.querySelectorAll('[data-temp-pin="true"]');
    tempPins.forEach(pin => {
      pin.remove();
      console.log('ğŸ” Temp pin removed');
    });

    // é’ã„ä¸¸ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
    if (window.removeClickIndicator) {
      window.removeClickIndicator();
      console.log('ğŸ” Click indicators removed via function');
    }

    // å¿µã®ãŸã‚ã€ã™ã¹ã¦ã®é’ã„ä¸¸ã‚’ç›´æ¥å‰Šé™¤
    const allBlueCircles = document.querySelectorAll('.click-indicator');
    allBlueCircles.forEach(circle => {
      circle.remove();
      console.log('ğŸ” Blue circle removed directly');
    });

    const modal = document.getElementById('imageModal')
    const modalImage = document.getElementById('modalImage')

    if (modal && modalImage) {
      modalImage.src = imageSrc
      document.body.style.overflow = 'hidden'
      modal.classList.remove('hidden')
      
      // ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      modalImage.onload = function() {
        // ç”»é¢ã‚µã‚¤ã‚ºã«å¯¾ã™ã‚‹ä½™ç™½ã‚’ç¢ºä¿ï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚° + é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®é ˜åŸŸï¼‰
        const maxWidth = window.innerWidth - 32  // 16px * 2 (padding)
        const maxHeight = window.innerHeight - 32 // 16px * 2 (padding)
        
        const imageWidth = this.naturalWidth
        const imageHeight = this.naturalHeight
        
        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰ã€ç”»é¢ã«åã¾ã‚‹ã‚ˆã†ã«ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
        const widthRatio = maxWidth / imageWidth
        const heightRatio = maxHeight / imageHeight
        const ratio = Math.min(widthRatio, heightRatio, 1) // 1ã‚’è¶…ãˆãªã„ï¼ˆæ‹¡å¤§ã—ãªã„ï¼‰
        
        if (ratio < 1) {
          this.style.width = Math.floor(imageWidth * ratio) + 'px'
          this.style.height = Math.floor(imageHeight * ratio) + 'px'
        } else {
          this.style.width = imageWidth + 'px'
          this.style.height = imageHeight + 'px'
        }
        
        // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        setupModalImageClick()
      }
    }
  }

  window.hideImageModal = function() {
    console.log('ğŸ” hideImageModal called');

    // ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤
    if (window.removePinCommentOverlay) {
      window.removePinCommentOverlay();
      console.log('ğŸ” Pin comment overlay removed on modal close');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    const modalContainer = document.querySelector('#imageModal [data-controller="image-comments"]');
    if (modalContainer) {
      const controller = modalContainer.imageCommentsController;
      if (controller && typeof controller.hideForm === 'function') {
        controller.hideForm();
        console.log('ğŸ” Modal form hidden');
      }
    }

    // é’ã„ä¸¸ã‚’å‰Šé™¤
    if (window.removeClickIndicator) {
      window.removeClickIndicator();
      console.log('ğŸ” Click indicators removed on modal close');
    }

    const modal = document.getElementById('imageModal')
    const modalImage = document.getElementById('modalImage')

    if (modal && modalImage) {
      modal.classList.add('hidden')
      modalImage.src = ''
      modalImage.style.width = ''
      modalImage.style.height = ''
      modalImage.onload = null
      document.body.style.overflow = ''
      console.log('ğŸ” Modal hidden and cleaned up');
    }
  }

  // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.getElementById('imageModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      hideImageModal()
    }
  })

  // ç¾åœ¨ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
  let currentClickIndicator = null;

  // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’é’ã„ä¸¸ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showClickIndicator(clientX, clientY) {
    console.log('showClickIndicator called at:', clientX, clientY);

    // æ—¢å­˜ã®é’ã„ä¸¸ãŒã‚ã‚Œã°å‰Šé™¤
    if (currentClickIndicator && currentClickIndicator.parentNode) {
      currentClickIndicator.remove();
    }

    // é’ã„ä¸¸ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆï¼ˆã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã«ï¼‰
    const indicator = document.createElement('div')
    indicator.className = 'click-indicator'
    indicator.style.cssText = `
      position: fixed;
      left: ${clientX}px;
      top: ${clientY}px;
      width: 32px;
      height: 32px;
      background-color: #3b82f6;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10002;
      transform: translate(-50%, -50%);
    `

    document.body.appendChild(indicator)
    currentClickIndicator = indicator;
    console.log('Blue indicator added to body');
  }

  // ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ™‚ã«é’ã„ä¸¸ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
  function removeClickIndicator() {
    // å¤‰æ•°ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹é’ã„ä¸¸ã‚’å‰Šé™¤
    if (currentClickIndicator && currentClickIndicator.parentNode) {
      currentClickIndicator.remove();
      currentClickIndicator = null;
      console.log('Blue indicator removed after comment submission');
    }

    // ã™ã¹ã¦ã®é’ã„ä¸¸ï¼ˆclass="click-indicator"ï¼‰ã‚’å‰Šé™¤
    const allIndicators = document.querySelectorAll('.click-indicator');
    allIndicators.forEach(indicator => {
      indicator.remove();
      console.log('Additional blue indicator removed');
    });
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
  window.removeClickIndicator = removeClickIndicator;

  // Escapeã‚­ãƒ¼ã§é’ã„ä¸¸ã‚’å‰Šé™¤
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentClickIndicator) {
      console.log('Escape pressed, removing blue indicator');
      removeClickIndicator();
    }
  });

  // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼é–¢æ•°
  function testClickIndicator(event) {
    console.log('testClickIndicator called at:', event.clientX, event.clientY);
    showClickIndicator(event.clientX, event.clientY);
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’è¨­å®š
  window.setupModalImageClick = function() {
    console.log('ğŸ”µğŸ”µğŸ”µ setupModalImageClick called!')
    const modalImage = document.getElementById('modalImage')

    if (!modalImage) {
      console.log('ğŸ”´ Modal image not found!')
      return
    }

    console.log('ğŸ”µ Modal image found, setting up click listener...')

    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    modalImage.removeEventListener('click', handleModalImageClick)

    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    modalImage.addEventListener('click', handleModalImageClick)

    console.log('ğŸ”µ Click listener added to modal image!')
  }

  function handleModalImageClick(event) {
    console.log('ğŸŸ¢ğŸŸ¢ğŸŸ¢ handleModalImageClick called!', event.clientX, event.clientY)

    // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’é’ã„ä¸¸ã§è¡¨ç¤ºï¼ˆæœ€å„ªå…ˆï¼‰
    const clientX = event.clientX
    const clientY = event.clientY

    console.log('ğŸŸ¢ Creating blue circle at:', clientX, clientY)

    // æ—¢å­˜ã®é’ã„ä¸¸ã‚’å‰Šé™¤
    const existingIndicators = document.querySelectorAll('.click-indicator')
    existingIndicators.forEach(ind => ind.remove())

    // é’ã„ä¸¸ã‚’ä½œæˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ä½¿ã‚ãšã«ç›´æ¥ä½œæˆï¼‰
    const indicator = document.createElement('div')
    indicator.className = 'click-indicator'
    indicator.style.cssText = `
      position: fixed;
      left: ${clientX}px;
      top: ${clientY}px;
      width: 32px;
      height: 32px;
      background-color: #3b82f6;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10002;
      transform: translate(-50%, -50%);
    `
    document.body.appendChild(indicator)
    console.log('ğŸŸ¢ Blue circle created and added to body!')

    const modalImage = event.target
    const modalContainer = modalImage.closest('[data-controller="image-comments"]')

    if (!modalContainer) {
      console.log('ğŸ”´ Modal container not found')
      return
    }

    const form = modalContainer.querySelector('[data-image-comments-target="form"]')

    if (!form) {
      console.log('ğŸ”´ Form not found in modal container')
      return
    }

    const rect = modalImage.getBoundingClientRect()
    const x = event.clientX - rect.left
    const y = event.clientY - rect.top

    // ç”»åƒå†…ã§ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆï¼‰
    const xPercent = (x / rect.width) * 100
    const yPercent = (y / rect.height) * 100

    console.log('ğŸŸ¢ Position calculated:', xPercent, yPercent)

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    form.style.position = 'fixed'
    form.style.left = `${clientX}px`
    form.style.top = `${clientY}px`
    form.style.zIndex = '10001'
    form.classList.remove('hidden')

    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä½ç½®ã‚’è¨­å®š
    const xField = form.querySelector('input[name="comment[x_position]"]')
    const yField = form.querySelector('input[name="comment[y_position]"]')
    const imageIndexField = form.querySelector('input[name="comment[image_index]"]')

    if (xField) xField.value = xPercent
    if (yField) yField.value = yPercent
    if (imageIndexField) imageIndexField.value = 0

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    const textarea = form.querySelector('textarea')
    if (textarea) {
      setTimeout(() => {
        textarea.focus()
      }, 100)
    }

    console.log('ğŸŸ¢ Form shown and focused')
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
  window.hideModalCommentForm = function() {
    const form = document.getElementById('modalCommentForm')
    if (form) {
      form.classList.add('hidden')
      const textarea = form.querySelector('textarea')
      if (textarea) textarea.value = ''
    }
  }

  // AIè¡¨ç¤ºæ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´
  window.adjustLayoutForAI = function(showingAI) {
    const modalLayout = document.getElementById('modalLayout')
    const postContent = document.getElementById('postContent')
    const aiContent = document.getElementById('aiContent')
    const commentSection = document.getElementById('commentSection')
    
    if (!modalLayout || !postContent || !aiContent || !commentSection) return
    
    if (showingAI) {
      // AIè¡¨ç¤ºæ™‚ï¼š2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå·¦ï¼šæŠ•ç¨¿ã€å³ï¼šAIç¸¦é•·ï¼‰ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’æŠ•ç¨¿ã®ä¸‹ã«ç§»å‹•
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
      postContent.className = 'lg:col-span-1 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // AIã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’æ‹¡å¤§
      const aiContainer = aiContent.querySelector('.bg-gradient-to-r')
      if (aiContainer) {
        aiContainer.className = aiContainer.className.replace('min-h-[180px]', 'min-h-[500px]')
      }
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’æŠ•ç¨¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«ç§»å‹•
      commentSection.remove()
      postContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
      
    } else {
      // AIéè¡¨ç¤ºæ™‚ï¼šå…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã™
      const currentAspectRatio = getCurrentImageAspectRatio()
      
      if (currentAspectRatio && currentAspectRatio <= 0.8) {
        // ç¸¦é•·ç”»åƒã®å ´åˆ
        modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
        postContent.className = 'lg:col-span-1 space-y-4'
        aiContent.className = 'lg:col-span-1 space-y-4'
      } else {
        // æ¨ªé•·ãƒ»æ­£æ–¹å½¢ã®å ´åˆ
        modalLayout.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3'
        postContent.className = 'lg:col-span-2 space-y-4'
        aiContent.className = 'lg:col-span-1 space-y-4'
      }
      
      // AIã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’å…ƒã«æˆ»ã™
      const aiContainer = aiContent.querySelector('.bg-gradient-to-r')
      if (aiContainer) {
        aiContainer.className = aiContainer.className.replace('min-h-[500px]', 'min-h-[180px]')
      }
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’AIã®ä¸‹ã«æˆ»ã™
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
    }
  }

  // ç¾åœ¨ã®ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å–å¾—
  window.getCurrentImageAspectRatio = function() {
    const primaryImage = document.getElementById('primaryImage') || document.getElementById('image_0')
    if (primaryImage && primaryImage.complete) {
      return primaryImage.naturalWidth / primaryImage.naturalHeight
    }
    return null
  }

  // ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
  window.checkImageAspectRatio = function(img) {
    const aspectRatio = img.naturalWidth / img.naturalHeight
    const modalLayout = document.getElementById('modalLayout')
    const postContent = document.getElementById('postContent')
    const aiContent = document.getElementById('aiContent')
    const commentSection = document.getElementById('commentSection')
    
    if (!modalLayout || !postContent || !aiContent || !commentSection) return
    
    // ç¸¦é•·ç”»åƒã®å ´åˆï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãŒ0.8ä»¥ä¸‹ï¼‰
    if (aspectRatio <= 0.8) {
      // 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´ï¼ˆå·¦ï¼šæŠ•ç¨¿ã€å³ï¼šAIï¼‰
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
      postContent.className = 'lg:col-span-1 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // ç”»åƒã‚’ã‚ˆã‚Šå¤§ããç¸¦é•·ã§è¡¨ç¤º
      img.className = img.className.replace('max-h-80', 'max-h-[500px]').replace('max-h-64', 'max-h-96')
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«ç§»å‹•
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
      
    } else {
      // æ¨ªé•·ãƒ»æ­£æ–¹å½¢ã®å ´åˆã‚‚3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’AIä¸‹ã«é…ç½®
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3'
      postContent.className = 'lg:col-span-2 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«ç§»å‹•
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãéš›ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
  const originalShowVoteModal = window.showVoteModal
  window.showVoteModal = function(value, postId) {
    // å…ƒã®é–¢æ•°ã‚’å®Ÿè¡Œ
    originalShowVoteModal(value, postId)
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’AIã®ä¸‹ã«é…ç½®
    setTimeout(() => {
      const aiContent = document.getElementById('aiContent')
      const commentSection = document.getElementById('commentSection')
      
      if (aiContent && commentSection) {
        commentSection.remove()
        aiContent.appendChild(commentSection)
        commentSection.className = 'border-t pt-4 mt-4'
      }
      
      // ç”»åƒãŒã‚ã‚‹å ´åˆã¯ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ãƒã‚§ãƒƒã‚¯
      const primaryImage = document.getElementById('primaryImage') || document.getElementById('image_0')
      if (primaryImage && primaryImage.complete) {
        checkImageAspectRatio(primaryImage)
      }
    }, 100)
  }
</script>


<!-- çµ±åˆã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="max-w-7xl mx-auto mt-8 px-4">
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h3 class="text-xl font-bold mb-6 text-gray-900">è©•ä¾¡ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
    

    <!-- ç”»åƒä¸Šã®ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-semibold text-blue-800 flex items-center gap-2">
          <span>ğŸ“</span>
          ç”»åƒä¸Šã®ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ
        </h4>
        <% image_comments = @post.comments.where.not(x_position: nil, y_position: nil).order(:created_at) %>
        <span class="text-sm text-blue-600"><%= image_comments.count %>ä»¶</span>
      </div>

      <% if user_can_view_comments?(current_user, @post) %>
        <div class="space-y-4 max-h-64 overflow-y-auto border border-blue-200 rounded-lg p-3 bg-blue-50" data-controller="compact-comments">
          <% if image_comments.any? %>
            <% if @post.images.count > 1 %>
              <!-- è¤‡æ•°ç”»åƒã®å ´åˆã¯ç”»åƒã”ã¨ã«åˆ†é¡ã—ã¦è¡¨ç¤º -->
              <% @post.images.each_with_index do |image, img_index| %>
                <% image_specific_comments = image_comments.where(image_index: img_index).order(:created_at) %>
                <% if image_specific_comments.any? %>
                  <div class="mb-4">
                    <div class="text-sm font-semibold text-blue-700 mb-2 pb-1 border-b border-blue-300">
                      <%= img_index + 1 %>æšç›®ã®ç”»åƒ (<%= image_specific_comments.count %>ä»¶)
                    </div>
                    <div class="space-y-3">
                      <% image_specific_comments.each_with_index do |comment, index| %>
                        <div class="bg-blue-50 rounded-lg border border-blue-200 shadow-sm hover:shadow-md transition-shadow p-4 cursor-pointer hover:bg-blue-100"
                             data-comment-id="<%= comment.id %>"
                             data-image-index="<%= img_index %>"
                             data-action="click->image-comments-v2#highlightMarker click->compact-comments#highlightComment">
                          <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                              <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                <%= index + 1 %>
                              </div>
                              <div>
                                <span class="font-medium text-blue-900"><%= comment.user&.name || "åŒ¿å" %></span>
                                <span class="text-xs text-blue-600 ml-2"><%= time_ago_in_words(comment.created_at) %>å‰</span>
                              </div>
                            </div>

                            <div class="text-xs text-blue-500 bg-blue-100 px-2 py-1 rounded-full">
                              ç”»åƒä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆ
                            </div>
                          </div>
                          <p class="text-blue-900 leading-relaxed"><%= comment.body %></p>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>
            <% else %>
              <!-- å˜ä¸€ç”»åƒã®å ´åˆã¯é€šå¸¸è¡¨ç¤º -->
              <% image_comments.each_with_index do |comment, index| %>
                <div class="bg-blue-50 rounded-lg border border-blue-200 shadow-sm hover:shadow-md transition-shadow p-4 cursor-pointer hover:bg-blue-100"
                     data-comment-id="<%= comment.id %>"
                     data-action="click->image-comments-v2#highlightMarker click->compact-comments#highlightComment">
                          <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                              <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                <%= index + 1 %>
                              </div>
                              <div>
                                <span class="font-medium text-blue-900"><%= comment.user&.name || "åŒ¿å" %></span>
                                <span class="text-xs text-blue-600 ml-2"><%= time_ago_in_words(comment.created_at) %>å‰</span>
                              </div>
                            </div>

                            <div class="text-xs text-blue-500 bg-blue-100 px-2 py-1 rounded-full">
                              ç”»åƒä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆ
                            </div>
                          </div>                  <p class="text-blue-900 leading-relaxed"><%= comment.body %></p>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="text-center py-8 text-blue-500">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <span class="text-xl">ğŸ“</span>
              </div>
              <p class="text-sm">ç”»åƒä¸Šã®ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
              <p class="text-xs text-blue-400">ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™</p>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- ç”»åƒã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã‚Œãªã„å ´åˆã®èª¬æ˜ -->
        <div class="text-center py-8 text-blue-500 border border-blue-200 rounded-lg bg-blue-50">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h4 class="text-sm font-semibold text-blue-700 mb-2">ã‚³ãƒ¡ãƒ³ãƒˆå‚åŠ å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</h4>
          <p class="text-xs text-blue-500">
            ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã‹ã€æŠ•ç¥¨ã‚’ã™ã‚‹ã¨ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ãŒè¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
          </p>
        </div>
      <% end %>
    </div>

    <!-- é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <span>ğŸ’¬</span>
          ã‚³ãƒ¡ãƒ³ãƒˆ
        </h4>
        <span class="text-sm text-gray-500"><%= @post.comments.where(parent_id: nil, x_position: nil, y_position: nil).count + @vote_comments.count %>ä»¶</span>
      </div>

      <% if user_can_view_comments?(current_user, @post) %>
        <div class="space-y-4">
          <%
            # é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨æŠ•ç¥¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—ã§ã¾ã¨ã‚ã‚‹ï¼ˆæ–°ã—ã„é †ï¼‰
            regular_comments = @post.comments.where(parent_id: nil, x_position: nil, y_position: nil)
            all_comments = (regular_comments + @vote_comments).sort_by(&:created_at).reverse
          %>
          <% all_comments.each do |item| %>
            <% if item.is_a?(Comment) %>
              <!-- é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ -->
              <%= render 'comments/comment', comment: item %>

              <!-- è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆ -->
              <% if item.replies.any? %>
                <div class="ml-8 mt-3 space-y-3">
                  <% item.replies.each do |reply| %>
                    <div class="bg-gray-50 rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-shadow p-3">
                      <%= render 'comments/comment', comment: reply %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <!-- æŠ•ç¥¨ã‚³ãƒ¡ãƒ³ãƒˆ -->
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 shadow-sm hover:shadow-md transition-shadow p-4">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                      <span class="text-sm font-medium text-blue-600">
                        <%= (item.user&.name || "åŒ¿å")[0] %>
                      </span>
                    </div>
                    <div>
                      <span class="font-medium text-gray-900"><%= item.user&.name || "åŒ¿å" %></span>
                      <span class="text-xs text-gray-500 ml-2"><%= time_ago_in_words(item.created_at) %>å‰</span>
                      <span class="ml-2 px-2 py-1 text-xs rounded-full <%= item.value == 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                        <%= item.value == 1 ? 'ğŸ‘ è©•ä¾¡' : 'ğŸ‘ è©•ä¾¡' %>
                      </span>
                    </div>
                  </div>
                </div>
                <p class="text-gray-700 leading-relaxed"><%= item.comment %></p>
              </div>
            <% end %>
          <% end %>

          <% if all_comments.empty? %>
            <div class="text-center py-8 text-gray-500">
              <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <span class="text-xl">ğŸ’¬</span>
              </div>
              <p class="text-sm">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
              <p class="text-xs text-gray-400">å³ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™</p>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã‚Œãªã„å ´åˆã®èª¬æ˜ -->
        <div class="text-center py-8 text-gray-500 border border-gray-200 rounded-lg bg-gray-50">
          <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">ã‚³ãƒ¡ãƒ³ãƒˆå‚åŠ å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</h4>
          <p class="text-xs text-gray-500">
            ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã‹ã€æŠ•ç¥¨ã‚’ã™ã‚‹ã¨ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ãŒè¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
          </p>
        </div>
      <% end %>
    </div>

  </div>
</div>

<!-- å›ºå®šã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰ -->
<% if user_signed_in? %>
  <div class="fixed bottom-0 right-0 bg-white border-t-2 border-l-2 border-gray-200 shadow-2xl z-50 rounded-tl-lg" id="comment-form-bar" style="width: 400px; max-width: 90vw;">
    <div class="px-4 py-3">
      <div class="flex flex-col gap-3">
        <!-- ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
        <button type="button" id="toggle-comment-form"
                class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 w-full text-sm">
          <span>ğŸ’¬</span>
          <span id="toggle-text">é–‰ã˜ã‚‹</span>
        </button>
        
        <!-- å±•é–‹ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="comment-form-container" class="" data-comment-form-target="form">
          <%= form_with model: [@post, @comment], local: true, class: "flex flex-col gap-3 w-full", data: { controller: "comment-form" } do |f| %>
            <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆç”¨ï¼‰ -->
            <%= f.hidden_field :x_position, data: { "comment-form-target": "xPosition" } %>
            <%= f.hidden_field :y_position, data: { "comment-form-target": "yPosition" } %>
            
            <!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div>
              <%= f.text_area :body,
                  rows: 3,
                  placeholder: "ç”»åƒã‚’è¦‹ãªãŒã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†...",
                  class: "w-full p-3 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 resize-none",
                  data: { "comment-form-target": "textarea" } %>
            </div>
            
            <!-- ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆçŠ¶æ…‹è¡¨ç¤º -->
            <div id="pin-comment-status" class="hidden bg-blue-50 border border-blue-200 rounded p-2 text-xs text-blue-700">
              ğŸ“ ç”»åƒã®æŒ‡å®šä½ç½®ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã™
            </div>
            
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã¨é€ä¿¡ãƒœã‚¿ãƒ³ -->
            <div class="flex items-center gap-2">
              <%= f.file_field :attachments,
                  multiple: true,
                  class: "hidden",
                  id: "file-input",
                  accept: "image/*,video/*,audio/*",
                  onchange: "handleFileSelection(this)" %>
              <label for="file-input" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg cursor-pointer transition-colors flex-shrink-0">
                ğŸ“
              </label>

              <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
              <%= f.submit "é€ä¿¡",
                  class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm flex-1" %>
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div id="file-preview" class="hidden mt-2 p-2 bg-gray-50 rounded border">
              <div class="flex items-center justify-between">
                <span id="file-info" class="text-xs text-gray-600"></span>
                <button type="button" onclick="clearFileSelection()" class="text-red-600 hover:text-red-800 text-xs">å‰Šé™¤</button>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ä½™ç™½è¿½åŠ ï¼ˆå›ºå®šãƒ•ã‚©ãƒ¼ãƒ ã®ãŸã‚ï¼‰ -->
  <div class="h-20"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleButton = document.getElementById('toggle-comment-form');
      const formContainer = document.getElementById('comment-form-container');
      const toggleText = document.getElementById('toggle-text');
      
      if (toggleButton && formContainer && toggleText) {
        
        toggleButton.addEventListener('click', function() {
          const isVisible = !formContainer.classList.contains('hidden');
          
          if (isVisible) {
            formContainer.classList.add('hidden');
            toggleText.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã';
            toggleButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            toggleButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
          } else {
            formContainer.classList.remove('hidden');
            toggleText.textContent = 'é–‰ã˜ã‚‹';
            toggleButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
            toggleButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            const textarea = formContainer.querySelector('textarea');
            if (textarea) {
              setTimeout(() => textarea.focus(), 100);
            }
          }
        });
      }
      
      // ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®ã‚µãƒãƒ¼ãƒˆ
      window.updatePinCommentStatus = function(x, y) {
        const statusDiv = document.getElementById('pin-comment-status');
        const xField = document.querySelector('[data-comment-form-target="xPosition"]');
        const yField = document.querySelector('[data-comment-form-target="yPosition"]');
        
        if (x && y && statusDiv) {
          statusDiv.classList.remove('hidden');
          statusDiv.innerHTML = `ğŸ“ ç”»åƒã®ä½ç½® (${x}%, ${y}%) ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã™`;
        } else if (statusDiv) {
          statusDiv.classList.add('hidden');
        }
      };
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆæ™‚ã«ãƒ”ãƒ³çŠ¶æ…‹ã‚‚ã‚¯ãƒªã‚¢
      window.clearPinCommentStatus = function() {
        const statusDiv = document.getElementById('pin-comment-status');
        if (statusDiv) {
          statusDiv.classList.add('hidden');
        }
      };

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
      window.handleFileSelection = function(input) {
        const filePreview = document.getElementById('file-preview');
        const fileInfo = document.getElementById('file-info');

        if (input.files && input.files.length > 0) {
          const files = Array.from(input.files);
          const fileNames = files.map(file => file.name).join(', ');
          const totalSize = files.reduce((sum, file) => sum + file.size, 0);
          const sizeText = totalSize > 1024 * 1024 ?
            `${(totalSize / (1024 * 1024)).toFixed(1)}MB` :
            `${(totalSize / 1024).toFixed(1)}KB`;

          fileInfo.textContent = `${files.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¸ˆã¿ (${sizeText}): ${fileNames}`;
          filePreview.classList.remove('hidden');
        } else {
          filePreview.classList.add('hidden');
        }
      };

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¯ãƒªã‚¢
      window.clearFileSelection = function() {
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');

        if (fileInput) {
          fileInput.value = '';
        }
        if (filePreview) {
          filePreview.classList.add('hidden');
        }
      };
    });

    // ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¥¨æ©Ÿèƒ½
    window.testVoteComment = function(commentId, value) {
      console.log('ğŸ”¥ testVoteComment called:', commentId, value);

      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      console.log('ğŸ”¥ CSRF Token:', csrfToken);

      const formData = new FormData();
      formData.append('votable_type', 'Comment');
      formData.append('votable_id', commentId);
      formData.append('value', value);

      fetch('/vote', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        body: formData
      })
      .then(response => {
        console.log('ğŸ”¥ Test vote response:', response.status, response.statusText);
        return response.json();
      })
      .then(data => {
        console.log('ğŸ”¥ Test vote data:', data);
        if (data.success) {
          // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦çµæœã‚’ç¢ºèª
          location.reload();
        }
      })
      .catch(error => {
        console.error('ğŸ”¥ Test vote error:', error);
      });
    };

    // ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    window.toggleHeart = function(commentId) {
      fetch('/toggle_heart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ comment_id: commentId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const heartIcon = document.getElementById(`heart-icon-${commentId}`);
          const heartText = document.getElementById(`heart-text-${commentId}`);
          const heartBtn = document.getElementById(`heart-btn-${commentId}`);

          // ãƒãƒ¼ãƒˆè¡¨ç¤ºã®æ›´æ–°
          const heartCount = document.getElementById(`heart-count-${commentId}`);

          if (data.hearted) {
            heartIcon.textContent = 'â¤ï¸';
            heartText.textContent = 'ãƒãƒ¼ãƒˆæ¸ˆã¿';
            heartBtn.classList.remove('text-gray-400', 'hover:text-pink-500');
            heartBtn.classList.add('text-pink-500');
          } else {
            heartIcon.textContent = 'ğŸ¤';
            heartText.textContent = 'ãƒãƒ¼ãƒˆ';
            heartBtn.classList.remove('text-pink-500');
            heartBtn.classList.add('text-gray-400', 'hover:text-pink-500');
          }

          // ãƒãƒ¼ãƒˆæ•°ã®æ›´æ–°
          if (heartCount) {
            heartCount.textContent = `(${data.heart_count})`;
          }

          // æŠ•ç¥¨è¡¨ç¤ºã®æ›´æ–°ï¼ˆæŠ•ç¥¨ãŒè¿½åŠ ã¾ãŸã¯å‰Šé™¤ã•ã‚ŒãŸå ´åˆï¼‰
          if (data.vote_updated) {
            // Stimulusã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯æŠ•ç¥¨è¡¨ç¤ºã‚’æ›´æ–°
            const commentElement = heartBtn.closest('[data-controller*="comment-vote"]');
            if (commentElement) {
              const controller = commentElement.commentVoteController || window.testCommentVote;
              if (controller && controller.updateDisplay) {
                controller.upCountValue = data.up_count;
                controller.downCountValue = data.down_count;
                controller.userVoteValue = data.user_vote;
                controller.updateDisplay();
                controller.updateButtonStyles();
              }
            }

            // ã‚ˆã‚Šç›´æ¥çš„ãªæ›´æ–°æ–¹æ³•ã‚‚è©¦ã™
            const voteCountElement = commentElement?.querySelector('[data-comment-vote-target="voteCount"]');
            if (voteCountElement) {
              const netVotes = data.up_count - data.down_count;
              voteCountElement.textContent = netVotes >= 0 ? `+${netVotes}` : netVotes;
            }

            // æŠ•ç¥¨ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚ç›´æ¥æ›´æ–°
            const upButton = commentElement?.querySelector('[data-comment-vote-target="upButton"]');
            const downButton = commentElement?.querySelector('[data-comment-vote-target="downButton"]');

            if (upButton && downButton) {
              // ãƒªã‚»ãƒƒãƒˆ
              upButton.className = upButton.className.replace(/text-white bg-green-500 shadow-lg scale-110 border-2 border-green-400/, 'text-gray-400 hover:text-green-500 border border-gray-300');
              downButton.className = downButton.className.replace(/text-white bg-red-500 shadow-lg scale-110 border-2 border-red-400/, 'text-gray-400 hover:text-red-500 border border-gray-300');

              // ç¾åœ¨ã®æŠ•ç¥¨çŠ¶æ…‹ã«å¿œã˜ã¦æ›´æ–°
              if (data.user_vote === 1) {
                upButton.className = upButton.className.replace(/text-gray-400 hover:text-green-500 border border-gray-300/, 'text-white bg-green-500 shadow-lg scale-110 border-2 border-green-400');
              } else if (data.user_vote === -1) {
                downButton.className = downButton.className.replace(/text-gray-400 hover:text-red-500 border border-gray-300/, 'text-white bg-red-500 shadow-lg scale-110 border-2 border-red-400');
              }
            }

            if (data.hearted) {
              console.log('ãƒãƒ¼ãƒˆã¨åŒæ™‚ã«ãƒ—ãƒ©ã‚¹æŠ•ç¥¨ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ');
            } else {
              console.log('ãƒãƒ¼ãƒˆã¨åŒæ™‚ã«æŠ•ç¥¨ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
            }
          }
        } else {
          console.error('ãƒãƒ¼ãƒˆã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—:', data.error);
        }
      })
      .catch(error => {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
      });
    };

    // ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ©Ÿèƒ½ï¼ˆç´”ç²‹ãªJavaScriptï¼‰
    (function() {
      let overlayElement = null;
      let savedScrollY = 0;
      let isScrollLocked = false;

      // ç”»åƒã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
      document.addEventListener('DOMContentLoaded', () => {
        const imageContainers = document.querySelectorAll('[data-controller="image-comments"]');

        imageContainers.forEach(container => {
          const image = container.querySelector('[data-image-comments-target="image"]');
          if (!image) return;

          // ç”»åƒã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆï¼ˆStimulusãŒãƒ”ãƒ³ã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‡¦ç†ï¼‰
          image.addEventListener('click', (e) => {

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç”»åƒã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆStimulusã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«ä»»ã›ã‚‹ï¼‰
            if (container.closest('#imageModal')) {
              return;
            }

            // âœ… æ—¢ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä½œã‚Šç›´ã•ãªã„ï¼ˆãƒ”ãƒ³ç§»å‹•ã®ãŸã‚ï¼‰
            if (overlayElement && document.body.contains(overlayElement)) {
              return;
            }

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆï¼ˆStimulusã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãŒãƒ”ãƒ³ã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ï¼‰
            createOverlay(container);

          }, true); // capture phase ã§å…ˆã«å®Ÿè¡Œ
        });
      });

      function createOverlay(imageContainer) {
        // âœ… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤ã™ã‚‹å‰ã«ï¼ï¼‰
        if (document.body.style.position !== 'fixed') {
          savedScrollY = window.scrollY;
        }

        // æ—¢å­˜ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤
        removeOverlay();

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
        overlayElement = document.createElement('div');
        overlayElement.id = 'pin-comment-overlay-inline';
        overlayElement.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 9997;
          cursor: pointer;
        `;

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹ï¼ˆç”»åƒã‚³ãƒ³ãƒ†ãƒŠå¤–ã®ã‚¯ãƒªãƒƒã‚¯ã®ã¿ï¼‰
        overlayElement.addEventListener('click', (e) => {

          // âœ… ç”»åƒã‚³ãƒ³ãƒ†ãƒŠå†…ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ”ãƒ³æ“ä½œã®ãŸã‚ï¼‰
          const clickedInContainer = e.target.closest('[data-controller="image-comments"]');
          if (clickedInContainer) {
            return;
          }

          removeOverlay();
          // Stimulusã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®hideFormãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å‘¼ã³å‡ºã™
          const controller = imageContainer.imageCommentsController;
          if (controller && typeof controller.hideForm === 'function') {
            controller.hideForm();
          }
        });

        // bodyã«è¿½åŠ 
        document.body.appendChild(overlayElement);

        // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ç¾åœ¨ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’å–å¾—
        const containerRect = imageContainer.getBoundingClientRect();

        // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã‚’fixed positionã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä¸Šã«è¡¨ç¤º
        imageContainer.style.position = 'fixed';
        imageContainer.style.top = containerRect.top + 'px';
        imageContainer.style.left = containerRect.left + 'px';
        imageContainer.style.width = containerRect.width + 'px';
        imageContainer.style.height = containerRect.height + 'px';
        imageContainer.style.zIndex = '9998';

        // âœ… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯ï¼ˆã¾ã ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
        if (document.body.style.position !== 'fixed') {
          document.body.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.top = `-${savedScrollY}px`;
          document.body.style.width = '100%';
        }

      }

      function removeOverlay() {
        if (overlayElement) {
          overlayElement.remove();
          overlayElement = null;
        }

        // âœ… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è§£é™¤å‡¦ç†ã‚’å¾©å…ƒ
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        isScrollLocked = false;

        // âœ… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒï¼ˆæœ‰åŠ¹ãªå€¤ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        if (savedScrollY !== undefined && savedScrollY !== null && savedScrollY > 0) {
          window.scrollTo(0, savedScrollY);
        }

        // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        const imageContainers = document.querySelectorAll('[data-controller="image-comments"]');
        imageContainers.forEach(container => {
          container.style.position = '';
          container.style.top = '';
          container.style.left = '';
          container.style.width = '';
          container.style.height = '';
          container.style.zIndex = '';
        });

      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆç”»åƒæ‹¡å¤§æ©Ÿèƒ½ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ï¼‰
      window.removePinCommentOverlay = removeOverlay;

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
      window.createPinOverlay = createOverlay;
      window.removePinOverlay = removeOverlay;
    })();

    // ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½
    (function() {
      document.addEventListener('DOMContentLoaded', () => {
        setupTextareaAutoResize();
      });

      // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚ã«ã‚‚è¨­å®šï¼ˆStimulus ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰å‘¼ã°ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === 1) { // Element node
              const textareas = node.querySelectorAll ? node.querySelectorAll('textarea[data-action*="image-comments"]') : [];
              textareas.forEach(setupAutoResize);
            }
          });
        });
      });

      observer.observe(document.body, { childList: true, subtree: true });

      function setupTextareaAutoResize() {
        const textareas = document.querySelectorAll('textarea[data-action*="image-comments"]');
        textareas.forEach(setupAutoResize);
      }

      function setupAutoResize(textarea) {
        if (textarea.dataset.autoResizeSetup) return; // æ—¢ã«è¨­å®šæ¸ˆã¿
        textarea.dataset.autoResizeSetup = 'true';

        // åˆæœŸã®é«˜ã•ã‚’è¨­å®š
        textarea.style.minHeight = '24px';
        textarea.style.maxHeight = '150px';
        textarea.style.overflowY = 'hidden';

        function resize() {
          // ä¸€æ—¦é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆ
          textarea.style.height = 'auto';
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´
          const newHeight = Math.min(textarea.scrollHeight, 150);
          textarea.style.height = newHeight + 'px';

          // æœ€å¤§é«˜ã•ã‚’è¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹
          if (textarea.scrollHeight > 150) {
            textarea.style.overflowY = 'auto';
          } else {
            textarea.style.overflowY = 'hidden';
          }
        }

        // input ã‚¤ãƒ™ãƒ³ãƒˆã§è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        textarea.addEventListener('input', resize);
        // åˆæœŸè¡¨ç¤ºæ™‚ã‚‚ãƒªã‚µã‚¤ã‚º
        resize();

        console.log('ğŸŸ¢ Auto-resize setup for textarea');
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      window.setupTextareaAutoResize = setupTextareaAutoResize;
    })();
  </script>
<% end %>
