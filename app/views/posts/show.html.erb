<!-- 2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà -->
<div class="mt-4 px-4">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Â∑¶ÂÅ¥: ÊäïÁ®øË°®Á§∫„Ç®„É™„Ç¢ÔºàÁ¥Ñ70%Ôºâ -->
    <div class="lg:col-span-2">
      <% if @is_private_view %>
        <!-- ÈùûÂÖ¨ÈñãÊäïÁ®øË°®Á§∫„Éê„Éä„Éº -->
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-sm font-semibold text-amber-800">ÈôêÂÆöÂÖ¨ÈñãÊäïÁ®ø</h3>
              <p class="text-xs text-amber-600 mt-1">
                „Åì„ÅÆÊäïÁ®ø„ÅØ<strong><%= @post.user.name %></strong>„Åï„Çì„Åã„ÇâÁõ¥Êé•ÂÖ±Êúâ„Åï„Çå„ÅüÈùûÂÖ¨Èñã„ÅÆ‰ΩúÂìÅ„Åß„Åô„ÄÇ„ÅÇ„Å™„Åü„Å†„Åë„ÅåÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇ
              </p>
            </div>
          </div>
        </div>
      <% end %>
      
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <h1 class="text-lg font-bold mb-2 text-gray-900 flex items-center gap-2">
          <%= @post.title %>
          <% if @post.is_private? %>
            <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-medium">üîí „Éó„É©„Ç§„Éô„Éº„Éà</span>
            <% if user_signed_in? && @post.user != current_user %>
              <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">üì® Âèó‰ø°Ê∏à„Åø</span>
            <% end %>
          <% end %>
        </h1>
        
        <div class="flex items-center gap-2 mb-2 text-sm">
          <span class="font-medium text-gray-600">ÊäïÁ®øËÄÖ:</span>
          <%= link_to @post.user.name, user_path(@post.user), class: "text-blue-500 hover:underline" %>
        </div>

        <p class="mb-3 text-sm text-gray-600 leading-relaxed"><%= @post.body %></p>

        <% if @post.request_tag.present? %>
          <p class="mb-2">
            <span class="font-medium text-gray-500 text-xs">„É™„ÇØ„Ç®„Çπ„Éà:</span>
            <span class="bg-green-50 text-green-500 px-2 py-1 rounded-full text-xs"><%= @post.request_tag %></span>
          </p>
        <% end %>

        <!-- ÁîªÂÉèË°®Á§∫„Ç®„É™„Ç¢ -->
        <% if @post.images.attached? %>
          <div class="space-y-4 flex flex-col items-center">
            <% @post.images.each_with_index do |image, index| %>
              <div class="relative" data-controller="image-comments" data-image-comments-post-id-value="<%= @post.id %>">
                <%= image_tag image, class: "w-full max-w-md rounded-lg cursor-pointer shadow mx-auto", data: { "image-comments-target": "image" } %>
                
                <!-- ÁîªÂÉè‰∏ä„ÅÆ„Ç≥„É°„É≥„Éà„Éû„Éº„Ç´„ÉºË°®Á§∫„Ç®„É™„Ç¢ -->
                <div class="absolute inset-0 pointer-events-none" data-image-comments-target="markersContainer"></div>
                
                <!-- ÁîªÂÉè‰∏ä„Ç≥„É°„É≥„ÉàÁî®„ÅÆ„Éï„Ç©„Éº„É†ÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ -->
                <div class="hidden absolute z-50 bg-white border border-gray-300 rounded p-2 shadow-lg" data-image-comments-target="form">
                  <%= form_with model: [@post, Comment.new], local: false, data: { "image-comments-target": "commentForm", action: "submit->image-comments#submitComment" } do |f| %>
                    <%= f.hidden_field :x_position %>
                    <%= f.hidden_field :y_position %>
                    <%= f.text_area :body, rows: 2, placeholder: "„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ...", class: "w-40 p-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500", required: true %>
                    <div class="mt-1 flex gap-1">
                      <%= f.submit "„Ç≥„É°„É≥„Éà", class: "bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 text-xs" %>
                      <button type="button" data-action="click->image-comments#hideForm" class="bg-gray-300 text-gray-700 px-2 py-1 rounded hover:bg-gray-400 text-xs">√ó</button>
                    </div>
                  <% end %>
                </div>
                
                <!-- „Éû„Éº„Ç´„ÉºË°®Á§∫Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ -->
                <div class="mt-2 flex items-center gap-2">
                  <button type="button" 
                          data-action="click->image-comments#toggleMarkers" 
                          data-image-comments-target="toggleButton"
                          class="flex items-center gap-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                    <span data-image-comments-target="toggleIcon">üëÅÔ∏è</span>
                    <span data-image-comments-target="toggleText">„Éî„É≥Ë°®Á§∫</span>
                  </button>
                  <span data-image-comments-target="markerCount" class="text-xs text-gray-500"></span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if @post.present? && @post.videos.attached? %>
          <div class="mb-4">
            <% @post.videos.each_with_index do |video, index| %>
              <div class="bg-gray-900 rounded-xl overflow-hidden shadow-lg mb-4">
                <video class="custom-video no-context-menu w-full max-w-md" 
                       controls 
                       controlsList="nodownload noremoteplayback"
                       oncontextmenu="return false;"
                       preload="metadata"
                       style="outline: none;">
                  <source src="<%= url_for(video) %>" type="video/mp4">
                  „Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ video „Çø„Ç∞„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                </video>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if @post.present? && @post.audios.attached? %>
          <div class="mb-4">
            <% @post.audios.each_with_index do |audio, index| %>
              <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-xl p-3 mb-3 border border-purple-200">
                <audio class="custom-audio no-context-menu w-full" 
                       controls 
                       controlsList="nodownload noremoteplayback"
                       oncontextmenu="return false;"
                       preload="metadata"
                       style="outline: none;">
                  <source src="<%= url_for(audio) %>" type="audio/mpeg">
                  <source src="<%= url_for(audio) %>" type="audio/wav">
                  <source src="<%= url_for(audio) %>" type="audio/ogg">
                  „Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ audio „Çø„Ç∞„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                </audio>
              </div>
            <% end %>
          </div>
        <% end %>

        <p class="mb-4">
          <span class="font-semibold text-gray-600">„Çø„Ç∞:</span>
          <span class="bg-blue-50 text-blue-500 px-2 py-1 rounded-full text-sm"><%= @post.tag %></span>
        </p>

        <!-- ÊäïÁ•®„Éú„Çø„É≥ÔºàAJAXÔºãÂâ≤Âêà„Éê„ÉºÔºâ -->
        <div class="flex items-center justify-end gap-4 mt-6 border-t pt-4">
          
          <!-- ‰∏ÄÊôÇÁöÑ„Å´ÈùôÁöÑ„Å™Ë°®Á§∫„Å´„Åó„Å¶„ÄÅÂü∫Êú¨ÁöÑ„Å™ÊäïÁ•®Ê©üËÉΩ„ÇíÂãï„Åã„Åô -->
          <% up_count = @post.votes.where(value: 1).count %>
          <% down_count = @post.votes.where(value: -1).count %>
          <% user_vote = current_user ? (@post.votes.find_by(user: current_user)&.value || 0) : 0 %>
          <% total_votes = up_count + down_count %>
          <% net_score = up_count - down_count %>
          
          <!-- „Éó„É©„ÇπÊäïÁ•®„Éú„Çø„É≥ -->
          <% if user_vote == 0 %>
            <button type="button" 
                    class="text-gray-500 hover:text-green-600"
                    onclick="showVoteModal(1, <%= @post.id %>)">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% else %>
            <button type="button" 
                    class="<%= user_vote == 1 ? 'text-green-600 bg-green-100 rounded px-2 py-1 font-bold' : 'text-gray-400' %>"
                    disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% end %>
          
          <div class="relative w-36 h-6 bg-gray-300 rounded overflow-hidden">
            <% if user_vote == 0 %>
              <!-- Êú™ÊäïÁ•®„ÅÆÂ†¥ÂêàÔºö„Ç∞„É¨„Éº„ÅÆ„Éê„Éº -->
              <div class="absolute inset-0 flex items-center justify-center text-xs text-gray-700 font-semibold select-none">
                <%= total_votes %>
              </div>
            <% else %>
              <!-- ÊäïÁ•®Ê∏à„Åø„ÅÆÂ†¥ÂêàÔºö„Ç´„É©„Éï„É´„Å™„Éê„Éº„Å®ÂÜÖË®≥Ë°®Á§∫ -->
              <div class="absolute inset-0 flex">
                <% if total_votes > 0 %>
                  <% up_percentage = (up_count.to_f / total_votes * 100).round(1) %>
                  <% down_percentage = (down_count.to_f / total_votes * 100).round(1) %>
                  
                  <!-- „Éó„É©„ÇπÁ•®„ÅÆ„Éê„Éº -->
                  <div class="h-full bg-green-500 relative flex items-center justify-center" style="width: <%= up_percentage %>%">
                    <% if up_count > 0 %>
                      <span class="text-xs text-white font-bold"><%= up_count %></span>
                    <% end %>
                  </div>
                  
                  <!-- „Éû„Ç§„Éä„ÇπÁ•®„ÅÆ„Éê„Éº -->
                  <div class="h-full bg-red-500 relative flex items-center justify-center" style="width: <%= down_percentage %>%">
                    <% if down_count > 0 %>
                      <span class="text-xs text-white font-bold"><%= down_count %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <!-- „Éû„Ç§„Éä„ÇπÊäïÁ•®„Éú„Çø„É≥ -->
          <% if user_vote == 0 %>
            <button type="button" 
                    class="text-gray-500 hover:text-red-600"
                    onclick="showVoteModal(-1, <%= @post.id %>)">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% else %>
            <button type="button" 
                    class="<%= user_vote == -1 ? 'text-red-600 bg-red-100 rounded px-2 py-1 font-bold' : 'text-gray-400' %>"
                    disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- AI„Çµ„Ç§„Éâ„Éê„ÉºÔºàÂè≥ÂÅ¥Ôºâ -->
    <div class="lg:col-span-1">
      <div class="bg-gradient-to-br from-purple-100 to-indigo-200 border-2 border-purple-300 rounded-2xl shadow-lg p-4 sticky top-4" data-controller="ai-sidebar" data-ai-sidebar-post-id-value="<%= @post.id %>">
        <!-- AIË£úÂä©„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="flex items-center justify-center gap-2 mb-4">
          <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
            <span class="text-white text-xs font-bold">AI</span>
          </div>
          <h2 class="text-sm font-bold text-gray-900">„Ç≥„É°„É≥„ÉàË£úÂä©</h2>
        </div>
          
          <!-- ÂàùÊúüÁä∂ÊÖã„ÅÆË™¨Êòé -->
          <div data-ai-sidebar-target="initialMessage" class="text-center py-4">
            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <span class="text-lg">ü§ñ</span>
            </div>
            <h3 class="text-sm font-semibold text-gray-800 mb-2">AI„Ç≥„É°„É≥„ÉàË£úÂä©</h3>
            <p class="text-xs text-gray-600 mb-4">
              AI„Åå„Ç≥„É°„É≥„Éà‰ΩúÊàê„Çí„Çµ„Éù„Éº„Éà
            </p>
            
            <!-- AIËµ∑Âãï„Éú„Çø„É≥ -->
            <button type="button" 
                    data-action="click->ai-sidebar#toggleAI"
                    data-ai-sidebar-target="toggleButton"
                    class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-sm font-bold rounded-lg shadow-md hover:from-purple-700 hover:to-indigo-700 transition-all transform hover:scale-105 flex items-center gap-2 mx-auto">
              <span data-ai-sidebar-target="toggleIcon">ü§ñ</span>
              <span data-ai-sidebar-target="toggleText">ÈñãÂßã</span>
            </button>
          </div>
          
          <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
          <div data-ai-sidebar-target="loading" class="hidden text-center py-4">
            <div class="w-8 h-8 border-2 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-xs text-gray-600">AIÂàÜÊûê‰∏≠...</p>
          </div>
          
          <!-- AIË£úÂä©„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ -->
          <div data-ai-sidebar-target="aiContent" class="hidden space-y-3">
            
            <!-- Ë™ûÂΩô„ÉªË°®Áèæ„ÅÆË£úÂä© -->
            <div class="bg-gradient-to-br from-emerald-50 to-teal-100 rounded-lg p-4 border-2 border-emerald-200">
              <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                <div class="w-6 h-6 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full flex items-center justify-center">
                  <span class="text-white text-xs">üìù</span>
                </div>
                Ë™ûÂΩô„ÉªË°®Áèæ„ÅÆË£úÂä©
              </h3>
              <div data-ai-sidebar-target="vocabularies" class="flex flex-wrap gap-2">
                <!-- Ë™ûÂΩô„Ç≠„Éº„ÉØ„Éº„Éâ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
              </div>
              <div class="mt-3 pt-3 border-t border-emerald-200">
                <p class="text-xs text-emerald-600 italic text-center">
                  üí° „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Ç≥„É°„É≥„ÉàÊ¨Ñ„Å´ÊåøÂÖ•„Åß„Åç„Åæ„Åô
                </p>
              </div>
            </div>
            
            <!-- AIÂàÜÊûêÁµêÊûú -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-100 rounded-lg p-4 border-2 border-purple-200">
              <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
                  <span class="text-white text-xs">üîç</span>
                </div>
                AIÂàÜÊûê„Éù„Ç§„É≥„Éà
              </h3>
              <div data-ai-sidebar-target="summary" class="space-y-2">
                <!-- AIÁîªÂÉèË™çË≠ò„ÉªÂàÜÊûêÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
              </div>
              <div class="mt-3 pt-3 border-t border-purple-200">
                <p class="text-xs text-purple-600 italic text-center">
                  <% if @post.images.attached? %>
                    üì∏ ÁîªÂÉè„ÇíÂàÜÊûê„Åó„Å¶„Ç≥„É°„É≥„Éà„ÅÆ„Éí„É≥„Éà„ÇíÊèê‰æõ„Åó„Åæ„Åô
                  <% else %>
                    üìù ÊäïÁ®øÂÜÖÂÆπ„ÇíÂàÜÊûê„Åó„Å¶„Ç≥„É°„É≥„Éà„ÅÆ„Éí„É≥„Éà„ÇíÊèê‰æõ„Åó„Åæ„Åô
                  <% end %>
                </p>
              </div>
            </div>
            
            <!-- Èñâ„Åò„Çã„Éú„Çø„É≥ -->
            <div class="text-center pt-1">
              <button type="button" 
                      data-action="click->ai-sidebar#closeAI"
                      class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                Èñâ„Åò„Çã
              </button>
            </div>
          </div>
      </div>
    </div>
    
  </div>
</div>

<!-- ÊäïÁ•®„Ç≥„É°„É≥„Éà„É¢„Éº„ÉÄ„É´ -->
<div id="voteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div id="voteModalContent" class="bg-white rounded-lg p-4 max-w-6xl w-full mx-4 shadow-xl max-h-[95vh] overflow-y-auto">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">Ë©ï‰æ°ÁêÜÁî±„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ</h3>
    
    <!-- 2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„ÉàÔºàÂãïÁöÑ„Å´Â§âÊõ¥Ôºâ -->
    <div id="modalLayout" class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3">
      
      <!-- Â∑¶ÂÅ¥: ÊäïÁ®øÂÜÖÂÆπË°®Á§∫ -->
      <div id="postContent" class="lg:col-span-2 space-y-4">
        <!-- ÊäïÁ®øÂÜÖÂÆπË°®Á§∫„Ç®„É™„Ç¢ -->
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <span>üìù</span>
            <%= @post.title %>
          </h4>
          <div class="text-base text-gray-800">
            
            <!-- ÁîªÂÉèË°®Á§∫ -->
            <% if @post.images.attached? %>
              <div class="mb-4">
                <% if @post.images.count == 1 %>
                  <%= image_tag @post.images.first, class: "w-full max-h-80 object-contain rounded border shadow-md cursor-pointer hover:opacity-90 transition-opacity", onclick: "showImageModal('#{url_for(@post.images.first)}')", id: "primaryImage", onload: "checkImageAspectRatio(this)" %>
                <% else %>
                  <div class="grid grid-cols-1 gap-3">
                    <% @post.images.limit(2).each_with_index do |image, index| %>
                      <%= image_tag image, class: "w-full max-h-64 object-contain rounded border shadow-sm cursor-pointer hover:opacity-90 transition-opacity", onclick: "showImageModal('#{url_for(image)}')", id: "image_#{index}", onload: index == 0 ? "checkImageAspectRatio(this)" : "" %>
                    <% end %>
                    <% if @post.images.count > 2 %>
                      <div class="w-full h-64 bg-gray-200 rounded border flex items-center justify-center">
                        <span class="text-base text-gray-600">+<%= @post.images.count - 2 %>Êûö</span>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
            
            <p class="text-gray-700 mb-4 leading-relaxed text-base"><%= @post.body %></p>
            <% if @post.tag.present? %>
              <div class="flex flex-wrap gap-2">
                <% @post.tag.split(',').each do |tag| %>
                  <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full font-medium"><%= tag.strip %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Âè≥ÂÅ¥: AIË£úÂä© -->
      <div id="aiContent" class="lg:col-span-1 space-y-4">
        <!-- AI„Ç≥„É°„É≥„ÉàË£úÂä©„Ç®„É™„Ç¢ -->
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-3 border border-purple-100 min-h-[180px] flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-gray-800 flex items-center gap-1">
              <div class="w-4 h-4 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
                <span class="text-white text-xs font-bold">AI</span>
              </div>
              „Ç≥„É°„É≥„ÉàË£úÂä©
            </h4>
            <button type="button" 
                    onclick="toggleVoteModalAI()"
                    id="voteModalAIToggle"
                    class="px-2 py-1 bg-purple-600 text-white text-xs font-medium rounded hover:bg-purple-700 transition-colors flex items-center gap-1">
              <span>ü§ñ</span>
              <span>ÈñãÂßã</span>
            </button>
          </div>
          
          <!-- ÂàùÊúüÁä∂ÊÖã„ÅÆË™¨Êòé -->
          <div id="voteModalAIInitial" class="text-center py-2">
            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-1">
              <span class="text-xs">ü§ñ</span>
            </div>
            <p class="text-xs text-gray-600">
              AI„Åå„Ç≥„É°„É≥„Éà‰ΩúÊàê„Çí„Çµ„Éù„Éº„Éà
            </p>
          </div>
          
          <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
          <div id="voteModalAILoading" class="hidden text-center py-2">
            <div class="w-5 h-5 border-2 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-1"></div>
            <p class="text-xs text-gray-600">AIÂàÜÊûê‰∏≠...</p>
          </div>
          
          <!-- AIË£úÂä©„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
          <div id="voteModalAIContent" class="hidden space-y-3 flex-1">
            
          </div>
        </div>
      </div>
    </div>

    <!-- ‰∏ãÈÉ®: „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Ç®„É™„Ç¢Ôºà‰ΩçÁΩÆ„ÅØÂãïÁöÑ„Å´Â§âÊõ¥Ôºâ -->
    <div id="commentSection" class="border-t pt-4">
      <p id="modalMessage" class="text-base text-gray-700 mb-4 text-center font-medium">
        „Å™„Åú„Åù„ÅÜÊÄù„Å£„Åü„ÅÆ„Åã„ÇíÊõ∏„ÅÑ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
      </p>

      <!-- „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
      <%= form_with url: vote_path, method: :post, local: true, id: "voteForm", class: "space-y-4", onsubmit: "document.body.style.overflow = ''; const commentFormBar = document.getElementById('comment-form-bar'); if (commentFormBar) commentFormBar.style.display = 'block';" do |f| %>
        <%= f.hidden_field :votable_type, value: "Post" %>
        <%= f.hidden_field :votable_id, value: @post.id %>
        <%= f.hidden_field :value, id: "voteValue" %>
        <%= f.text_area :comment, id: "voteComment", rows: 5, 
            placeholder: "„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰ªªÊÑèÔºâ",
            class: "w-full p-3 text-sm border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" %>
        <div class="flex gap-3 justify-center">
          <button type="submit" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-sm shadow-sm">
            ÈÄÅ‰ø°
          </button>
          <button type="button" onclick="submitVoteWithoutComment()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors text-sm shadow-sm">
            „Ç≥„É°„É≥„Éà„Å™„Åó„ÅßË©ï‰æ°
          </button>
        </div>
      <% end %>
    </div>

    <button type="button" onclick="hideVoteModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl leading-none">
      √ó
    </button>
  </div>
</div>

<!-- ÁîªÂÉèÊã°Â§ßË°®Á§∫„É¢„Éº„ÉÄ„É´ -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
  <div class="relative max-w-[90vw] max-h-[90vh] p-4">
    <img id="modalImage" src="" alt="Êã°Â§ßÁîªÂÉè" class="max-w-full max-h-full object-contain rounded shadow-xl">
    <button type="button" onclick="hideImageModal()" class="absolute top-2 right-2 text-white hover:text-gray-300 text-3xl leading-none bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
      √ó
    </button>
  </div>
</div>

<!-- ÊäïÁ•®Ê©üËÉΩ„ÅÆJavaScriptÔºàÁõ¥Êé•Âüã„ÇÅËæº„ÅøÔºâ -->
<script>
  console.log('Inline vote script loaded!')
  
  let currentVoteValue = 0
  let currentPostId = 0

  // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
  window.showVoteModal = function(value, postId) {
    console.log('Showing vote modal:', value, postId)
    currentVoteValue = value
    currentPostId = postId
    
    const modal = document.getElementById('voteModal')
    const modalContent = document.getElementById('voteModalContent')
    const messageElement = document.getElementById('modalMessage')
    const voteValueInput = document.getElementById('voteValue')
    const commentTextarea = document.getElementById('voteComment')
    
    if (modal) {
      // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊõ¥Êñ∞
      messageElement.textContent = value === 1 ? 
        '„Å™„Åú„Éó„É©„ÇπË©ï‰æ°„Å†„Å®ÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü„Ç≥„É°„É≥„Éà„ÇíÊõ∏„ÅÑ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' : 
        '„Å™„Åú„Éû„Ç§„Éä„ÇπË©ï‰æ°„Å†„Å®ÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü„Ç≥„É°„É≥„Éà„ÇíÊõ∏„ÅÑ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
      
      // „É¢„Éº„ÉÄ„É´ËÉåÊôØËâ≤„ÅØÁôΩ„ÅÆ„Åæ„ÅæÁ∂≠ÊåÅ
      
      // Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„Å´ÂÄ§„ÇíË®≠ÂÆö
      voteValueInput.value = value
      
      // ËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´„ÇíÁÑ°ÂäπÂåñ
      document.body.style.overflow = 'hidden'
      
      // Âõ∫ÂÆö„Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫
      const commentFormBar = document.getElementById('comment-form-bar')
      if (commentFormBar) {
        commentFormBar.style.display = 'none'
      }
      
      // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
      modal.classList.remove('hidden')
      
      // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ
      if (commentTextarea) {
        setTimeout(() => commentTextarea.focus(), 100)
      }
      
      console.log('Modal shown successfully')
    } else {
      console.error('Modal element not found')
    }
  }

  window.hideVoteModal = function() {
    const modal = document.getElementById('voteModal')
    const modalContent = document.getElementById('voteModalContent')
    const commentTextarea = document.getElementById('voteComment')
    
    if (modal) {
      modal.classList.add('hidden')
      // „Ç≥„É°„É≥„ÉàÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
      if (commentTextarea) {
        commentTextarea.value = ''
      }
      // „É¢„Éº„ÉÄ„É´ËÉåÊôØËâ≤„ÅØ„Åù„ÅÆ„Åæ„Åæ
      // ËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÜçÊúâÂäπÂåñ
      document.body.style.overflow = ''
      
      // Âõ∫ÂÆö„Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É†„ÇíÂÜçË°®Á§∫
      const commentFormBar = document.getElementById('comment-form-bar')
      if (commentFormBar) {
        commentFormBar.style.display = 'block'
      }
    }
  }

  window.submitVoteWithoutComment = function() {
    const commentTextarea = document.getElementById('voteComment')
    if (commentTextarea) {
      commentTextarea.value = '' // „Ç≥„É°„É≥„Éà„ÇíÁ©∫„Å´„Åô„Çã
    }
    
    // ËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÜçÊúâÂäπÂåñ
    document.body.style.overflow = ''
    
    // Âõ∫ÂÆö„Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É†„ÇíÂÜçË°®Á§∫
    const commentFormBar = document.getElementById('comment-form-bar')
    if (commentFormBar) {
      commentFormBar.style.display = 'block'
    }
    
    // „Éï„Ç©„Éº„É†„ÇíÈÄÅ‰ø°
    const form = document.getElementById('voteForm')
    if (form) {
      form.submit()
    }
  }

  // ÊäïÁ•®„É¢„Éº„ÉÄ„É´Áî®AIÊ©üËÉΩ
  window.toggleVoteModalAI = function() {
    const initialDiv = document.getElementById('voteModalAIInitial')
    const loadingDiv = document.getElementById('voteModalAILoading')
    const contentDiv = document.getElementById('voteModalAIContent')
    const toggleButton = document.getElementById('voteModalAIToggle')
    
    if (contentDiv.classList.contains('hidden')) {
      // AIÊ©üËÉΩ„ÇíÈñãÂßã
      initialDiv.classList.add('hidden')
      loadingDiv.classList.remove('hidden')
      toggleButton.innerHTML = '<span>ü§ñ</span><span>ÂàÜÊûê‰∏≠...</span>'
      toggleButton.disabled = true
      
      // „É¢„ÉÉ„ÇØAIÂàÜÊûêÔºàÂÆüÈöõ„ÅÆAPI„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åì„Åì„Å´ÂÆüË£ÖÔºâ
      setTimeout(() => {
        loadingDiv.classList.add('hidden')
        contentDiv.classList.remove('hidden')
        toggleButton.innerHTML = '<span>ü§ñ</span><span>Èñâ„Åò„Çã</span>'
        toggleButton.disabled = false
        
        // AIË°®Á§∫ÊôÇ„Å´„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂ§âÊõ¥
        adjustLayoutForAI(true)
      }, 2000)
    } else {
      // AIÊ©üËÉΩ„ÇíÈñâ„Åò„Çã
      contentDiv.classList.add('hidden')
      initialDiv.classList.remove('hidden')
      toggleButton.innerHTML = '<span>ü§ñ</span><span>ÈñãÂßã</span>'
      
      // „É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂÖÉ„Å´Êàª„Åô
      adjustLayoutForAI(false)
    }
  }




  // ÁîªÂÉèÊã°Â§ßË°®Á§∫Ê©üËÉΩ
  window.showImageModal = function(imageSrc) {
    const modal = document.getElementById('imageModal')
    const modalImage = document.getElementById('modalImage')
    
    if (modal && modalImage) {
      modalImage.src = imageSrc
      document.body.style.overflow = 'hidden'
      modal.classList.remove('hidden')
    }
  }

  window.hideImageModal = function() {
    const modal = document.getElementById('imageModal')
    const modalImage = document.getElementById('modalImage')
    
    if (modal && modalImage) {
      modal.classList.add('hidden')
      modalImage.src = ''
      document.body.style.overflow = ''
    }
  }

  // ÁîªÂÉè„É¢„Éº„ÉÄ„É´„ÅÆËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
  document.getElementById('imageModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      hideImageModal()
    }
  })

  // AIË°®Á§∫ÊôÇ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥
  window.adjustLayoutForAI = function(showingAI) {
    const modalLayout = document.getElementById('modalLayout')
    const postContent = document.getElementById('postContent')
    const aiContent = document.getElementById('aiContent')
    const commentSection = document.getElementById('commentSection')
    
    if (!modalLayout || !postContent || !aiContent || !commentSection) return
    
    if (showingAI) {
      // AIË°®Á§∫ÊôÇÔºö2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„ÉàÔºàÂ∑¶ÔºöÊäïÁ®ø„ÄÅÂè≥ÔºöAIÁ∏¶Èï∑Ôºâ„ÄÅ„Ç≥„É°„É≥„ÉàÊ¨Ñ„ÇíÊäïÁ®ø„ÅÆ‰∏ã„Å´ÁßªÂãï
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
      postContent.className = 'lg:col-span-1 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // AI„Ç®„É™„Ç¢„ÅÆÈ´ò„Åï„ÇíÊã°Â§ß
      const aiContainer = aiContent.querySelector('.bg-gradient-to-r')
      if (aiContainer) {
        aiContainer.className = aiContainer.className.replace('min-h-[180px]', 'min-h-[500px]')
      }
      
      // „Ç≥„É°„É≥„ÉàÂÖ•ÂäõÊ¨Ñ„ÇíÊäïÁ®ø„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ‰∏ã„Å´ÁßªÂãï
      commentSection.remove()
      postContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
      
    } else {
      // AIÈùûË°®Á§∫ÊôÇÔºöÂÖÉ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà„Å´Êàª„Åô
      const currentAspectRatio = getCurrentImageAspectRatio()
      
      if (currentAspectRatio && currentAspectRatio <= 0.8) {
        // Á∏¶Èï∑ÁîªÂÉè„ÅÆÂ†¥Âêà
        modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
        postContent.className = 'lg:col-span-1 space-y-4'
        aiContent.className = 'lg:col-span-1 space-y-4'
      } else {
        // Ê®™Èï∑„ÉªÊ≠£ÊñπÂΩ¢„ÅÆÂ†¥Âêà
        modalLayout.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3'
        postContent.className = 'lg:col-span-2 space-y-4'
        aiContent.className = 'lg:col-span-1 space-y-4'
      }
      
      // AI„Ç®„É™„Ç¢„ÅÆÈ´ò„Åï„ÇíÂÖÉ„Å´Êàª„Åô
      const aiContainer = aiContent.querySelector('.bg-gradient-to-r')
      if (aiContainer) {
        aiContainer.className = aiContainer.className.replace('min-h-[500px]', 'min-h-[180px]')
      }
      
      // „Ç≥„É°„É≥„ÉàÂÖ•ÂäõÊ¨Ñ„ÇíAI„ÅÆ‰∏ã„Å´Êàª„Åô
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
    }
  }

  // ÁèæÂú®„ÅÆÁîªÂÉè„ÅÆ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíÂèñÂæó
  window.getCurrentImageAspectRatio = function() {
    const primaryImage = document.getElementById('primaryImage') || document.getElementById('image_0')
    if (primaryImage && primaryImage.complete) {
      return primaryImage.naturalWidth / primaryImage.naturalHeight
    }
    return null
  }

  // ÁîªÂÉè„ÅÆ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂãïÁöÑ„Å´Â§âÊõ¥
  window.checkImageAspectRatio = function(img) {
    const aspectRatio = img.naturalWidth / img.naturalHeight
    const modalLayout = document.getElementById('modalLayout')
    const postContent = document.getElementById('postContent')
    const aiContent = document.getElementById('aiContent')
    const commentSection = document.getElementById('commentSection')
    
    if (!modalLayout || !postContent || !aiContent || !commentSection) return
    
    // Á∏¶Èï∑ÁîªÂÉè„ÅÆÂ†¥ÂêàÔºà„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Åå0.8‰ª•‰∏ãÔºâ
    if (aspectRatio <= 0.8) {
      // 2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà„Å´Â§âÊõ¥ÔºàÂ∑¶ÔºöÊäïÁ®ø„ÄÅÂè≥ÔºöAIÔºâ
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
      postContent.className = 'lg:col-span-1 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // ÁîªÂÉè„Çí„Çà„ÇäÂ§ß„Åç„ÅèÁ∏¶Èï∑„ÅßË°®Á§∫
      img.className = img.className.replace('max-h-80', 'max-h-[500px]').replace('max-h-64', 'max-h-96')
      
      // „Ç≥„É°„É≥„ÉàÂÖ•ÂäõÊ¨Ñ„ÇíAI„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ‰∏ã„Å´ÁßªÂãï
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
      
    } else {
      // Ê®™Èï∑„ÉªÊ≠£ÊñπÂΩ¢„ÅÆÂ†¥Âêà„ÇÇ3„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà„Åß„Ç≥„É°„É≥„ÉàÊ¨Ñ„ÇíAI‰∏ã„Å´ÈÖçÁΩÆ
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3'
      postContent.className = 'lg:col-span-2 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // „Ç≥„É°„É≥„ÉàÂÖ•ÂäõÊ¨Ñ„ÇíAI„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ‰∏ã„Å´ÁßªÂãï
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
    }
  }

  // „É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÈöõ„Å´„É¨„Ç§„Ç¢„Ç¶„Éà„Çí„É™„Çª„ÉÉ„Éà
  const originalShowVoteModal = window.showVoteModal
  window.showVoteModal = function(value, postId) {
    // ÂÖÉ„ÅÆÈñ¢Êï∞„ÇíÂÆüË°å
    originalShowVoteModal(value, postId)
    
    // „Éá„Éï„Ç©„É´„Éà„Åß„Ç≥„É°„É≥„ÉàÊ¨Ñ„ÇíAI„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ
    setTimeout(() => {
      const aiContent = document.getElementById('aiContent')
      const commentSection = document.getElementById('commentSection')
      
      if (aiContent && commentSection) {
        commentSection.remove()
        aiContent.appendChild(commentSection)
        commentSection.className = 'border-t pt-4 mt-4'
      }
      
      // ÁîªÂÉè„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí„ÉÅ„Çß„ÉÉ„ÇØ
      const primaryImage = document.getElementById('primaryImage') || document.getElementById('image_0')
      if (primaryImage && primaryImage.complete) {
        checkImageAspectRatio(primaryImage)
      }
    }, 100)
  }
</script>


<!-- Áµ±Âêà„Ç≥„É°„É≥„Éà„Çª„ÇØ„Ç∑„Éß„É≥ -->
<div class="max-w-7xl mx-auto mt-8 px-4">
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h3 class="text-xl font-bold mb-6 text-gray-900">Ë©ï‰æ°„Éª„Ç≥„É°„É≥„Éà„Éª„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</h3>
    

    <!-- ÈÄöÂ∏∏„ÅÆ„Ç≥„É°„É≥„Éà‰∏ÄË¶ß -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <span>üí¨</span>
          „Ç≥„É°„É≥„Éà
        </h4>
        <span class="text-sm text-gray-500"><%= @post.comments.where(parent_id: nil, x_position: nil, y_position: nil).count + @vote_comments.count %>‰ª∂</span>
      </div>
      
      <% if user_can_view_comments?(current_user, @post) %>
        <div class="space-y-4 max-h-96 overflow-y-auto">
          <% 
            # ÈÄöÂ∏∏„ÅÆ„Ç≥„É°„É≥„Éà„Å®ÊäïÁ•®„Ç≥„É°„É≥„Éà„ÇíÊôÇÁ≥ªÂàó„Åß„Åæ„Å®„ÇÅ„ÇãÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
            regular_comments = @post.comments.where(parent_id: nil, x_position: nil, y_position: nil)
            all_comments = (regular_comments + @vote_comments).sort_by(&:created_at).reverse
          %>
          <% all_comments.each do |item| %>
            <% if item.is_a?(Comment) %>
              <!-- ÈÄöÂ∏∏„ÅÆ„Ç≥„É°„É≥„Éà -->
              <div class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow p-4">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                      <span class="text-sm font-medium text-gray-600">
                        <%= (item.user&.name || "ÂåøÂêç")[0] %>
                      </span>
                    </div>
                    <div>
                      <span class="font-medium text-gray-900"><%= item.user&.name || "ÂåøÂêç" %></span>
                      <span class="text-xs text-gray-500 ml-2"><%= time_ago_in_words(item.created_at) %>Ââç</span>
                    </div>
                  </div>
                  
                  <!-- ÊäïÁ•®„Éú„Çø„É≥ -->
                  <div class="flex items-center gap-2">
                    <%= button_to vote_path(votable_type: 'Comment', votable_id: item.id, value: 1), method: :post, class: "text-gray-400 hover:text-green-500 transition-colors" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14"/>
                        <path d="M5 12h14"/>
                      </svg>
                    <% end %>
                    <span class="text-xs text-gray-600 min-w-[20px] text-center">
                      <%= item.votes.where(value: 1).count - item.votes.where(value: -1).count %>
                    </span>
                    <%= button_to vote_path(votable_type: 'Comment', votable_id: item.id, value: -1), method: :post, class: "text-gray-400 hover:text-red-500 transition-colors" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"/>
                      </svg>
                    <% end %>
                  </div>
                </div>
                <p class="text-gray-700 leading-relaxed"><%= item.body %></p>
              </div>
            <% else %>
              <!-- ÊäïÁ•®„Ç≥„É°„É≥„Éà -->
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 shadow-sm hover:shadow-md transition-shadow p-4">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                      <span class="text-sm font-medium text-blue-600">
                        <%= (item.user&.name || "ÂåøÂêç")[0] %>
                      </span>
                    </div>
                    <div>
                      <span class="font-medium text-gray-900"><%= item.user&.name || "ÂåøÂêç" %></span>
                      <span class="text-xs text-gray-500 ml-2"><%= time_ago_in_words(item.created_at) %>Ââç</span>
                      <span class="ml-2 px-2 py-1 text-xs rounded-full <%= item.value == 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                        <%= item.value == 1 ? 'üëç Ë©ï‰æ°' : 'üëé Ë©ï‰æ°' %>
                      </span>
                    </div>
                  </div>
                </div>
                <p class="text-gray-700 leading-relaxed"><%= item.comment %></p>
              </div>
            <% end %>
          <% end %>
          
          <% if all_comments.empty? %>
            <div class="text-center py-8 text-gray-500">
              <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <span class="text-xl">üí¨</span>
              </div>
              <p class="text-sm">„Åæ„Å†„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
              <p class="text-xs text-gray-400">Âè≥„ÅÆ„Éï„Ç©„Éº„É†„Åã„Çâ„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô</p>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- „Ç≥„É°„É≥„Éà„ÅåË¶ã„Çå„Å™„ÅÑÂ†¥Âêà„ÅÆË™¨Êòé -->
        <div class="text-center py-8 text-gray-500 border border-gray-200 rounded-lg bg-gray-50">
          <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">„Ç≥„É°„É≥„ÉàÂèÇÂä†Âæå„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</h4>
          <p class="text-xs text-gray-500">
            „Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åô„Çã„Åã„ÄÅÊäïÁ•®„Çí„Åô„Çã„Å®„Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÅåË¶ã„Çå„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô
          </p>
        </div>
      <% end %>
    </div>

    <!-- ÁîªÂÉè‰∏ä„ÅÆ„Éî„É≥„Ç≥„É°„É≥„Éà‰∏ÄË¶ß -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-semibold text-blue-800 flex items-center gap-2">
          <span>üìç</span>
          ÁîªÂÉè‰∏ä„ÅÆ„Éî„É≥„Ç≥„É°„É≥„Éà
        </h4>
        <% image_comments = @post.comments.where.not(x_position: nil, y_position: nil).order(:created_at) %>
        <span class="text-sm text-blue-600"><%= image_comments.count %>‰ª∂</span>
      </div>
      
      <% if user_can_view_comments?(current_user, @post) %>
        <div class="space-y-4 max-h-96 overflow-y-auto" data-controller="compact-comments">
          <% if image_comments.any? %>
            <% image_comments.each_with_index do |comment, index| %>
              <div class="bg-blue-50 rounded-lg border border-blue-200 shadow-sm hover:shadow-md transition-shadow p-4 cursor-pointer hover:bg-blue-100" 
                   data-comment-id="<%= comment.id %>"
                   data-action="click->image-comments-v2#highlightMarker click->compact-comments#highlightComment">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                      <%= index + 1 %>
                    </div>
                    <div>
                      <span class="font-medium text-blue-900"><%= comment.user&.name || "ÂåøÂêç" %></span>
                      <span class="text-xs text-blue-600 ml-2"><%= time_ago_in_words(comment.created_at) %>Ââç</span>
                    </div>
                  </div>
                  
                  <div class="text-xs text-blue-500 bg-blue-100 px-2 py-1 rounded-full">
                    ÁîªÂÉè‰∏ä„ÅÆ„Ç≥„É°„É≥„Éà
                  </div>
                </div>
                <p class="text-blue-900 leading-relaxed"><%= comment.body %></p>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-8 text-blue-500">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <span class="text-xl">üìç</span>
              </div>
              <p class="text-sm">ÁîªÂÉè‰∏ä„ÅÆ„Éî„É≥„Ç≥„É°„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
              <p class="text-xs text-blue-400">ÁîªÂÉè„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô</p>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- ÁîªÂÉè„Ç≥„É°„É≥„Éà„ÅåË¶ã„Çå„Å™„ÅÑÂ†¥Âêà„ÅÆË™¨Êòé -->
        <div class="text-center py-8 text-blue-500 border border-blue-200 rounded-lg bg-blue-50">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h4 class="text-sm font-semibold text-blue-700 mb-2">„Ç≥„É°„É≥„ÉàÂèÇÂä†Âæå„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</h4>
          <p class="text-xs text-blue-500">
            „Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åô„Çã„Åã„ÄÅÊäïÁ•®„Çí„Åô„Çã„Å®„Éî„É≥„Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÅåË¶ã„Çå„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô
          </p>
        </div>
      <% end %>
    </div>

  </div>
</div>

<!-- Âõ∫ÂÆö„Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É†ÔºàÊäïÁ®øË©≥Á¥∞„Éö„Éº„Ç∏Â∞ÇÁî®Ôºâ -->
<% if user_signed_in? %>
  <div class="fixed bottom-0 right-0 bg-white border-t-2 border-l-2 border-gray-200 shadow-2xl z-50 rounded-tl-lg" id="comment-form-bar" style="width: 400px; max-width: 90vw;">
    <div class="px-4 py-3">
      <div class="flex flex-col gap-3">
        <!-- „Éï„Ç©„Éº„É†Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ -->
        <button type="button" id="toggle-comment-form" 
                class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 w-full text-sm">
          <span>üí¨</span>
          <span id="toggle-text">Èñâ„Åò„Çã</span>
        </button>
        
        <!-- Â±ïÈñã„Åï„Çå„Åü„Éï„Ç©„Éº„É† -->
        <div id="comment-form-container" class="">
          <%= form_with model: [@post, @comment], local: true, class: "flex flex-col gap-3 w-full", data: { controller: "comment-form" } do |f| %>
            <!-- „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div>
              <%= f.text_area :body, 
                  rows: 3, 
                  placeholder: "„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...", 
                  class: "w-full p-3 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 resize-none",
                  data: { "comment-form-target": "textarea" } %>
            </div>
            
            <!-- „Éï„Ç°„Ç§„É´Ê∑ª‰ªò„Å®ÈÄÅ‰ø°„Éú„Çø„É≥ -->
            <div class="flex items-center gap-2">
              <%= f.file_field :attachments, 
                  multiple: true, 
                  class: "hidden",
                  id: "file-input" %>
              <label for="file-input" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg cursor-pointer transition-colors flex-shrink-0">
                üìé
              </label>
              
              <!-- ÈÄÅ‰ø°„Éú„Çø„É≥ -->
              <%= f.submit "ÈÄÅ‰ø°", 
                  class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm flex-1" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- „Éö„Éº„Ç∏‰∏ãÈÉ®„ÅÆ‰ΩôÁôΩËøΩÂä†ÔºàÂõ∫ÂÆö„Éï„Ç©„Éº„É†„ÅÆ„Åü„ÇÅÔºâ -->
  <div class="h-20"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleButton = document.getElementById('toggle-comment-form');
      const formContainer = document.getElementById('comment-form-container');
      const toggleText = document.getElementById('toggle-text');
      
      if (toggleButton && formContainer && toggleText) {
        // ÂàùÊúüÁä∂ÊÖã„Åß„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ
        const textarea = formContainer.querySelector('textarea');
        if (textarea) {
          setTimeout(() => textarea.focus(), 100);
        }
        
        toggleButton.addEventListener('click', function() {
          const isVisible = !formContainer.classList.contains('hidden');
          
          if (isVisible) {
            formContainer.classList.add('hidden');
            toggleText.textContent = '„Ç≥„É°„É≥„Éà„ÇíÊõ∏„Åè';
            toggleButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            toggleButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
          } else {
            formContainer.classList.remove('hidden');
            toggleText.textContent = 'Èñâ„Åò„Çã';
            toggleButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
            toggleButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ
            const textarea = formContainer.querySelector('textarea');
            if (textarea) {
              setTimeout(() => textarea.focus(), 100);
            }
          }
        });
      }
    });
  </script>
<% end %>
