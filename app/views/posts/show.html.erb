<!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
<div class="mt-4 px-4">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- å·¦å´: æŠ•ç¨¿è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆç´„70%ï¼‰ -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <h1 class="text-lg font-bold mb-2 text-gray-900"><%= @post.title %></h1>
        
        <div class="flex items-center gap-2 mb-2 text-sm">
          <span class="font-medium text-gray-600">æŠ•ç¨¿è€…:</span>
          <%= link_to @post.user.name, user_path(@post.user), class: "text-blue-500 hover:underline" %>
        </div>

        <p class="mb-3 text-sm text-gray-600 leading-relaxed"><%= @post.body %></p>

        <% if @post.request_tag.present? %>
          <p class="mb-2">
            <span class="font-medium text-gray-500 text-xs">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:</span>
            <span class="bg-green-50 text-green-500 px-2 py-1 rounded-full text-xs"><%= @post.request_tag %></span>
          </p>
        <% end %>

        <!-- ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <% if @post.images.attached? %>
          <div class="space-y-4">
            <% @post.images.each_with_index do |image, index| %>
              <div class="relative" data-controller="image-comments" data-image-comments-post-id-value="<%= @post.id %>">
                <%= image_tag image, class: "w-full rounded-lg cursor-pointer shadow", data: { "image-comments-target": "image" } %>
                
                <!-- ç”»åƒä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="absolute inset-0 pointer-events-none" data-image-comments-target="markersContainer"></div>
                
                <!-- ç”»åƒä¸Šã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
                <div class="hidden absolute z-50 bg-white border border-gray-300 rounded p-2 shadow-lg" data-image-comments-target="form">
                  <%= form_with model: [@post, Comment.new], local: false, data: { "image-comments-target": "commentForm", action: "submit->image-comments#submitComment" } do |f| %>
                    <%= f.hidden_field :x_position %>
                    <%= f.hidden_field :y_position %>
                    <%= f.text_area :body, rows: 2, placeholder: "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...", class: "w-40 p-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500", required: true %>
                    <div class="mt-1 flex gap-1">
                      <%= f.submit "ã‚³ãƒ¡ãƒ³ãƒˆ", class: "bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 text-xs" %>
                      <button type="button" data-action="click->image-comments#hideForm" class="bg-gray-300 text-gray-700 px-2 py-1 rounded hover:bg-gray-400 text-xs">Ã—</button>
                    </div>
                  <% end %>
                </div>
                
                <!-- ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <div class="mt-2 flex items-center gap-2">
                  <button type="button" 
                          data-action="click->image-comments#toggleMarkers" 
                          data-image-comments-target="toggleButton"
                          class="flex items-center gap-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                    <span data-image-comments-target="toggleIcon">ğŸ‘ï¸</span>
                    <span data-image-comments-target="toggleText">ãƒ”ãƒ³è¡¨ç¤º</span>
                  </button>
                  <span data-image-comments-target="markerCount" class="text-xs text-gray-500"></span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if @post.present? && @post.videos.attached? %>
          <div class="mb-4">
            <% @post.videos.each_with_index do |video, index| %>
              <div class="bg-gray-900 rounded-xl overflow-hidden shadow-lg mb-4">
                <video class="custom-video no-context-menu w-full max-w-md" 
                       controls 
                       controlsList="nodownload noremoteplayback"
                       oncontextmenu="return false;"
                       preload="metadata"
                       style="outline: none;">
                  <source src="<%= url_for(video) %>" type="video/mp4">
                  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ video ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </video>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if @post.present? && @post.audios.attached? %>
          <div class="mb-4">
            <% @post.audios.each_with_index do |audio, index| %>
              <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-xl p-3 mb-3 border border-purple-200">
                <audio class="custom-audio no-context-menu w-full" 
                       controls 
                       controlsList="nodownload noremoteplayback"
                       oncontextmenu="return false;"
                       preload="metadata"
                       style="outline: none;">
                  <source src="<%= url_for(audio) %>" type="audio/mpeg">
                  <source src="<%= url_for(audio) %>" type="audio/wav">
                  <source src="<%= url_for(audio) %>" type="audio/ogg">
                  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ audio ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </audio>
              </div>
            <% end %>
          </div>
        <% end %>

        <p class="mb-4">
          <span class="font-semibold text-gray-600">ã‚¿ã‚°:</span>
          <span class="bg-blue-50 text-blue-500 px-2 py-1 rounded-full text-sm"><%= @post.tag %></span>
        </p>

        <!-- æŠ•ç¥¨ãƒœã‚¿ãƒ³ï¼ˆAJAXï¼‹å‰²åˆãƒãƒ¼ï¼‰ -->
        <div class="flex items-center justify-end gap-4 mt-6 border-t pt-4">
          
          <!-- ä¸€æ™‚çš„ã«é™çš„ãªè¡¨ç¤ºã«ã—ã¦ã€åŸºæœ¬çš„ãªæŠ•ç¥¨æ©Ÿèƒ½ã‚’å‹•ã‹ã™ -->
          <% up_count = @post.votes.where(value: 1).count %>
          <% down_count = @post.votes.where(value: -1).count %>
          <% user_vote = current_user ? (@post.votes.find_by(user: current_user)&.value || 0) : 0 %>
          <% total_votes = up_count + down_count %>
          <% net_score = up_count - down_count %>
          
          <!-- ãƒ—ãƒ©ã‚¹æŠ•ç¥¨ãƒœã‚¿ãƒ³ -->
          <% if user_vote == 0 %>
            <button type="button" 
                    class="text-gray-500 hover:text-green-600"
                    onclick="showVoteModal(1, <%= @post.id %>)">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% else %>
            <button type="button" 
                    class="<%= user_vote == 1 ? 'text-green-600 bg-green-100 rounded px-2 py-1 font-bold' : 'text-gray-400' %>"
                    disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% end %>
          
          <div class="relative w-36 h-6 bg-gray-300 rounded overflow-hidden">
            <% if user_vote == 0 %>
              <!-- æœªæŠ•ç¥¨ã®å ´åˆï¼šã‚°ãƒ¬ãƒ¼ã®ãƒãƒ¼ -->
              <div class="absolute inset-0 flex items-center justify-center text-xs text-gray-700 font-semibold select-none">
                <%= total_votes %>
              </div>
            <% else %>
              <!-- æŠ•ç¥¨æ¸ˆã¿ã®å ´åˆï¼šã‚«ãƒ©ãƒ•ãƒ«ãªãƒãƒ¼ã¨å†…è¨³è¡¨ç¤º -->
              <div class="absolute inset-0 flex">
                <% if total_votes > 0 %>
                  <% up_percentage = (up_count.to_f / total_votes * 100).round(1) %>
                  <% down_percentage = (down_count.to_f / total_votes * 100).round(1) %>
                  
                  <!-- ãƒ—ãƒ©ã‚¹ç¥¨ã®ãƒãƒ¼ -->
                  <div class="h-full bg-green-500 relative flex items-center justify-center" style="width: <%= up_percentage %>%">
                    <% if up_count > 0 %>
                      <span class="text-xs text-white font-bold"><%= up_count %></span>
                    <% end %>
                  </div>
                  
                  <!-- ãƒã‚¤ãƒŠã‚¹ç¥¨ã®ãƒãƒ¼ -->
                  <div class="h-full bg-red-500 relative flex items-center justify-center" style="width: <%= down_percentage %>%">
                    <% if down_count > 0 %>
                      <span class="text-xs text-white font-bold"><%= down_count %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <!-- ãƒã‚¤ãƒŠã‚¹æŠ•ç¥¨ãƒœã‚¿ãƒ³ -->
          <% if user_vote == 0 %>
            <button type="button" 
                    class="text-gray-500 hover:text-red-600"
                    onclick="showVoteModal(-1, <%= @post.id %>)">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% else %>
            <button type="button" 
                    class="<%= user_vote == -1 ? 'text-red-600 bg-red-100 rounded px-2 py-1 font-bold' : 'text-gray-400' %>"
                    disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/>
              </svg>
            </button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- AIã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå³å´ï¼‰ -->
    <div class="lg:col-span-1">
      <div class="bg-gradient-to-b from-purple-50 to-indigo-50 rounded-2xl shadow-lg p-4 sticky top-4" data-controller="ai-sidebar" data-ai-sidebar-post-id-value="<%= @post.id %>">
        <!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="mb-6">
          <h3 class="text-base font-bold mb-3 text-gray-900 flex items-center gap-2">
            <span>ğŸ’¬</span>
            ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          </h3>
          
          <%= form_with model: [@post, @comment], local: true, class: "space-y-3", data: { controller: "comment-form" } do |f| %>
            <!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div>
              <%= f.text_area :body, 
                  rows: 4, 
                  placeholder: "ç”»åƒã‚’è¦‹ãªãŒã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†...", 
                  class: "w-full p-3 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 resize-y",
                  data: { "comment-form-target": "textarea" } %>
            </div>
            
            <div>
              <%= f.file_field :attachments, 
                  multiple: true, 
                  class: "text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="text-xs text-gray-500">
                <span data-comment-form-target="charCount">0</span>/500æ–‡å­—
              </div>
              <%= f.submit "æŠ•ç¨¿", 
                  class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm" %>
            </div>
          <% end %>
        </div>
        
        <!-- AIè£œåŠ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="pt-6 border-t border-purple-200">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
                <span class="text-white text-xs font-bold">AI</span>
              </div>
              <h2 class="text-sm font-bold text-gray-900">ã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©</h2>
            </div>
            
            <!-- AIèµ·å‹•ãƒœã‚¿ãƒ³ -->
            <button type="button" 
                    data-action="click->ai-sidebar#toggleAI"
                    data-ai-sidebar-target="toggleButton"
                    class="px-3 py-1 bg-purple-600 text-white text-xs font-medium rounded hover:bg-purple-700 transition-colors flex items-center gap-1">
              <span data-ai-sidebar-target="toggleIcon">ğŸ¤–</span>
              <span data-ai-sidebar-target="toggleText">é–‹å§‹</span>
            </button>
          </div>
          
          <!-- åˆæœŸçŠ¶æ…‹ã®èª¬æ˜ -->
          <div data-ai-sidebar-target="initialMessage" class="text-center py-4">
            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
              <span class="text-lg">ğŸ¤–</span>
            </div>
            <h3 class="text-sm font-semibold text-gray-800 mb-1">AIã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©</h3>
            <p class="text-xs text-gray-600 mb-2">
              AIãŒã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’ã‚µãƒãƒ¼ãƒˆ
            </p>
            <p class="text-xs text-gray-500">
              ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            </p>
          </div>
          
          <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
          <div data-ai-sidebar-target="loading" class="hidden text-center py-4">
            <div class="w-8 h-8 border-2 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-xs text-gray-600">AIåˆ†æä¸­...</p>
          </div>
          
          <!-- AIè£œåŠ©ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
          <div data-ai-sidebar-target="aiContent" class="hidden space-y-2">
            <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¾‹ -->
            <div class="bg-white rounded p-2 border border-purple-200">
              <h3 class="text-xs font-semibold text-gray-800 mb-1 flex items-center gap-1">
                <span>ğŸ’¬</span>
                ãŠã™ã™ã‚ã‚³ãƒ¡ãƒ³ãƒˆ
              </h3>
              <div class="space-y-1" data-ai-sidebar-target="commentSuggestions">
                <!-- ã‚³ãƒ¡ãƒ³ãƒˆææ¡ˆãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
            </div>
            
            <!-- ãƒˆãƒ¼ãƒ³ææ¡ˆ -->
            <div class="bg-white rounded p-2 border border-purple-200">
              <h3 class="text-xs font-semibold text-gray-800 mb-1 flex items-center gap-1">
                <span>ğŸ¨</span>
                ãƒˆãƒ¼ãƒ³èª¿æ•´
              </h3>
              <div class="flex flex-wrap gap-1">
                <button class="px-2 py-1 text-xs bg-pink-100 text-pink-700 rounded-full hover:bg-pink-200 transition-colors"
                        data-action="click->ai-sidebar#applyTone"
                        data-tone="è¤’ã‚ã‚‹">è¤’ã‚ã‚‹</button>
                <button class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors"
                        data-action="click->ai-sidebar#applyTone"
                        data-tone="è³ªå•">è³ªå•</button>
                <button class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors"
                        data-action="click->ai-sidebar#applyTone"
                        data-tone="å»ºè¨­çš„">å»ºè¨­çš„</button>
                <button class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full hover:bg-yellow-200 transition-colors"
                        data-action="click->ai-sidebar#applyTone"
                        data-tone="åŠ±ã¾ã—">åŠ±ã¾ã—</button>
              </div>
            </div>
            
            <!-- è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆãƒ»åˆ†æçµæœ -->
            <div class="bg-white rounded p-2 border border-purple-200">
              <h3 class="text-xs font-semibold text-gray-800 mb-1 flex items-center gap-1">
                <span>ğŸ”</span>
                AIåˆ†æçµæœ
              </h3>
              <div data-ai-sidebar-target="summary" class="text-xs text-gray-600 leading-relaxed">
                <!-- AIç”»åƒèªè­˜ãƒ»åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
              <div class="mt-1 pt-1 border-t border-gray-100">
                <p class="text-xs text-gray-500 italic">
                  <% if @post.images.attached? %>
                    ç”»åƒã‚’åˆ†æä¸­
                  <% else %>
                    æŠ•ç¨¿å†…å®¹ã‚’åˆ†æä¸­
                  <% end %>
                </p>
              </div>
            </div>
            
            <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
            <div class="text-center pt-1">
              <button type="button" 
                      data-action="click->ai-sidebar#closeAI"
                      class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                é–‰ã˜ã‚‹
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- æŠ•ç¥¨ã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="voteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div id="voteModalContent" class="bg-white rounded-lg p-4 max-w-6xl w-full mx-4 shadow-xl max-h-[95vh] overflow-y-auto">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">è©•ä¾¡ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„</h3>
    
    <!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå‹•çš„ã«å¤‰æ›´ï¼‰ -->
    <div id="modalLayout" class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3">
      
      <!-- å·¦å´: æŠ•ç¨¿å†…å®¹è¡¨ç¤º -->
      <div id="postContent" class="lg:col-span-2 space-y-4">
        <!-- æŠ•ç¨¿å†…å®¹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <span>ğŸ“</span>
            <%= @post.title %>
          </h4>
          <div class="text-base text-gray-800">
            
            <!-- ç”»åƒè¡¨ç¤º -->
            <% if @post.images.attached? %>
              <div class="mb-4">
                <% if @post.images.count == 1 %>
                  <%= image_tag @post.images.first, class: "w-full max-h-80 object-contain rounded border shadow-md cursor-pointer hover:opacity-90 transition-opacity", onclick: "showImageModal('#{url_for(@post.images.first)}')", id: "primaryImage", onload: "checkImageAspectRatio(this)" %>
                <% else %>
                  <div class="grid grid-cols-1 gap-3">
                    <% @post.images.limit(2).each_with_index do |image, index| %>
                      <%= image_tag image, class: "w-full max-h-64 object-contain rounded border shadow-sm cursor-pointer hover:opacity-90 transition-opacity", onclick: "showImageModal('#{url_for(image)}')", id: "image_#{index}", onload: index == 0 ? "checkImageAspectRatio(this)" : "" %>
                    <% end %>
                    <% if @post.images.count > 2 %>
                      <div class="w-full h-64 bg-gray-200 rounded border flex items-center justify-center">
                        <span class="text-base text-gray-600">+<%= @post.images.count - 2 %>æš</span>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
            
            <p class="text-gray-700 mb-4 leading-relaxed text-base"><%= @post.body %></p>
            <% if @post.tag.present? %>
              <div class="flex flex-wrap gap-2">
                <% @post.tag.split(',').each do |tag| %>
                  <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full font-medium"><%= tag.strip %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- å³å´: AIè£œåŠ© -->
      <div id="aiContent" class="lg:col-span-1 space-y-4">
        <!-- AIã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©ã‚¨ãƒªã‚¢ -->
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-3 border border-purple-100 min-h-[180px] flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-gray-800 flex items-center gap-1">
              <div class="w-4 h-4 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center">
                <span class="text-white text-xs font-bold">AI</span>
              </div>
              ã‚³ãƒ¡ãƒ³ãƒˆè£œåŠ©
            </h4>
            <button type="button" 
                    onclick="toggleVoteModalAI()"
                    id="voteModalAIToggle"
                    class="px-2 py-1 bg-purple-600 text-white text-xs font-medium rounded hover:bg-purple-700 transition-colors flex items-center gap-1">
              <span>ğŸ¤–</span>
              <span>é–‹å§‹</span>
            </button>
          </div>
          
          <!-- åˆæœŸçŠ¶æ…‹ã®èª¬æ˜ -->
          <div id="voteModalAIInitial" class="text-center py-2">
            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-1">
              <span class="text-xs">ğŸ¤–</span>
            </div>
            <p class="text-xs text-gray-600">
              AIãŒã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’ã‚µãƒãƒ¼ãƒˆ
            </p>
          </div>
          
          <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
          <div id="voteModalAILoading" class="hidden text-center py-2">
            <div class="w-5 h-5 border-2 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-1"></div>
            <p class="text-xs text-gray-600">AIåˆ†æä¸­...</p>
          </div>
          
          <!-- AIè£œåŠ©ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
          <div id="voteModalAIContent" class="hidden space-y-3 flex-1">
            <!-- ãŠã™ã™ã‚ã‚³ãƒ¡ãƒ³ãƒˆ -->
            <div class="bg-white rounded-lg p-4 border border-purple-200 flex-1">
              <h5 class="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span>ğŸ’¬</span>
                ãŠã™ã™ã‚ã‚³ãƒ¡ãƒ³ãƒˆ
              </h5>
              <div id="voteModalCommentSuggestions" class="space-y-2">
                <!-- ã‚³ãƒ¡ãƒ³ãƒˆææ¡ˆãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
            </div>
            
            <!-- ãƒˆãƒ¼ãƒ³èª¿æ•´ -->
            <div class="bg-white rounded-lg p-4 border border-purple-200">
              <h5 class="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span>ğŸ¨</span>
                ãƒˆãƒ¼ãƒ³èª¿æ•´
              </h5>
              <div class="grid grid-cols-2 gap-2">
                <button class="px-3 py-2 text-xs bg-pink-100 text-pink-700 rounded-lg hover:bg-pink-200 transition-colors font-medium"
                        onclick="applyVoteModalTone('è¤’ã‚ã‚‹')">è¤’ã‚ã‚‹</button>
                <button class="px-3 py-2 text-xs bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
                        onclick="applyVoteModalTone('å»ºè¨­çš„')">å»ºè¨­çš„</button>
                <button class="px-3 py-2 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors font-medium"
                        onclick="applyVoteModalTone('å…·ä½“çš„')">å…·ä½“çš„</button>
                <button class="px-3 py-2 text-xs bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors font-medium"
                        onclick="applyVoteModalTone('æ”¹å–„ææ¡ˆ')">æ”¹å–„ææ¡ˆ</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸‹éƒ¨: ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆä½ç½®ã¯å‹•çš„ã«å¤‰æ›´ï¼‰ -->
    <div id="commentSection" class="border-t pt-4">
      <p id="modalMessage" class="text-base text-gray-700 mb-4 text-center font-medium">
        ãªãœãã†æ€ã£ãŸã®ã‹ã‚’æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚
      </p>

      <!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <%= form_with url: vote_path, method: :post, local: true, id: "voteForm", class: "space-y-4", onsubmit: "document.body.style.overflow = ''" do |f| %>
        <%= f.hidden_field :votable_type, value: "Post" %>
        <%= f.hidden_field :votable_id, value: @post.id %>
        <%= f.hidden_field :value, id: "voteValue" %>
        <%= f.text_area :comment, id: "voteComment", rows: 5, 
            placeholder: "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰",
            class: "w-full p-3 text-sm border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" %>
        <div class="flex gap-3 justify-center">
          <button type="submit" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-sm shadow-sm">
            é€ä¿¡
          </button>
          <button type="button" onclick="submitVoteWithoutComment()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors text-sm shadow-sm">
            ã‚³ãƒ¡ãƒ³ãƒˆãªã—ã§è©•ä¾¡
          </button>
        </div>
      <% end %>
    </div>

    <button type="button" onclick="hideVoteModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl leading-none">
      Ã—
    </button>
  </div>
</div>

<!-- ç”»åƒæ‹¡å¤§è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
  <div class="relative max-w-[90vw] max-h-[90vh] p-4">
    <img id="modalImage" src="" alt="æ‹¡å¤§ç”»åƒ" class="max-w-full max-h-full object-contain rounded shadow-xl">
    <button type="button" onclick="hideImageModal()" class="absolute top-2 right-2 text-white hover:text-gray-300 text-3xl leading-none bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
      Ã—
    </button>
  </div>
</div>

<!-- æŠ•ç¥¨æ©Ÿèƒ½ã®JavaScriptï¼ˆç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼‰ -->
<script>
  console.log('Inline vote script loaded!')
  
  let currentVoteValue = 0
  let currentPostId = 0

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
  window.showVoteModal = function(value, postId) {
    console.log('Showing vote modal:', value, postId)
    currentVoteValue = value
    currentPostId = postId
    
    const modal = document.getElementById('voteModal')
    const modalContent = document.getElementById('voteModalContent')
    const messageElement = document.getElementById('modalMessage')
    const voteValueInput = document.getElementById('voteValue')
    const commentTextarea = document.getElementById('voteComment')
    
    if (modal) {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
      messageElement.textContent = value === 1 ? 
        'ãªãœãƒ—ãƒ©ã‚¹è©•ä¾¡ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚' : 
        'ãªãœãƒã‚¤ãƒŠã‚¹è©•ä¾¡ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚'
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯è‰²ã¯ç™½ã®ã¾ã¾ç¶­æŒ
      
      // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
      voteValueInput.value = value
      
      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
      document.body.style.overflow = 'hidden'
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      modal.classList.remove('hidden')
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      if (commentTextarea) {
        setTimeout(() => commentTextarea.focus(), 100)
      }
      
      console.log('Modal shown successfully')
    } else {
      console.error('Modal element not found')
    }
  }

  window.hideVoteModal = function() {
    const modal = document.getElementById('voteModal')
    const modalContent = document.getElementById('voteModalContent')
    const commentTextarea = document.getElementById('voteComment')
    
    if (modal) {
      modal.classList.add('hidden')
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      if (commentTextarea) {
        commentTextarea.value = ''
      }
      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯è‰²ã¯ãã®ã¾ã¾
      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å†æœ‰åŠ¹åŒ–
      document.body.style.overflow = ''
    }
  }

  window.submitVoteWithoutComment = function() {
    const commentTextarea = document.getElementById('voteComment')
    if (commentTextarea) {
      commentTextarea.value = '' // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç©ºã«ã™ã‚‹
    }
    
    // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å†æœ‰åŠ¹åŒ–
    document.body.style.overflow = ''
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
    const form = document.getElementById('voteForm')
    if (form) {
      form.submit()
    }
  }

  // æŠ•ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨AIæ©Ÿèƒ½
  window.toggleVoteModalAI = function() {
    const initialDiv = document.getElementById('voteModalAIInitial')
    const loadingDiv = document.getElementById('voteModalAILoading')
    const contentDiv = document.getElementById('voteModalAIContent')
    const toggleButton = document.getElementById('voteModalAIToggle')
    
    if (contentDiv.classList.contains('hidden')) {
      // AIæ©Ÿèƒ½ã‚’é–‹å§‹
      initialDiv.classList.add('hidden')
      loadingDiv.classList.remove('hidden')
      toggleButton.innerHTML = '<span>ğŸ¤–</span><span>åˆ†æä¸­...</span>'
      toggleButton.disabled = true
      
      // ãƒ¢ãƒƒã‚¯AIåˆ†æï¼ˆå®Ÿéš›ã®APIãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«å®Ÿè£…ï¼‰
      setTimeout(() => {
        loadingDiv.classList.add('hidden')
        contentDiv.classList.remove('hidden')
        toggleButton.innerHTML = '<span>ğŸ¤–</span><span>é–‰ã˜ã‚‹</span>'
        toggleButton.disabled = false
        
        // ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆææ¡ˆã‚’è¡¨ç¤º
        showVoteModalCommentSuggestions()
        
        // AIè¡¨ç¤ºæ™‚ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´
        adjustLayoutForAI(true)
      }, 2000)
    } else {
      // AIæ©Ÿèƒ½ã‚’é–‰ã˜ã‚‹
      contentDiv.classList.add('hidden')
      initialDiv.classList.remove('hidden')
      toggleButton.innerHTML = '<span>ğŸ¤–</span><span>é–‹å§‹</span>'
      
      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å…ƒã«æˆ»ã™
      adjustLayoutForAI(false)
    }
  }

  window.showVoteModalCommentSuggestions = function() {
    const suggestionsDiv = document.getElementById('voteModalCommentSuggestions')
    const voteValue = document.getElementById('voteValue').value
    
    let suggestions = []
    if (voteValue == '1') {
      suggestions = [
        'ã“ã®ä½œå“ã®è‰²ä½¿ã„ãŒéå¸¸ã«ç¾ã—ã„ã¨æ€ã„ã¾ã™ã€‚',
        'æ§‹å›³ã®ãƒãƒ©ãƒ³ã‚¹ãŒçµ¶å¦™ã§å¼•ãè¾¼ã¾ã‚Œã¾ã—ãŸã€‚',
        'ã‚¢ã‚¤ãƒ‡ã‚¢ãŒç‹¬å‰µçš„ã§æ–°é®®ãªå°è±¡ã‚’å—ã‘ã¾ã—ãŸã€‚'
      ]
    } else {
      suggestions = [
        'ã‚‚ã†å°‘ã—æ˜ã‚‹ã„è‰²èª¿ã«ã™ã‚‹ã¨è¦‹ã‚„ã™ããªã‚Šãã†ã§ã™ã€‚',
        'æ§‹å›³ã‚’ã‚‚ã†å°‘ã—å·¥å¤«ã™ã‚‹ã¨è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚',
        'ãƒ†ãƒ¼ãƒãŒã‚ˆã‚Šæ˜ç¢ºã«ãªã‚‹ã¨ä¼ã‚ã‚Šã‚„ã™ããªã‚Šãã†ã§ã™ã€‚'
      ]
    }
    
    suggestionsDiv.innerHTML = suggestions.map(suggestion => 
      `<button type="button" 
               onclick="applySuggestion('${suggestion}')" 
               class="w-full text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 transition-colors">
         ${suggestion}
       </button>`
    ).join('')
  }

  window.applySuggestion = function(suggestion) {
    const commentTextarea = document.getElementById('voteComment')
    if (commentTextarea) {
      const currentText = commentTextarea.value
      if (currentText) {
        commentTextarea.value = currentText + '\n\n' + suggestion
      } else {
        commentTextarea.value = suggestion
      }
      commentTextarea.focus()
    }
  }

  window.applyVoteModalTone = function(tone) {
    const commentTextarea = document.getElementById('voteComment')
    if (!commentTextarea || !commentTextarea.value.trim()) return
    
    let currentText = commentTextarea.value.trim()
    let modifiedText = currentText
    
    switch(tone) {
      case 'è¤’ã‚ã‚‹':
        modifiedText = currentText + 'ã€‚ã¨ã¦ã‚‚ç´ æ™´ã‚‰ã—ã„ä½œå“ã ã¨æ€ã„ã¾ã™ï¼'
        break
      case 'å»ºè¨­çš„':
        modifiedText = 'å»ºè¨­çš„ãªæ„è¦‹ã¨ã—ã¦ã€' + currentText
        break
      case 'å…·ä½“çš„':
        modifiedText = currentText + 'ã€‚å…·ä½“çš„ã«ã¯ã€ã‚‚ã†å°‘ã—è©³ç´°ãªè¡¨ç¾ãŒã‚ã‚‹ã¨è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚'
        break
      case 'æ”¹å–„ææ¡ˆ':
        modifiedText = currentText + 'ã€‚æ”¹å–„ææ¡ˆã¨ã—ã¦å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚'
        break
    }
    
    commentTextarea.value = modifiedText
    commentTextarea.focus()
  }

  // ç”»åƒæ‹¡å¤§è¡¨ç¤ºæ©Ÿèƒ½
  window.showImageModal = function(imageSrc) {
    const modal = document.getElementById('imageModal')
    const modalImage = document.getElementById('modalImage')
    
    if (modal && modalImage) {
      modalImage.src = imageSrc
      document.body.style.overflow = 'hidden'
      modal.classList.remove('hidden')
    }
  }

  window.hideImageModal = function() {
    const modal = document.getElementById('imageModal')
    const modalImage = document.getElementById('modalImage')
    
    if (modal && modalImage) {
      modal.classList.add('hidden')
      modalImage.src = ''
      document.body.style.overflow = ''
    }
  }

  // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.getElementById('imageModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      hideImageModal()
    }
  })

  // AIè¡¨ç¤ºæ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´
  window.adjustLayoutForAI = function(showingAI) {
    const modalLayout = document.getElementById('modalLayout')
    const postContent = document.getElementById('postContent')
    const aiContent = document.getElementById('aiContent')
    const commentSection = document.getElementById('commentSection')
    
    if (!modalLayout || !postContent || !aiContent || !commentSection) return
    
    if (showingAI) {
      // AIè¡¨ç¤ºæ™‚ï¼š2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå·¦ï¼šæŠ•ç¨¿ã€å³ï¼šAIç¸¦é•·ï¼‰ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’æŠ•ç¨¿ã®ä¸‹ã«ç§»å‹•
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
      postContent.className = 'lg:col-span-1 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // AIã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’æ‹¡å¤§
      const aiContainer = aiContent.querySelector('.bg-gradient-to-r')
      if (aiContainer) {
        aiContainer.className = aiContainer.className.replace('min-h-[180px]', 'min-h-[500px]')
      }
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’æŠ•ç¨¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«ç§»å‹•
      commentSection.remove()
      postContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
      
    } else {
      // AIéè¡¨ç¤ºæ™‚ï¼šå…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã™
      const currentAspectRatio = getCurrentImageAspectRatio()
      
      if (currentAspectRatio && currentAspectRatio <= 0.8) {
        // ç¸¦é•·ç”»åƒã®å ´åˆ
        modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
        postContent.className = 'lg:col-span-1 space-y-4'
        aiContent.className = 'lg:col-span-1 space-y-4'
      } else {
        // æ¨ªé•·ãƒ»æ­£æ–¹å½¢ã®å ´åˆ
        modalLayout.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3'
        postContent.className = 'lg:col-span-2 space-y-4'
        aiContent.className = 'lg:col-span-1 space-y-4'
      }
      
      // AIã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’å…ƒã«æˆ»ã™
      const aiContainer = aiContent.querySelector('.bg-gradient-to-r')
      if (aiContainer) {
        aiContainer.className = aiContainer.className.replace('min-h-[500px]', 'min-h-[180px]')
      }
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’AIã®ä¸‹ã«æˆ»ã™
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
    }
  }

  // ç¾åœ¨ã®ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å–å¾—
  window.getCurrentImageAspectRatio = function() {
    const primaryImage = document.getElementById('primaryImage') || document.getElementById('image_0')
    if (primaryImage && primaryImage.complete) {
      return primaryImage.naturalWidth / primaryImage.naturalHeight
    }
    return null
  }

  // ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
  window.checkImageAspectRatio = function(img) {
    const aspectRatio = img.naturalWidth / img.naturalHeight
    const modalLayout = document.getElementById('modalLayout')
    const postContent = document.getElementById('postContent')
    const aiContent = document.getElementById('aiContent')
    const commentSection = document.getElementById('commentSection')
    
    if (!modalLayout || !postContent || !aiContent || !commentSection) return
    
    // ç¸¦é•·ç”»åƒã®å ´åˆï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãŒ0.8ä»¥ä¸‹ï¼‰
    if (aspectRatio <= 0.8) {
      // 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´ï¼ˆå·¦ï¼šæŠ•ç¨¿ã€å³ï¼šAIï¼‰
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3'
      postContent.className = 'lg:col-span-1 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // ç”»åƒã‚’ã‚ˆã‚Šå¤§ããç¸¦é•·ã§è¡¨ç¤º
      img.className = img.className.replace('max-h-80', 'max-h-[500px]').replace('max-h-64', 'max-h-96')
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«ç§»å‹•
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
      
    } else {
      // æ¨ªé•·ãƒ»æ­£æ–¹å½¢ã®å ´åˆã‚‚3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’AIä¸‹ã«é…ç½®
      modalLayout.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-3'
      postContent.className = 'lg:col-span-2 space-y-4'
      aiContent.className = 'lg:col-span-1 space-y-4'
      
      // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«ç§»å‹•
      commentSection.remove()
      aiContent.appendChild(commentSection)
      commentSection.className = 'border-t pt-4 mt-4'
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãéš›ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
  const originalShowVoteModal = window.showVoteModal
  window.showVoteModal = function(value, postId) {
    // å…ƒã®é–¢æ•°ã‚’å®Ÿè¡Œ
    originalShowVoteModal(value, postId)
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’AIã®ä¸‹ã«é…ç½®
    setTimeout(() => {
      const aiContent = document.getElementById('aiContent')
      const commentSection = document.getElementById('commentSection')
      
      if (aiContent && commentSection) {
        commentSection.remove()
        aiContent.appendChild(commentSection)
        commentSection.className = 'border-t pt-4 mt-4'
      }
      
      // ç”»åƒãŒã‚ã‚‹å ´åˆã¯ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ãƒã‚§ãƒƒã‚¯
      const primaryImage = document.getElementById('primaryImage') || document.getElementById('image_0')
      if (primaryImage && primaryImage.complete) {
        checkImageAspectRatio(primaryImage)
      }
    }, 100)
  }
</script>

<!-- è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæŠ•ç¥¨æ¸ˆã¿ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
<% if user_vote != 0 %>
  <div class="max-w-7xl mx-auto mt-8 px-4">
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-xl font-bold mb-6 text-gray-900">è©•ä¾¡ã¨ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
      
      <!-- ãƒ—ãƒ©ã‚¹è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ -->
      <% positive_votes = @post.votes.where(value: 1).where.not(comment: [nil, ""]) %>
      <% if positive_votes.any? %>
        <div class="mb-8">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
              </svg>
            </div>
            <h4 class="text-lg font-semibold text-green-700">ãƒ—ãƒ©ã‚¹è©•ä¾¡ã®ã‚³ãƒ¡ãƒ³ãƒˆ (<%= positive_votes.count %>ä»¶)</h4>
          </div>
          <div class="space-y-3">
            <% positive_votes.order(created_at: :desc).each do |vote| %>
              <div class="bg-green-50 border-l-4 border-green-400 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="font-semibold text-green-800"><%= vote.user.name %></span>
                  <span class="text-xs text-green-600"><%= time_ago_in_words(vote.created_at) %>å‰</span>
                </div>
                <p class="text-green-900"><%= vote.comment %></p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- ãƒã‚¤ãƒŠã‚¹è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ -->
      <% negative_votes = @post.votes.where(value: -1).where.not(comment: [nil, ""]) %>
      <% if negative_votes.any? %>
        <div class="mb-8">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
                <path d="M5 12h14"/>
              </svg>
            </div>
            <h4 class="text-lg font-semibold text-red-700">ãƒã‚¤ãƒŠã‚¹è©•ä¾¡ã®ã‚³ãƒ¡ãƒ³ãƒˆ (<%= negative_votes.count %>ä»¶)</h4>
          </div>
          <div class="space-y-3">
            <% negative_votes.order(created_at: :desc).each do |vote| %>
              <div class="bg-red-50 border-l-4 border-red-400 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="font-semibold text-red-800"><%= vote.user.name %></span>
                  <span class="text-xs text-red-600"><%= time_ago_in_words(vote.created_at) %>å‰</span>
                </div>
                <p class="text-red-900"><%= vote.comment %></p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„å ´åˆã®è¡¨ç¤º -->
      <% if positive_votes.empty? && negative_votes.empty? %>
        <div class="text-center py-8 text-gray-500">
          <p>ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã®è©•ä¾¡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
  <!-- æœªæŠ•ç¥¨ã®å ´åˆã®èª¬æ˜ -->
  <div class="max-w-7xl mx-auto mt-8 px-4">
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-xl font-bold mb-6 text-gray-900">è©•ä¾¡ã¨ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
      <div class="text-center py-12 text-gray-500">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
        </div>
        <h4 class="text-lg font-semibold text-gray-700 mb-2">è©•ä¾¡å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</h4>
        <p class="text-gray-500 mb-4">
          ä»–ã®äººã®è©•ä¾¡ã«å½±éŸ¿ã•ã‚Œãªã„ã‚ˆã†ã€<br>
          ã‚ãªãŸãŒè©•ä¾¡ã—ãŸå¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </p>
        <p class="text-sm text-gray-400">
          ä¸Šã® + ã¾ãŸã¯ - ãƒœã‚¿ãƒ³ã‹ã‚‰è©•ä¾¡ã—ã¦ãã ã•ã„
        </p>
      </div>
    </div>
  </div>
<% end %>

<!-- è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="max-w-7xl mx-auto mt-8 px-4">
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h3 class="text-xl font-bold mb-4 text-gray-900">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
  
  <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
  <%= form_with model: [@post, @comment], local: true, class: "space-y-4 mb-6" do |f| %>
    <div>
      <%= f.text_area :body, rows: 3, placeholder: "ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ...", class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
    </div>
    <div>
      <%= f.file_field :attachments, multiple: true, class: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" %>
    </div>
    <div class="text-right">
      <%= f.submit "ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹", class: "inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
    </div>
  <% end %>
  
  <!-- é€šå¸¸ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
  <% @post.comments.where(parent_id: nil).each do |comment| %>
    <div class="bg-gray-50 rounded-xl shadow p-5 mb-6">
      <div class="flex items-center gap-2 mb-2">
        <span class="font-bold text-gray-700"><%= comment.user&.name || "åŒ¿å" %></span>
        <span class="text-xs text-gray-400"><%= comment.created_at.strftime("%Y-%m-%d %H:%M") %></span>
      </div>
      <p class="mb-3 text-gray-800"><%= comment.body %></p>

      <!-- æŠ•ç¥¨ãƒœã‚¿ãƒ³ -->
      <div class="flex items-center justify-end gap-3 text-sm">
        <%= button_to vote_path(votable_type: 'Comment', votable_id: comment.id, value: 1), method: :post, class: "text-gray-400 hover:text-green-500" do %>
          ğŸ‘
        <% end %>

        <!-- ã‚¿ã‚°æƒ…å ± -->
        <div class="mt-4 pt-3 border-t border-gray-100">
          <span class="font-medium text-gray-500 text-xs">ã‚¿ã‚°:</span>
          <span class="bg-blue-50 text-blue-500 px-2 py-1 rounded-full text-xs ml-1"><%= @post.tag %></span>
        </div>

        <!-- æŠ•ç¥¨ãƒœã‚¿ãƒ³ -->
        <div class="flex items-center justify-end gap-3 mt-4 pt-3 border-t border-gray-100">
          <%= button_to vote_path(votable_type: 'Post', votable_id: @post.id, value: 1), method: :post, class: "text-gray-500 hover:text-green-500" do %>
            ğŸ‘
          <% end %>
          <span class="text-gray-600 font-medium text-sm">
            <%= @post.votes.where(value: 1).count - @post.votes.where(value: -1).count %>
          </span>
          <%= button_to vote_path(votable_type: 'Post', votable_id: @post.id, value: -1), method: :post, class: "text-gray-500 hover:text-red-500" do %>
            ğŸ‘
          <% end %>
        </div>
          </div>
        <% end %>
    
          <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ï¼ˆæŠ•ç¨¿ã®ä¸‹ã«è¡¨ç¤ºï¼‰ -->
      <div class="bg-white rounded-xl shadow-lg p-4">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
          <span>ğŸ’¬</span>
          ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        </h3>
        
        <!-- é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-base font-semibold text-gray-800 flex items-center gap-2">
              <span>ğŸ’¬</span>
              ã‚³ãƒ¡ãƒ³ãƒˆ
            </h4>
            <span class="text-xs text-gray-500"><%= @post.comments.where(parent_id: nil, x_position: nil, y_position: nil).count %>ä»¶</span>
          </div>
          
          <div class="space-y-3 max-h-80 overflow-y-auto">
            <% @post.comments.where(parent_id: nil, x_position: nil, y_position: nil).order(:created_at).each do |comment| %>
              <div class="p-3 bg-gray-50 rounded-lg border-l-4 border-blue-200">
                <div class="flex items-center gap-2 mb-2">
                  <span class="font-medium text-xs text-gray-700"><%= comment.user&.name || "åŒ¿å" %></span>
                  <span class="text-xs text-gray-400"><%= time_ago_in_words(comment.created_at) %>å‰</span>
                </div>
                <p class="text-sm text-gray-800 leading-relaxed mb-2"><%= comment.body %></p>
                
                <!-- æŠ•ç¥¨ãƒœã‚¿ãƒ³ -->
                <div class="flex items-center justify-end gap-2">
                  <%= button_to vote_path(votable_type: 'Comment', votable_id: comment.id, value: 1), method: :post, class: "text-gray-400 hover:text-green-500" do %>
                    ğŸ‘
                  <% end %>
                  <span class="text-gray-600 font-medium text-xs">
                    <%= comment.votes.where(value: 1).count - comment.votes.where(value: -1).count %>
                  </span>
                  <%= button_to vote_path(votable_type: 'Comment', votable_id: comment.id, value: -1), method: :post, class: "text-gray-400 hover:text-red-500" do %>
                    ğŸ‘
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <% if @post.comments.where(parent_id: nil, x_position: nil, y_position: nil).empty? %>
              <p class="text-center text-gray-500 py-6 text-sm">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
            <% end %>
          </div>
        </div>

        <!-- ç”»åƒä¸Šã®ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
        <div data-controller="compact-comments">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-base font-semibold text-gray-800 flex items-center gap-2">
              <span>ğŸ“</span>
              ç”»åƒä¸Šã®ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ
            </h4>
            <% image_comments = @post.comments.where.not(x_position: nil, y_position: nil).order(:created_at) %>
            <span class="text-xs text-gray-500"><%= image_comments.count %>ä»¶</span>
          </div>
          
          <div class="space-y-3 max-h-80 overflow-y-auto">
            <% if image_comments.any? %>
              <% image_comments.each_with_index do |comment, index| %>
                <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400 cursor-pointer hover:bg-blue-100 transition-colors" 
                     data-comment-id="<%= comment.id %>"
                     data-action="click->image-comments-v2#highlightMarker click->compact-comments#highlightComment">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">
                      <%= index + 1 %>
                    </span>
                    <span class="text-xs font-medium text-gray-700"><%= comment.user&.name || "åŒ¿å" %></span>
                    <span class="text-xs text-gray-400"><%= time_ago_in_words(comment.created_at) %>å‰</span>
                  </div>
                  <p class="text-sm text-gray-800 leading-relaxed pl-6"><%= comment.body %></p>
                </div>
              <% end %>
            <% else %>
              <p class="text-center text-gray-500 py-6 text-sm">ç”»åƒä¸Šã®ãƒ”ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“<br><span class="text-xs text-gray-400">ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã§ãã¾ã™</span></p>
            <% end %>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
