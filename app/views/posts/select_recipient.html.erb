<div class="max-w-4xl mx-auto p-6">
  <div class="bg-white rounded-lg shadow-md p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">é€ä¿¡ç›¸æ‰‹ã‚’é¸æŠ</h1>
    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
      <p class="text-sm text-yellow-800">
        <span class="font-semibold">ğŸ“‹ æ³¨æ„:</span> é€ä¿¡ç›¸æ‰‹ã¯æœ€å¤§5äººã¾ã§é¸æŠã§ãã¾ã™ã€‚
      </p>
    </div>
    
    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
      <h3 class="font-bold text-blue-800 mb-2">æŠ•ç¨¿å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <p class="text-lg font-semibold"><%= @post.title %></p>
      <% if @post.body.present? %>
        <p class="text-gray-600 mt-2"><%= truncate(@post.body, length: 100) %></p>
      <% end %>
    </div>

    <%= form_with url: post_send_to_user_path(@post), method: :post, local: true, class: "space-y-8" do |form| %>
      
      <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="space-y-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ã©ã®ã‚ˆã†ãªäººã‹ã‚‰ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã‚‚ã‚‰ã„ã¾ã™ã‹ï¼Ÿ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 transition-colors" id="creator-option">
            <input type="radio" name="advisor_type" value="creator" class="h-4 w-4 text-indigo-600">
            <div class="ml-3">
              <div class="text-lg font-semibold text-gray-800">ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‹ã‚‰ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
              <div class="text-sm text-gray-600">å®Ÿéš›ã«åˆ¶ä½œçµŒé¨“ãŒã‚ã‚‹äººã‹ã‚‰å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
            </div>
          </label>
          <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 transition-colors" id="commenter-option">
            <input type="radio" name="advisor_type" value="commenter" class="h-4 w-4 text-indigo-600">
            <div class="ml-3">
              <div class="text-lg font-semibold text-gray-800">ã‚³ãƒ¡ãƒ³ã‚¿ãƒ¼ã‹ã‚‰ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
              <div class="text-sm text-gray-600">è¦–è´è€…ãƒ»èª­è€…ã®è¦–ç‚¹ã‹ã‚‰æ„Ÿæƒ³ã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
            </div>
          </label>
        </div>
        
        <!-- ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠï¼ˆã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—é¸æŠæ™‚ã«è¡¨ç¤ºï¼‰ -->
        <div id="genre-selection" class="hidden mt-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">å¯¾è±¡ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠ</h3>
          <p class="text-sm text-gray-600 mb-3">ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã™ã‚‹ã¨è‡ªå‹•ã§æ¤œç´¢ã•ã‚Œã¾ã™</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="genre-checkboxes">
            <% ['ã‚¤ãƒ©ã‚¹ãƒˆãƒ»çµµç”»', 'ãƒãƒ³ã‚¬ãƒ»ã‚³ãƒŸãƒƒã‚¯', 'å°èª¬ãƒ»è©©ãƒ»ã‚¨ãƒƒã‚»ã‚¤', 'éŸ³æ¥½åˆ¶ä½œãƒ»ä½œè©ä½œæ›²', 'æ˜ åƒåˆ¶ä½œãƒ»å‹•ç”»ç·¨é›†', 'ã‚²ãƒ¼ãƒ åˆ¶ä½œãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯', 'å†™çœŸãƒ»æ’®å½±æŠ€è¡“', 'èˆå°ãƒ»æ¼”åŠ‡ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', 'æ‰‹èŠ¸ãƒ»ã‚¯ãƒ©ãƒ•ãƒˆ', 'ãã®ä»–'].each do |genre| %>
              <label class="flex items-center p-2 rounded border hover:bg-gray-50">
                <input type="checkbox" name="target_genres[]" value="<%= genre %>" class="h-4 w-4 text-indigo-600 genre-checkbox">
                <span class="ml-2 text-sm"><%= genre %></span>
              </label>
            <% end %>
          </div>
        </div>
      </div>

      <!-- ãƒãƒƒãƒãƒ³ã‚°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="matching-results" class="hidden border-t pt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ãŠã™ã™ã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</h2>
        <p class="text-gray-600 mb-4">çµã‚Šè¾¼ã¿æ¡ä»¶ã«åˆè‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
        <div id="user-list" class="space-y-3">
          <!-- JavaScriptã§å‹•çš„ã«æŒ¿å…¥ -->
        </div>
      </div>

      <!-- ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‹ã‚‰é¸ã¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="space-y-6 border-t pt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‹ã‚‰é¸ã¶</h2>
        <div class="flex gap-3 mb-4">
          <button type="button" id="show-following-btn"
                  class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§ã‚’è¡¨ç¤º
          </button>
          <button type="button" id="show-followers-btn"
                  class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
            ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
          </button>
        </div>
        <div id="following-list" class="hidden space-y-2 mt-4">
          <!-- ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
        <div id="followers-list" class="hidden space-y-2 mt-4">
          <!-- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
      </div>

      <!-- ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="space-y-6 border-t pt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ã¾ãŸã¯ã€ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢</h2>
        <p class="text-sm text-gray-600 mb-3">
          ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ãã‚‹ã“ã¨ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ãƒ»çµŒé¨“ãƒ»å¹´é½¢ãªã©ã§æ¤œç´¢ã§ãã¾ã™
        </p>
        <div class="flex gap-4 mb-4">
          <input type="text" id="user-search" placeholder="ä¾‹ï¼šã‚¤ãƒ©ã‚¹ãƒˆã€DTMã€å°èª¬ã€ãƒŸãƒƒã‚¯ã‚¹ã€20ä»£..." 
                 class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
          <button type="button" id="search-btn" 
                  class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            æ¤œç´¢
          </button>
        </div>
        <div id="search-results" class="space-y-2">
          <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
      </div>

      <!-- é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º -->
      <div id="selected-users" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
        <h3 class="font-semibold text-green-800 mb-2">é€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
        <div id="selected-users-list" class="space-y-2"></div>
        <%= form.hidden_field :selected_user_ids, id: "selected_user_ids" %>
      </div>

      <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
      <div class="text-center pt-6">
        <%= form.submit "é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡", 
            class: "px-8 py-3 bg-indigo-600 text-white rounded-lg font-bold text-lg hover:bg-indigo-700 transition-colors disabled:bg-gray-400", 
            id: "submit-btn", 
            disabled: true %>
      </div>
    <% end %>
  </div>
</div>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="user-profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
      <h2 class="text-xl font-bold text-gray-800">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
      <button type="button" onclick="closeUserProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">
        Ã—
      </button>
    </div>
    <div id="user-profile-content" class="p-6">
      <p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>
</div>

<script>
// ä¿¡ç”¨åº¦ã‚¹ã‚³ã‚¢ã‚’æ˜Ÿã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
function getTrustScoreStars(score) {
  const fullStars = Math.floor(score);
  const hasHalf = (score - fullStars) >= 0.5;
  const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);

  let html = '';
  for (let i = 0; i < fullStars; i++) html += 'â­';
  if (hasHalf) html += 'âœ¨';
  for (let i = 0; i < emptyStars; i++) html += 'â˜†';

  return `${html} <span class="text-xs text-gray-600">(${score.toFixed(1)})</span>`;
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {

  // ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—é¸æŠæ™‚ã®å‡¦ç†
  const advisorTypeInputs = document.querySelectorAll('input[name="advisor_type"]');
  const genreSelection = document.getElementById('genre-selection');
  const creatorOption = document.getElementById('creator-option');
  const commenterOption = document.getElementById('commenter-option');

  advisorTypeInputs.forEach(input => {
    input.addEventListener('change', function() {
      if (this.checked) {
        // ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã‚’è¡¨ç¤º
        genreSelection.classList.remove('hidden');

        // é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
        creatorOption.classList.remove('border-indigo-500', 'bg-indigo-50');
        commenterOption.classList.remove('border-indigo-500', 'bg-indigo-50');

        if (this.value === 'creator') {
          creatorOption.classList.add('border-indigo-500', 'bg-indigo-50');
        } else if (this.value === 'commenter') {
          commenterOption.classList.add('border-indigo-500', 'bg-indigo-50');
        }
      }
    });
  });

  // ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠæ™‚ã®è‡ªå‹•æ¤œç´¢å‡¦ç†
  const genreCheckboxes = document.querySelectorAll('.genre-checkbox');
  genreCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã‚’å®Ÿè¡Œ
      const advisorType = document.querySelector('input[name="advisor_type"]:checked')?.value;
      if (advisorType) {
        showMatchingUsersWithAdvisorType();
      }
    });
  });

});

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
function showUserProfile(userId) {
  const modal = document.getElementById('user-profile-modal');
  const content = document.getElementById('user-profile-content');

  modal.classList.remove('hidden');
  content.innerHTML = '<p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>';

  fetch(`/users/${userId}.json`)
    .then(response => response.json())
    .then(user => {
      content.innerHTML = `
        <div class="space-y-6">
          <div class="text-center">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">${user.name}</h3>
          </div>

          ${user.bio ? `
            <div class="bg-gray-50 rounded-lg p-4">
              <h4 class="font-semibold text-gray-700 mb-2">è‡ªå·±ç´¹ä»‹</h4>
              <p class="text-gray-600 whitespace-pre-wrap">${user.bio}</p>
            </div>
          ` : '<div class="bg-gray-50 rounded-lg p-4 text-center text-gray-500">è‡ªå·±ç´¹ä»‹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'}

          ${user.supporter_profile ? `
            <div class="bg-blue-50 rounded-lg p-4">
              <h4 class="font-semibold text-blue-800 mb-3">ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h4>
              ${user.supporter_profile.can_feedback ? `
                <div class="mb-3">
                  <span class="text-sm font-medium text-gray-700 block mb-1">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ãã‚‹ã“ã¨:</span>
                  <p class="text-sm text-gray-600 whitespace-pre-wrap">${user.supporter_profile.can_feedback}</p>
                </div>
              ` : ''}
              ${user.supporter_profile.creation_genres ? `
                <div class="mb-3">
                  <span class="text-sm font-medium text-gray-700 block mb-1">å‰µä½œã‚¸ãƒ£ãƒ³ãƒ«:</span>
                  <p class="text-sm text-gray-600">${user.supporter_profile.creation_genres}</p>
                </div>
              ` : ''}
              ${user.supporter_profile.creation_experience ? `
                <div class="mb-3">
                  <span class="text-sm font-medium text-gray-700 block mb-1">å‰µä½œçµŒé¨“:</span>
                  <p class="text-sm text-gray-600">${user.supporter_profile.creation_experience}</p>
                </div>
              ` : ''}
            </div>
          ` : '<div class="bg-blue-50 rounded-lg p-4 text-center text-gray-500">ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'}

          <div class="text-center pt-4">
            <a href="/users/${userId}" target="_blank"
               class="inline-block px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
              è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹
            </a>
          </div>
        </div>
      `;
    })
    .catch(error => {
      console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      content.innerHTML = '<p class="text-red-500">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
    });
}

function closeUserProfileModal() {
  document.getElementById('user-profile-modal').classList.add('hidden');
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('user-profile-modal')?.addEventListener('click', function(e) {
  if (e.target === this) {
    closeUserProfileModal();
  }
});

// æ—§showMatchingUsersé–¢æ•°ã¯å‰Šé™¤

async function showMatchingUsersWithAdvisorType() {
  try {
    const advisorType = document.querySelector('input[name="advisor_type"]:checked')?.value;
    const targetGenres = Array.from(document.querySelectorAll('input[name="target_genres[]"]:checked')).map(cb => cb.value);

    const params = new URLSearchParams();
    if (advisorType) params.append('advisor_type', advisorType);
    targetGenres.forEach(g => params.append('target_genres[]', g));
    
    const response = await fetch(`<%= post_match_users_path(@post) %>?${params.toString()}`);
    const data = await response.json();
    
    if (data.error) {
      console.error('Matching error:', data.error);
      return;
    }
    
    displayMatchingResults(data.users, advisorType);
    
  } catch (error) {
    console.error('Matching API error:', error);
  }
}

function displayMatchingResults(users, advisorType = null) {
  const userListDiv = document.getElementById('user-list');
  
  userListDiv.innerHTML = '';
  if (users.length > 0) {
    users.forEach(user => {
      const userDiv = document.createElement('div');
      userDiv.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer';
      
      const advisorBadge = advisorType ? `<span class="inline-block px-2 py-1 text-xs rounded ${
        advisorType === 'creator' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
      }">${advisorType === 'creator' ? 'ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼' : 'ã‚³ãƒ¡ãƒ³ã‚¿ãƒ¼'}</span>` : '';
      
      userDiv.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="flex-1">
            <h4 class="font-semibold cursor-pointer hover:underline" onclick="showUserProfile(${user.id})">${user.name} ${advisorBadge}</h4>
            <p class="text-sm text-gray-600">${user.description}</p>
            <p class="text-xs text-indigo-600 mt-1">ãƒãƒƒãƒåº¦: ${user.score}%</p>
          </div>
          <button type="button" onclick="selectUser(${user.id}, '${user.name}')"
                  class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                  id="select-btn-${user.id}">
            é¸æŠ
          </button>
        </div>
      `;
      userListDiv.appendChild(userDiv);
    });
  } else {
    userListDiv.innerHTML = '<p class="text-gray-500">æ¡ä»¶ã«åˆã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
  }
  document.getElementById('matching-results').classList.remove('hidden');
}

// ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢æ©Ÿèƒ½
document.getElementById('search-btn').addEventListener('click', async () => {
  const query = document.getElementById('user-search').value.trim();
  if (!query) return;
  
  const resultsDiv = document.getElementById('search-results');
  resultsDiv.innerHTML = '<p class="text-gray-500">æ¤œç´¢ä¸­...</p>';
  
  try {
    const response = await fetch(`/search_simple?query=${encodeURIComponent(query)}&search_type=users`);
    const html = await response.text();
    
    // HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãã®ã¾ã¾æŒ¿å…¥
    resultsDiv.innerHTML = html;
    
  } catch (error) {
    console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
    resultsDiv.innerHTML = '<p class="text-red-500">æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
  }
});

// Enterã‚­ãƒ¼ã§ã‚‚æ¤œç´¢å®Ÿè¡Œ
document.getElementById('user-search').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('search-btn').click();
  }
});

// ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§ã‚’è¡¨ç¤º
document.getElementById('show-following-btn').addEventListener('click', async () => {
  const followingListDiv = document.getElementById('following-list');
  const btn = document.getElementById('show-following-btn');

  if (!followingListDiv.classList.contains('hidden')) {
    // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹
    followingListDiv.classList.add('hidden');
    btn.textContent = 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§ã‚’è¡¨ç¤º';
    return;
  }

  followingListDiv.innerHTML = '<p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>';
  followingListDiv.classList.remove('hidden');
  btn.textContent = 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§ã‚’éè¡¨ç¤º';

  try {
    const response = await fetch('/users/<%= current_user.id %>/following.json');
    const following = await response.json();

    if (following.length === 0) {
      followingListDiv.innerHTML = '<p class="text-gray-500">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>';
      return;
    }

    followingListDiv.innerHTML = following.map(user => `
      <div class="p-3 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 flex justify-between items-center">
        <div class="flex items-center gap-2 flex-1">
          <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <h4 class="font-semibold text-blue-900 cursor-pointer hover:underline" onclick="showUserProfile(${user.id})">${user.name}</h4>
              <span class="px-2 py-0.5 text-xs font-bold rounded ${
                user.rank === 'A' ? 'bg-yellow-100 text-yellow-800' :
                user.rank === 'B' ? 'bg-gray-100 text-gray-800' :
                'bg-orange-100 text-orange-800'
              }">ãƒ©ãƒ³ã‚¯${user.rank || 'C'}</span>
              <span class="text-sm">${getTrustScoreStars(user.trust_score || 3.0)}</span>
            </div>
            <p class="text-sm text-blue-700">${user.bio || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æœªè¨­å®š'}</p>
          </div>
        </div>
        <button type="button" onclick="selectUser(${user.id}, '${user.name}')"
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                id="select-btn-${user.id}">
          é¸æŠ
        </button>
      </div>
    `).join('');

  } catch (error) {
    console.error('ãƒ•ã‚©ãƒ­ãƒ¼ä¸­å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    followingListDiv.innerHTML = '<p class="text-red-500">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
  }
});

// ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
document.getElementById('show-followers-btn').addEventListener('click', async () => {
  const followersListDiv = document.getElementById('followers-list');
  const btn = document.getElementById('show-followers-btn');

  if (!followersListDiv.classList.contains('hidden')) {
    // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹
    followersListDiv.classList.add('hidden');
    btn.textContent = 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º';
    return;
  }

  followersListDiv.innerHTML = '<p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>';
  followersListDiv.classList.remove('hidden');
  btn.textContent = 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§ã‚’éè¡¨ç¤º';

  try {
    const response = await fetch('/users/<%= current_user.id %>/followers.json');
    const followers = await response.json();

    if (followers.length === 0) {
      followersListDiv.innerHTML = '<p class="text-gray-500">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒã„ã¾ã›ã‚“</p>';
      return;
    }

    followersListDiv.innerHTML = followers.map(follower => `
      <div class="p-3 border-2 border-purple-500 bg-purple-50 rounded-lg hover:bg-purple-100 flex justify-between items-center">
        <div class="flex items-center gap-2 flex-1">
          <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <h4 class="font-semibold text-purple-900 cursor-pointer hover:underline" onclick="showUserProfile(${follower.id})">${follower.name}</h4>
              <span class="px-2 py-0.5 text-xs font-bold rounded ${
                follower.rank === 'A' ? 'bg-yellow-100 text-yellow-800' :
                follower.rank === 'B' ? 'bg-gray-100 text-gray-800' :
                'bg-orange-100 text-orange-800'
              }">ãƒ©ãƒ³ã‚¯${follower.rank || 'C'}</span>
              <span class="text-sm">${getTrustScoreStars(follower.trust_score || 3.0)}</span>
            </div>
            <p class="text-sm text-purple-700">${follower.bio || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æœªè¨­å®š'}</p>
          </div>
        </div>
        <button type="button" onclick="selectUser(${follower.id}, '${follower.name}')"
                class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700"
                id="select-btn-${follower.id}">
          é¸æŠ
        </button>
      </div>
    `).join('');

  } catch (error) {
    console.error('ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    followersListDiv.innerHTML = '<p class="text-red-500">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
  }
});

// æ¤œç´¢çµæœã‹ã‚‰é¸æŠã™ã‚‹é–¢æ•°
function selectUserFromSearch(userId, userName) {
  selectUser(userId, userName);
}

// é¸æŠæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†ã™ã‚‹é…åˆ—
let selectedUsers = [];

// ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠé–¢æ•°ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œãƒ»5äººåˆ¶é™ï¼‰
function selectUser(userId, userName) {
  const existingIndex = selectedUsers.findIndex(user => user.id === userId);
  const button = document.getElementById(`select-btn-${userId}`);
  
  if (existingIndex !== -1) {
    // æ—¢ã«é¸æŠæ¸ˆã¿ - é¸æŠè§£é™¤
    selectedUsers.splice(existingIndex, 1);
    button.textContent = 'é¸æŠ';
    button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    
    // é¸æŠè§£é™¤æ™‚ã€ä»–ã®ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
    updateButtonStates();
  } else {
    // æ–°è¦é¸æŠ - 5äººåˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (selectedUsers.length >= 5) {
      alert('é€ä¿¡ç›¸æ‰‹ã¯æœ€å¤§5äººã¾ã§é¸æŠã§ãã¾ã™ã€‚');
      return;
    }
    
    selectedUsers.push({ id: userId, name: userName });
    button.textContent = 'é¸æŠæ¸ˆã¿';
    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    button.classList.add('bg-gray-500', 'hover:bg-gray-600');
    
    // 5äººã«é”ã—ãŸå ´åˆã€ä»–ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    if (selectedUsers.length >= 5) {
      updateButtonStates();
    }
  }
  
  updateSelectedUsersDisplay();
}

// é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
function updateSelectedUsersDisplay() {
  const container = document.getElementById('selected-users');
  const list = document.getElementById('selected-users-list');
  const submitBtn = document.getElementById('submit-btn');
  const hiddenInput = document.getElementById('selected_user_ids');
  
  if (selectedUsers.length > 0) {
    // é¸æŠæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º
    list.innerHTML = selectedUsers.map(user => `
      <div class="flex items-center justify-between bg-white p-2 rounded border">
        <span><strong>${user.name}</strong></span>
        <button type="button" onclick="removeUser(${user.id})" 
                class="text-red-500 hover:text-red-700 text-sm">
          å‰Šé™¤
        </button>
      </div>
    `).join('');
    
    container.classList.remove('hidden');
    submitBtn.disabled = false;
    
    // é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
    hiddenInput.value = selectedUsers.map(user => user.id).join(',');
    
    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
    submitBtn.textContent = `${selectedUsers.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡ (${selectedUsers.length}/5)`;
  } else {
    // é¸æŠãªã—ã®çŠ¶æ…‹
    container.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡';
    hiddenInput.value = '';
  }
}

// ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°é–¢æ•°
function updateButtonStates() {
  const allSelectButtons = document.querySelectorAll('[id^="select-btn-"]');
  
  allSelectButtons.forEach(button => {
    const userId = parseInt(button.id.replace('select-btn-', ''));
    const isSelected = selectedUsers.some(user => user.id === userId);
    
    if (!isSelected) {
      if (selectedUsers.length >= 5) {
        // 5äººã«é”ã—ã¦ã„ã‚‹å ´åˆã€æœªé¸æŠãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        button.classList.remove('hover:bg-indigo-700');
      } else {
        // 5äººæœªæº€ã®å ´åˆã€æœªé¸æŠãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        button.disabled = false;
        button.classList.remove('opacity-50', 'cursor-not-allowed');
        button.classList.add('hover:bg-indigo-700');
      }
    }
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤é–¢æ•°
function removeUser(userId) {
  const index = selectedUsers.findIndex(user => user.id === userId);
  if (index !== -1) {
    selectedUsers.splice(index, 1);
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
    const button = document.getElementById(`select-btn-${userId}`);
    if (button) {
      button.textContent = 'é¸æŠ';
      button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
      button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }
    
    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
    updateButtonStates();
    updateSelectedUsersDisplay();
  }
}
</script>
