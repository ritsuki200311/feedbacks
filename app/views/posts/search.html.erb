<div class="px-4 py-8">
  <h1 class="text-3xl font-bold mb-8 text-center">検索機能</h1>

  <!-- 検索タイプ選択タブ -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="flex justify-center mb-6">
      <div class="inline-flex bg-gray-100 rounded-lg p-1">
        <%= link_to "ユーザー検索", search_posts_path(search_type: 'users'), 
            class: "px-6 py-2 rounded-md font-medium transition-colors #{'bg-white text-blue-600 shadow' if @search_type == 'users'} #{'text-gray-600 hover:text-gray-800' if @search_type != 'users'}" %>
        <%= link_to "投稿検索", search_posts_path(search_type: 'posts'), 
            class: "px-6 py-2 rounded-md font-medium transition-colors #{'bg-white text-blue-600 shadow' if @search_type == 'posts'} #{'text-gray-600 hover:text-gray-800' if @search_type != 'posts'}" %>
        <%= link_to "タグ検索", search_posts_path(search_type: 'tags'), 
            class: "px-6 py-2 rounded-md font-medium transition-colors #{'bg-white text-blue-600 shadow' if @search_type == 'tags'} #{'text-gray-600 hover:text-gray-800' if @search_type != 'tags'}" %>
      </div>
    </div>

    <!-- ユーザー検索フォーム -->
    <% if @search_type == 'users' %>
      <%= form_with url: search_posts_path, method: :get, local: true, class: "space-y-4" do |form| %>
        <%= form.hidden_field :search_type, value: 'users' %>
        <div class="max-w-md mx-auto">
          <div class="text-center mb-4">
            <h2 class="text-xl font-semibold mb-2">ユーザーID検索</h2>
            <p class="text-gray-600">ユーザーのIDを入力してマイページを表示します</p>
          </div>
          <div class="flex gap-2">
            <%= form.number_field :query, value: @query, placeholder: "ユーザーID（数字）を入力", 
                class: "flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
            <%= form.submit "表示", class: "bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium" %>
          </div>
        </div>
      <% end %>
    <% end %>

    <!-- 投稿検索フォーム -->
    <% if @search_type == 'posts' %>
      <%= form_with url: search_posts_path, method: :get, local: true, class: "space-y-4" do |form| %>
        <%= form.hidden_field :search_type, value: 'posts' %>
        <div class="max-w-md mx-auto">
          <div class="text-center mb-4">
            <h2 class="text-xl font-semibold mb-2">投稿内容検索</h2>
            <p class="text-gray-600">タイトルや本文からキーワードで検索します</p>
          </div>
          <div class="flex gap-2">
            <%= form.text_field :query, value: @query, placeholder: "検索キーワードを入力", 
                class: "flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
            <%= form.submit "検索", class: "bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium" %>
          </div>
        </div>
      <% end %>
    <% end %>

    <!-- タグ検索フォーム -->
    <% if @search_type == 'tags' %>
      <%= form_with url: search_posts_path, method: :get, local: true, class: "space-y-6" do |form| %>
        <%= form.hidden_field :search_type, value: 'tags' %>
        <div class="text-center mb-6">
          <h2 class="text-xl font-semibold mb-2">タグ検索</h2>
          <p class="text-gray-600">創作の種類、タグ、リクエストから投稿を検索します</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- 創作の種類 -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold mb-3">創作の種類</h3>
            <% @creation_types.each do |creation_type| %>
              <label class="flex items-center mb-2">
                <%= form.radio_button :creation_type, creation_type, checked: params[:creation_type] == creation_type, 
                    class: "form-radio h-4 w-4 text-blue-600" %>
                <span class="ml-2 text-gray-700"><%= creation_type %></span>
              </label>
            <% end %>
          </div>

          <!-- タグ選択 -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold mb-3">タグ</h3>
            <% if @tag_options %>
              <% @tag_options.each do |tag| %>
                <label class="flex items-center mb-2">
                  <%= form.check_box :tag_list, { checked: params[:tag_list]&.include?(tag), multiple: true }, tag, "" %>
                  <span class="ml-2 text-gray-700 text-sm"><%= tag %></span>
                </label>
              <% end %>
            <% else %>
              <p class="text-gray-500 text-sm">タグ情報を読み込み中...</p>
            <% end %>
          </div>

          <!-- リクエスト -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold mb-3">リクエスト</h3>
            <% if @request_tags %>
              <% @request_tags.each do |request_tag| %>
                <label class="flex items-center mb-2">
                  <%= form.radio_button :request_tag, request_tag, checked: params[:request_tag] == request_tag, 
                      class: "form-radio h-4 w-4 text-blue-600" %>
                  <span class="ml-2 text-gray-700 text-sm"><%= request_tag %></span>
                </label>
              <% end %>
            <% else %>
              <p class="text-gray-500 text-sm">リクエスト情報を読み込み中...</p>
            <% end %>
          </div>
        </div>

        <div class="text-center">
          <%= form.submit "タグで検索", class: "bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium" %>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- 検索結果 -->
  <% if @results&.any? %>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-semibold mb-4">
        検索結果 (<%= @results.size %>件)
      </h2>

      <% if @search_type == 'users' %>
        <!-- ユーザー検索結果 -->
        <div class="space-y-4">
          <% @results.each do |user| %>
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold">
                    <%= link_to user.name, user_path(user), class: "text-blue-600 hover:underline" %>
                  </h3>
                  <p class="text-gray-600">ID: <%= user.id %></p>
                  <p class="text-gray-500">登録日: <%= user.created_at.strftime('%Y年%m月%d日') %></p>
                </div>
                <div>
                  <%= link_to "マイページを見る", user_path(user), 
                      class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- 投稿検索結果 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <% @results.each do |post| %>
            <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow">
              <!-- 画像表示 -->
              <% if post.images.attached? %>
                <div class="mb-3" data-controller="image-aspect-ratio">
                  <% post.images.limit(1).each do |image| %>
                    <div class="relative">
                      <%= image_tag image, class: "w-full h-32 object-cover rounded", 
                          data: { "image-aspect-ratio-target": "image" } %>
                      <% if post.images.count > 1 %>
                        <div class="absolute -top-2 -right-2 bg-blue-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">
                          +<%= post.images.count - 1 %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="mb-3 h-32 bg-gray-100 rounded flex items-center justify-center">
                  <div class="text-gray-400 text-2xl">📄</div>
                </div>
              <% end %>

              <h3 class="text-lg font-semibold mb-2">
                <%= link_to post.title, post_path(post), class: "text-blue-600 hover:underline" %>
              </h3>
              <p class="text-gray-700 text-sm mb-3" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                <%= truncate(post.body, length: 80) %>
              </p>
              
              <!-- タグ表示 -->
              <% if post.tag.present? %>
                <div class="flex flex-wrap gap-1 mb-3">
                  <% post.tag_list.first(2).each do |tag| %>
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">
                      <%= tag.strip %>
                    </span>
                  <% end %>
                </div>
              <% end %>
              
              <div class="flex items-center justify-between text-sm text-gray-500">
                <span>投稿者: <%= post.user&.name || "不明" %></span>
                <span><%= post.created_at.strftime('%m/%d') %></span>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% elsif @query.present? || params[:creation_type].present? || params[:tag_list].present? || params[:request_tag].present? %>
    <!-- 検索したが結果がない場合 -->
    <div class="bg-white rounded-lg shadow-md p-8 text-center">
      <div class="text-4xl mb-4">🔍</div>
      <h2 class="text-xl font-semibold text-gray-700 mb-2">検索結果が見つかりません</h2>
      <p class="text-gray-500">別のキーワードやタグで検索してみてください。</p>
    </div>
  <% else %>
    <!-- 初期表示 -->
    <div class="bg-white rounded-lg shadow-md p-8 text-center">
      <div class="text-4xl mb-4">🔎</div>
      <h2 class="text-xl font-semibold text-gray-700 mb-2">検索を始めましょう</h2>
      <p class="text-gray-500">上記のフォームから検索条件を入力してください。</p>
    </div>
  <% end %>
</div>

<!-- Image aspect ratio controller script -->
<script type="module">
  import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"
  
  const application = Application.start()
  
  class ImageAspectRatioController extends Controller {
    static targets = ["image"]

    connect() {
      this.imageTarget.addEventListener('load', () => {
        this.checkAspectRatio()
      })
      
      if (this.imageTarget.complete) {
        this.checkAspectRatio()
      }
    }

    checkAspectRatio() {
      const img = this.imageTarget
      const aspectRatio = img.naturalWidth / img.naturalHeight
      
      if (aspectRatio >= 1.5) {
        img.classList.remove('h-32')
        img.classList.add('h-24', 'landscape-image')
      } else if (aspectRatio < 0.8) {
        img.classList.remove('h-32')
        img.classList.add('h-16', 'portrait-image')
      }
    }
  }
  
  application.register("image-aspect-ratio", ImageAspectRatioController)
  
  // 検索タイプ選択時に自動フォーカス
  document.addEventListener('DOMContentLoaded', function() {
    const searchType = '<%= @search_type %>';
    
    // 即座にフォーカスを当てる
    if (searchType === 'users') {
      const userInput = document.querySelector('input[name="query"][type="number"]');
      if (userInput) {
        userInput.focus();
      }
    } else if (searchType === 'posts') {
      const postInput = document.querySelector('input[name="query"][type="text"]');
      if (postInput) {
        postInput.focus();
      }
    }
  });
</script>