<div class="max-w-7xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-2 text-gray-900">ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢ä¿‚æ€§ã®å¯è¦–åŒ–</h1>
  <p class="text-gray-600 mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å†…å®¹ã‚’åŸºã«ã€ã‚ãªãŸã¨è¿‘ã„é–¢å¿ƒã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã—ã¾ã™ã€‚</p>
  
  <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
  <% if Rails.env.development? %>
    <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm">
      <h3 class="font-semibold mb-2">ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</h3>
      <p>ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: <%= current_user.name %> (ID: <%= current_user.id %>)</p>
      <p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: <%= @users_with_profiles&.count || 0 %></p>
      <p>é¡ä¼¼åº¦è¨ˆç®—å¯¾è±¡: <%= @users_data&.count || 0 %>äºº</p>
      <% if @users_data.present? %>
        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <%= @users_data.map { |u| u[:name] }.join(', ') %></p>
      <% else %>
        <p class="text-red-600">@users_dataãŒç©ºã§ã™</p>
      <% end %>
    </div>
  <% end %>
  
  <!-- å‡¡ä¾‹ -->
  <div class="mb-6 p-4 bg-blue-50 rounded-lg">
    <h2 class="text-lg font-semibold mb-3 text-gray-800">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ã®é¡ä¼¼åº¦ã«ã‚ˆã‚‹é–¢ä¿‚æ€§è¡¨ç¤º</h2>
    <div class="flex flex-wrap gap-4 text-sm mb-3">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-red-500"></div>
        <span>ã‚ãªãŸï¼ˆä¸­å¿ƒï¼‰</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-green-500"></div>
        <span>é«˜ã„é¡ä¼¼åº¦ï¼ˆ80%ä»¥ä¸Šï¼‰</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
        <span>ä¸­ç¨‹åº¦ã®é¡ä¼¼åº¦ï¼ˆ60-80%ï¼‰</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-orange-500"></div>
        <span>ä½ã„é¡ä¼¼åº¦ï¼ˆ40-60%ï¼‰</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-gray-400"></div>
        <span>ä½ã„é¡ä¼¼åº¦ï¼ˆ40%æœªæº€ï¼‰</span>
      </div>
    </div>
    <div class="flex flex-wrap gap-4 text-sm mb-2">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-purple-600 border-2 border-yellow-400"></div>
        <span>æŠ•ç¨¿è€…ï¼ˆä½œå“æŠ•ç¨¿ã‚ã‚Šï¼‰</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-gray-500"></div>
        <span>è¦–è´è€…ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ï¼‰</span>
      </div>
    </div>
    <p class="text-xs text-gray-600">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã€Œèˆˆå‘³ãƒ»é–¢å¿ƒã€ã€Œæ”¯æ´ã‚¸ãƒ£ãƒ³ãƒ«ã€ã€Œæ€§æ ¼å‚¾å‘ã€ãªã©ã®å›ç­”å†…å®¹ã‹ã‚‰é¡ä¼¼åº¦ã‚’ç®—å‡ºã—ã€åŒå¿ƒå††çŠ¶ã«é…ç½®ã—ã¦ã„ã¾ã™ã€‚</p>
    <p class="text-xs text-gray-600 mt-1">æŠ•ç¨¿è€…ã¯å¤§ããªå††ã§ã€è¦–è´è€…ã¯å°ã•ãªå††ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ›ãƒãƒ¼ã™ã‚‹ã¨æŠ•ç¨¿ã‚„ã‚³ãƒ¡ãƒ³ãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚</p>
  </div>
  
  <!-- å¯è¦–åŒ–ã‚¨ãƒªã‚¢ -->
  <div class="bg-white rounded-lg shadow-lg p-6">
    <% if @users_data.present? %>
      <div id="user-network" class="w-full" style="height: 700px;"></div>
    <% else %>
      <div class="text-center py-12">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">è¡¨ç¤ºã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</h3>
        <p class="text-gray-600">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ã„ã‚‹ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¾ã ã„ãªã„ã‚ˆã†ã§ã™ã€‚</p>
        <p class="text-gray-500 text-sm mt-2">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨ã€ã“ã“ã«é–¢ä¿‚æ€§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>
    <% end %>
  </div>
  
  <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
  <div id="user-tooltip" class="fixed bg-gray-800 text-white text-sm rounded-lg p-3 shadow-lg z-50 pointer-events-none opacity-0 transition-opacity duration-200 max-w-sm">
    <div id="tooltip-content">
      <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å†…å®¹ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </div>
  </div>
  
  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="user-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900" id="modal-user-name"></h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="modal-user-content" class="space-y-3 text-sm">
          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>
        <div class="mt-4 text-center">
          <span class="text-lg font-semibold text-blue-600" id="modal-similarity"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<% if @users_data.present? %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
  const currentUserData = <%= raw @current_user_data.to_json %>;
  const usersData = <%= raw @users_data.to_json %>;
  
  console.log('Raw currentUserData:', currentUserData);
  console.log('Raw usersData:', usersData);
  
  // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
  if (!currentUserData) {
    console.error('currentUserData is null or undefined');
    return;
  }
  
  if (!usersData || !Array.isArray(usersData)) {
    console.error('usersData is not an array or is null');
    return;
  }
  
  // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å«ã‚€ï¼‰
  const allUsers = [currentUserData, ...usersData];
  
  // SVGã®è¨­å®š
  const width = document.getElementById('user-network').offsetWidth;
  const height = 700;
  
  const svg = d3.select('#user-network')
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  // åŸºæœ¬è¨­å®š
  const centerX = width / 2;
  const centerY = height / 2;
  
  // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
  console.log('All Users:', allUsers);
  console.log('Number of users:', allUsers.length);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‰²è¨­å®šï¼ˆé¡ä¼¼åº¦ã«åŸºã¥ãã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  function getUserColor(user) {
    if (user.id === currentUserData.id) return '#ef4444'; // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èµ¤è‰²
    
    // é¡ä¼¼åº¦ã«åŸºã¥ã„ã¦è‰²ã‚’æ±ºå®š
    if (user.similarity >= 0.8) {
      return '#22c55e'; // ç·‘è‰² - é«˜ã„é¡ä¼¼åº¦
    } else if (user.similarity >= 0.6) {
      return '#3b82f6'; // é’è‰² - ä¸­ç¨‹åº¦ã®é¡ä¼¼åº¦
    } else if (user.similarity >= 0.4) {
      return '#f97316'; // ã‚ªãƒ¬ãƒ³ã‚¸è‰² - ä½ã„é¡ä¼¼åº¦
    } else {
      return '#9ca3af'; // ã‚°ãƒ¬ãƒ¼è‰² - éå¸¸ã«ä½ã„é¡ä¼¼åº¦
    }
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŠå¾„è¨­å®šï¼ˆæŠ•ç¨¿è€…/è¦–è´è€…ã§åŒºåˆ¥ï¼‰
  function getUserRadius(user) {
    if (user.id === currentUserData.id) return 15;
    
    // æŠ•ç¨¿è€…ã¯å¤§ããã€è¦–è´è€…ã¯å°ã•ã
    const isCreator = user.posts_count > 0;
    const baseRadius = isCreator ? 12 : 8;
    const similarityBonus = user.similarity * (isCreator ? 8 : 4);
    
    return Math.max(isCreator ? 8 : 6, baseRadius + similarityBonus);
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨­å®šï¼ˆæŠ•ç¨¿è€…ã¯é‡‘è‰²ã®æ ï¼‰
  function getUserStroke(user) {
    if (user.id === currentUserData.id) return '#fff';
    
    const isCreator = user.posts_count > 0;
    return isCreator ? '#fbbf24' : '#fff'; // æŠ•ç¨¿è€…ã¯é‡‘è‰²ã€è¦–è´è€…ã¯ç™½
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å¹…è¨­å®š
  function getUserStrokeWidth(user) {
    if (user.id === currentUserData.id) return 2;
    
    const isCreator = user.posts_count > 0;
    return isCreator ? 3 : 2; // æŠ•ç¨¿è€…ã¯å¤ªã„æ 
  }
  
  // åŒå¿ƒå††ã®èƒŒæ™¯ã‚’æç”»ï¼ˆé¡ä¼¼åº¦ãƒ¬ãƒ™ãƒ«ã‚’è¡¨ã™ï¼‰
  const maxRadius = Math.min(width, height) * 0.35;
  const similarityLevels = [
    { threshold: 0.8, radius: maxRadius * 0.3, color: 'rgba(34, 197, 94, 0.1)', label: 'é«˜ã„é¡ä¼¼åº¦(80%ä»¥ä¸Š)' },
    { threshold: 0.6, radius: maxRadius * 0.5, color: 'rgba(59, 130, 246, 0.1)', label: 'ä¸­ç¨‹åº¦ã®é¡ä¼¼åº¦(60-80%)' },
    { threshold: 0.4, radius: maxRadius * 0.7, color: 'rgba(249, 115, 22, 0.1)', label: 'ä½ã„é¡ä¼¼åº¦(40-60%)' },
    { threshold: 0.0, radius: maxRadius, color: 'rgba(156, 163, 175, 0.1)', label: 'ä½ã„é¡ä¼¼åº¦(40%æœªæº€)' }
  ];

  similarityLevels.reverse().forEach(level => {
    svg.append('circle')
      .attr('cx', centerX)
      .attr('cy', centerY)
      .attr('r', level.radius)
      .attr('fill', level.color)
      .attr('stroke', level.color.replace('0.1', '0.3'))
      .attr('stroke-width', 1)
      .attr('stroke-dasharray', '3,3');
  });

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ‰ã‚’æç”»
  console.log('Creating user nodes...');
  allUsers.forEach((user, index) => {
    console.log(`Processing user ${index}:`, user);
    
    let x, y;
    
    if (user.id === currentUserData.id) {
      // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¸­å¿ƒã«é…ç½®
      x = centerX;
      y = centerY;
    } else {
      // é¡ä¼¼åº¦ã«åŸºã¥ã„ã¦è·é›¢ã‚’æ±ºå®š
      let targetRadius;
      if (user.similarity >= 0.8) {
        targetRadius = maxRadius * 0.3;
      } else if (user.similarity >= 0.6) {
        targetRadius = maxRadius * 0.5;
      } else if (user.similarity >= 0.4) {
        targetRadius = maxRadius * 0.7;
      } else {
        targetRadius = maxRadius;
      }
      
      // åŒã˜é¡ä¼¼åº¦ãƒ¬ãƒ™ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’è€ƒæ…®ã—ã¦è§’åº¦ã‚’åˆ†æ•£
      const angle = (index / allUsers.length) * 2 * Math.PI + Math.random() * 0.5 - 0.25;
      const radiusVariation = targetRadius * 0.15; // Â±15%ã®å¹…ã§ãƒ©ãƒ³ãƒ€ãƒ 
      const finalRadius = targetRadius + (Math.random() - 0.5) * radiusVariation;
      
      x = centerX + Math.cos(angle) * finalRadius;
      y = centerY + Math.sin(angle) * finalRadius;
    }
    
    console.log(`User ${user.name}: position (${x}, ${y}), similarity: ${user.similarity}`);
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®æƒ…å ±ã‚’ä¿å­˜
    user.x = x;
    user.y = y;
    user.radius = getUserRadius(user);
    
    // å††ã‚’æç”»
    const circle = svg.append('circle')
      .attr('cx', x)
      .attr('cy', y)
      .attr('r', getUserRadius(user))
      .attr('fill', getUserColor(user))
      .attr('stroke', getUserStroke(user))
      .attr('stroke-width', getUserStrokeWidth(user))
      .style('cursor', 'pointer')
      .on('click', function() {
        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ãƒšãƒ¼ã‚¸ã¸
        if (user.id === currentUserData.id) {
          window.location.href = '/users/mypage';
        } else {
          window.location.href = `/users/${user.id}`;
        }
      })
      .on('mouseover', function(event) {
        showTooltip(event, user);
      })
      .on('mousemove', function(event) {
        moveTooltip(event, user);
      })
      .on('mouseout', function() {
        hideTooltip();
      });
    
    // ãƒ©ãƒ™ãƒ«ã‚’æç”»
    svg.append('text')
      .attr('x', x)
      .attr('y', y + getUserRadius(user) + 15)
      .text(user.name)
      .attr('font-size', '12px')
      .attr('text-anchor', 'middle')
      .attr('font-weight', user.id === currentUserData.id ? 'bold' : 'normal')
      .style('fill', '#374151');
  });
  
  console.log(`Drew ${allUsers.length} users`);
  
  // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ©Ÿèƒ½
  function showTooltip(event, userData) {
    const tooltip = document.getElementById('user-tooltip');
    const content = document.getElementById('tooltip-content');
    
    // ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªå–å¾—ï¼ˆundefinedã‚„nullã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
    const postsCount = userData.posts_count || 0;
    const commentsCount = userData.comments_count || 0;
    const isCreator = postsCount > 0;
    const similarity = userData.similarity || 0;
    
    let tooltipContent = `
      <div class="font-semibold text-blue-300 mb-2">${userData.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
      <div class="text-xs text-gray-300 mb-2">é¡ä¼¼åº¦: ${Math.round(similarity * 100)}%</div>
    `;
    
    if (isCreator) {
      tooltipContent += `
        <div class="border-t border-gray-600 pt-2">
          <div class="text-yellow-300 font-semibold mb-1">ğŸ“ æŠ•ç¨¿è€…ï¼ˆ${postsCount}ä»¶ã®æŠ•ç¨¿ï¼‰</div>
      `;
      
      if (userData.recent_posts && userData.recent_posts.length > 0) {
        tooltipContent += '<div class="text-xs"><strong>æœ€è¿‘ã®æŠ•ç¨¿:</strong></div>';
        userData.recent_posts.slice(0, 2).forEach(post => {
          const date = new Date(post.created_at).toLocaleDateString('ja-JP');
          tooltipContent += `<div class="text-xs text-gray-300">â€¢ ${post.title || 'ç„¡é¡Œ'} (${date})</div>`;
        });
      } else {
        tooltipContent += '<div class="text-xs text-gray-400">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }
      tooltipContent += '</div>';
    } else {
      tooltipContent += `
        <div class="border-t border-gray-600 pt-2">
          <div class="text-blue-300 font-semibold mb-1">ğŸ‘ï¸ è¦–è´è€…ï¼ˆ${commentsCount}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰</div>
      `;
      
      if (userData.recent_comments && userData.recent_comments.length > 0) {
        tooltipContent += '<div class="text-xs"><strong>æœ€è¿‘ã®ã‚³ãƒ¡ãƒ³ãƒˆ:</strong></div>';
        userData.recent_comments.slice(0, 2).forEach(comment => {
          const date = new Date(comment.created_at).toLocaleDateString('ja-JP');
          tooltipContent += `<div class="text-xs text-gray-300">â€¢ ${comment.body || 'ã‚³ãƒ¡ãƒ³ãƒˆ'} (${date})</div>`;
        });
      } else if (commentsCount === 0) {
        tooltipContent += '<div class="text-xs text-gray-400">ã¾ã æ´»å‹•ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        tooltipContent += '<div class="text-xs text-gray-400">ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ã‚’å–å¾—ä¸­...</div>';
      }
      tooltipContent += '</div>';
    }
    
    content.innerHTML = tooltipContent;
    tooltip.style.opacity = '1';
    moveTooltip(event, userData);
  }
  
  function moveTooltip(event, userData) {
    const tooltip = document.getElementById('user-tooltip');
    const svgElement = document.querySelector('#user-network svg');
    const svgRect = svgElement.getBoundingClientRect();
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å††ã®ä½ç½®ã‚’åŸºæº–ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’é…ç½®
    const userScreenX = svgRect.left + userData.x;
    const userScreenY = svgRect.top + userData.y;
    const userRadius = userData.radius || 10;
    
    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®é…ç½®ä½ç½®ã‚’è¨ˆç®—ï¼ˆå††ã®å³ä¸Šã«è¡¨ç¤ºï¼‰
    let left = userScreenX + userRadius + 10;
    let top = userScreenY - userRadius - 10;
    
    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ã¯ã¿å‡ºãªã„ã‚ˆã†ã«èª¿æ•´
    const tooltipRect = tooltip.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // å³ç«¯ã‹ã‚‰ã¯ã¿å‡ºã‚‹å ´åˆã¯å·¦å´ã«è¡¨ç¤º
    if (left + tooltipRect.width > viewportWidth) {
      left = userScreenX - userRadius - tooltipRect.width - 10;
    }
    
    // ä¸Šç«¯ã‹ã‚‰ã¯ã¿å‡ºã‚‹å ´åˆã¯ä¸‹å´ã«è¡¨ç¤º
    if (top < 0) {
      top = userScreenY + userRadius + 10;
    }
    
    // ä¸‹ç«¯ã‹ã‚‰ã¯ã¿å‡ºã‚‹å ´åˆã¯ä¸Šå´ã«èª¿æ•´
    if (top + tooltipRect.height > viewportHeight) {
      top = viewportHeight - tooltipRect.height - 10;
    }
    
    // å·¦ç«¯ã‹ã‚‰ã¯ã¿å‡ºã‚‹å ´åˆã¯å³å´ã«èª¿æ•´
    if (left < 0) {
      left = 10;
    }
    
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
  }
  
  function hideTooltip() {
    const tooltip = document.getElementById('user-tooltip');
    tooltip.style.opacity = '0';
  }
  
});
</script>
<% end %>

<style>
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    #user-network {
      height: 400px !important;
    }
    
    .max-w-7xl {
      max-width: 100%;
      padding: 0 1rem;
    }
  }
</style>