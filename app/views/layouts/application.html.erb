<!DOCTYPE html>
<html>
  <head>
    <title>„Ç¢„Éó„É™Âêç</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Application CSS „Çí„Ç§„É≥„É©„Ç§„É≥Âüã„ÇÅËæº„Åø -->
    <style>
      .thumbnail {
          max-width: 200px;
          max-height: 200px;
          object-fit: cover;
          display: block;
        }

      /* „Ç≥„É≥„Éë„ÇØ„Éà„Ç≥„É°„É≥„Éà„Éè„Ç§„É©„Ç§„ÉàÁî®„Çπ„Çø„Ç§„É´ */
      .compact-comment-highlight {
        background-color: #fef3c7 !important;
        border-color: #f59e0b !important;
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.3) !important;
        transform: scale(1.02);
        transition: all 0.3s ease-in-out;
      }

      /* line-clamp-2 utility for text truncation */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñË™øÊï¥ */
      @media (max-width: 1279px) {
        .xl\\:col-span-6 {
          grid-column: span 12 / span 12;
        }
        .xl\\:col-span-3 {
          grid-column: span 12 / span 12;
        }
      }


      /* LINEÈ¢®„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„ÅÆ„Çπ„Çø„Ç§„É´ */

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #79a2d1;
      }

      .chat-header {
        background-color: #3d4a5d;
        color: white;
        padding: 15px;
        text-align: center;
      }

      .chat-header h2 {
        margin: 0;
        font-size: 1.2em;
      }

      .chat-box {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .message-row {
        display: flex;
        margin-bottom: 15px;
      }

      .message-row.sent {
        justify-content: flex-end;
      }

      .message-row.received {
        justify-content: flex-start;
      }

      .message {
        max-width: 70%;
        display: flex;
        align-items: flex-end;
      }

      .message-body {
        padding: 10px 15px;
        border-radius: 20px;
        color: #333;
        word-wrap: break-word;
      }

      .sent .message-body {
        background-color: #8de055;
        color: black;
      }

      .received .message-body {
        background-color: #ffffff;
      }

      .message-time {
        font-size: 0.75em;
        color: #999;
        margin: 0 5px;
        white-space: nowrap;
      }

      .message-form-container {
        padding: 10px;
        background-color: #f0f0f0;
        border-top: 1px solid #ddd;
      }

      .message-form {
        display: flex;
        align-items: center;
      }

      .message-form textarea {
        flex-grow: 1;
        border-radius: 20px;
        border: 1px solid #ccc;
        padding: 10px 15px;
        resize: none;
        min-height: 20px;
        max-height: 100px;
        overflow-y: auto;
      }

      .send-button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        margin-left: 10px;
        cursor: pointer;
      }

      .send-button:hover {
        background-color: #45a049;
      }
    </style>
    
    <!-- Stimulus JavaScript -->
    <script type="module">
      import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"
      
      const application = Application.start()
      
      // Image Test Controller
      class ImageTestController extends Controller {
        static targets = ["image"]
        
        connect() {
          console.log("Image Test Controller connected!")
        }

        imageClicked() {
          console.log("Image clicked via test controller!")
          alert("Image click detected!")
        }
      }
      
      // Image Comments Controller  
      class ImageCommentsController extends Controller {
        static targets = ["image", "form", "commentForm", "markersContainer", "toggleButton", "toggleIcon", "toggleText", "markerCount"]
        static values = { postId: Number, readOnly: Boolean }

        connect() {
          console.log("Image Comments Controller connected!")
          console.log("Post ID:", this.postIdValue)
          console.log("Read Only:", this.readOnlyValue)
          console.log("Available targets:", this.targets)
          console.log("Has toggleButton target:", this.hasToggleButtonTarget)
          
          // „Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö„Åå„ÅÇ„Çå„Å∞ÂàùÊúüÁä∂ÊÖã„ÅØ„Åù„Çå„Å´Âæì„ÅÜ„ÄÅË™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®„ÅÆÂ†¥Âêà
          if (this.readOnlyValue) {
            this.markersVisible = localStorage.getItem('globalCommentPinsVisible') === 'true'
          } else {
            this.markersVisible = false // Ë©≥Á¥∞„Éö„Éº„Ç∏„Åß„ÅØÂæìÊù•ÈÄö„Çä
          }
          
          // Ë™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÇØ„É™„ÉÉ„ÇØ„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
          if (!this.readOnlyValue) {
            this.setupImageClickListener()
          }
          
          this.loadExistingComments()
          this.setupResizeListener()
          this.updateToggleButton()
          
          // „Ç∞„É≠„Éº„Éê„É´„Éî„É≥Âàá„ÇäÊõø„Åà„Ç§„Éô„É≥„Éà„ÇíÁõ£Ë¶ñÔºà„Åô„Åπ„Å¶„ÅÆ„É¢„Éº„Éâ„ÅßÔºâ
          window.addEventListener('globalCommentPinsToggled', this.handleGlobalToggle.bind(this))
        }

        setupResizeListener() {
          // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„Å´„Éû„Éº„Ç´„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÂÜçË®àÁÆó
          let resizeTimeout
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout)
            resizeTimeout = setTimeout(() => {
              if (this.existingComments) {
                console.log("Recalculating marker positions after resize")
                this.renderComments(this.existingComments)
              }
            }, 150) // „Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ
          })
        }

        setupImageClickListener() {
          console.log("Setting up image click listener...")
          if (!this.hasImageTarget) {
            console.error("Image target not found!")
            return
          }
          
          this.imageTarget.addEventListener("click", (event) => {
            console.log("Image clicked!")
            const rect = this.imageTarget.getBoundingClientRect()
            const x = event.clientX - rect.left
            const y = event.clientY - rect.top
            
            // ÁîªÂÉè„Å´ÂØæ„Åô„ÇãÁõ∏ÂØæÁöÑ„Å™‰ΩçÁΩÆÔºà„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ôºâ„Åß‰øùÂ≠ò
            const xPercent = (x / rect.width) * 100
            const yPercent = (y / rect.height) * 100
            
            console.log(`Click position: ${x}, ${y} (${xPercent.toFixed(2)}%, ${yPercent.toFixed(2)}%)`)
            
            this.hideForm()
            this.showFormAt(x, y, xPercent, yPercent)
          })
        }

        showFormAt(x, y, xPercent, yPercent) {
          console.log("Showing form at:", x, y, `(${xPercent}%, ${yPercent}%)`)
          if (!this.hasFormTarget) {
            console.error("Form target not found!")
            return
          }
          
          this.formTarget.style.left = x + "px"
          this.formTarget.style.top = y + "px"
          this.formTarget.classList.remove("hidden")
          console.log("Form should be visible now")
          
          // „Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„Åß‰ΩçÁΩÆ„Çí‰øùÂ≠ò
          const xField = this.formTarget.querySelector("input[name='comment[x_position]']")
          const yField = this.formTarget.querySelector("input[name='comment[y_position]']")
          
          if (xField) xField.value = xPercent.toFixed(2)
          if (yField) yField.value = yPercent.toFixed(2)
          
          const textarea = this.formTarget.querySelector("textarea")
          if (textarea) {
            textarea.focus()
            textarea.value = ""
          }
        }

        hideForm() {
          if (this.hasFormTarget) {
            this.formTarget.classList.add("hidden")
          }
        }

        async loadExistingComments() {
          console.log("Loading existing comments...")
          
          try {
            const response = await fetch(`/posts/${this.postIdValue}/comments.json`)
            if (response.ok) {
              const comments = await response.json()
              const imageComments = comments.filter(comment => 
                comment.x_position !== null && comment.y_position !== null
              )
              console.log("Loaded image comments:", imageComments)
              this.existingComments = imageComments
              
              // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Åó„Å¶„Åã„Çâ„Ç≥„É°„É≥„Éà„ÇíÊèèÁîª
              if (this.hasImageTarget) {
                if (this.imageTarget.complete && this.imageTarget.naturalWidth > 0) {
                  this.renderComments(imageComments)
                } else {
                  this.imageTarget.addEventListener('load', () => {
                    this.renderComments(imageComments)
                  }, { once: true })
                  // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                  setTimeout(() => {
                    this.renderComments(imageComments)
                  }, 200)
                }
              }
              
              // Ë™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®„É¢„Éº„Éâ„ÅßÊó¢Â≠ò„ÅÆ„Ç≥„É°„É≥„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂàùÊúüÁä∂ÊÖã„Åß„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
              if (this.readOnlyValue && imageComments.length > 0) {
                this.markersVisible = localStorage.getItem('globalCommentPinsVisible') === 'true'
              } else if (imageComments.length > 0) {
                this.markersVisible = true
              }
            } else {
              console.log("Could not load comments via API, using fallback")
              this.loadCommentsFromDOM()
            }
          } catch (error) {
            console.error("Error loading comments:", error)
            this.loadCommentsFromDOM()
          }
        }

        loadCommentsFromDOM() {
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: DOMË¶ÅÁ¥†„Åã„ÇâË™≠„ÅøËæº„Åø
          const commentElements = document.querySelectorAll('[data-comment-id]')
          const comments = []
          
          commentElements.forEach((element, index) => {
            const commentId = element.dataset.commentId
            const commentText = element.querySelector('p')?.textContent
            
            if (commentText && element.closest('.bg-blue-50')) {
              comments.push({
                id: commentId,
                body: commentText.trim(),
                x_position: 25 + (index * 10), // ‰ªÆ„ÅÆ‰ΩçÁΩÆÔºà„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ôºâ
                y_position: 25 + (index * 5),
                number: index + 1
              })
            }
          })
          
          this.existingComments = comments
          this.renderComments(comments)
          
          // Êó¢Â≠ò„ÅÆ„Ç≥„É°„É≥„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂàùÊúüÁä∂ÊÖã„Åß„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
          if (comments.length > 0) {
            this.markersVisible = true
          }
        }

        renderComments(comments) {
          if (!this.hasMarkersContainerTarget) {
            console.error("Markers container not found!")
            return
          }
          
          const container = this.markersContainerTarget
          container.innerHTML = "" // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
          
          comments.forEach((comment, index) => {
            this.createMarker(comment, index + 1)
          })
          
          // „Éû„Éº„Ç´„ÉºË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
          if (this.hasMarkersContainerTarget) {
            this.markersContainerTarget.style.display = this.markersVisible ? 'block' : 'none'
          }
          this.updateToggleButton()
        }

        createMarker(comment, number) {
          if (!this.hasImageTarget) {
            console.error("Image target not found for marker creation!")
            return
          }
          
          const marker = document.createElement("div")
          marker.className = "absolute w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold cursor-pointer z-10 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-200 hover:scale-110"
          marker.textContent = number
          marker.dataset.commentId = comment.id
          marker.style.pointerEvents = "auto"
          
          // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Åó„Å¶„Åã„Çâ„Éû„Éº„Ç´„Éº„ÅÆ‰ΩçÁΩÆ„ÇíË®≠ÂÆö
          const positionMarker = () => {
            const imageRect = this.imageTarget.getBoundingClientRect()
            console.log(`Image rect for marker ${number}:`, imageRect.width, 'x', imageRect.height)
            
            // ÁîªÂÉè„Çµ„Ç§„Ç∫„Åå0„ÅÆÂ†¥Âêà„ÅØÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å
            if (imageRect.width === 0 || imageRect.height === 0) {
              console.log(`Image not ready for marker ${number}, retrying...`)
              setTimeout(positionMarker, 100)
              return
            }
            
            const xPixel = (comment.x_position / 100) * imageRect.width
            const yPixel = (comment.y_position / 100) * imageRect.height
            
            marker.style.left = `${xPixel}px`
            marker.style.top = `${yPixel}px`
            
            console.log(`Marker #${number} positioned at (${xPixel}, ${yPixel}) from (${comment.x_position}%, ${comment.y_position}%)`)
          }
          
          // ÁîªÂÉè„ÅåÊó¢„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if (this.imageTarget.complete && this.imageTarget.naturalWidth > 0) {
            positionMarker()
          } else {
            // ÁîªÂÉè„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
            this.imageTarget.addEventListener('load', positionMarker, { once: true })
            // Êó¢„Å´Ë™≠„ÅøËæº„ÅøÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            setTimeout(positionMarker, 100)
          }
          
          // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó‰ΩúÊàê
          const tooltip = document.createElement("div")
          tooltip.className = "absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-gray-800 text-white text-xs rounded py-1 px-2 whitespace-nowrap z-20 opacity-0 transition-opacity duration-200 pointer-events-none"
          tooltip.textContent = comment.body
          tooltip.style.maxWidth = "300px"
          tooltip.style.whiteSpace = "nowrap"
          tooltip.style.overflow = "hidden"
          tooltip.style.textOverflow = "ellipsis"
          
          // „Éû„Éº„Ç´„Éº„Å´„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíËøΩÂä†
          marker.appendChild(tooltip)
          
          // „Éõ„Éê„Éº„Ç§„Éô„É≥„Éà
          marker.addEventListener("mouseenter", () => {
            tooltip.style.opacity = "1"
          })
          
          marker.addEventListener("mouseleave", () => {
            tooltip.style.opacity = "0"
          })
          
          // „Éû„Éº„Ç´„Éº„Ç≥„É≥„ÉÜ„Éä„Éº„Å´ËøΩÂä†
          this.markersContainerTarget.appendChild(marker)
          console.log(`Created marker #${number} at (${comment.x_position}, ${comment.y_position})`)
        }

        async submitComment(event) {
          event.preventDefault()
          console.log("Submitting comment...")
          
          const form = event.target
          const formData = new FormData(form)
          
          try {
            const response = await fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
              }
            })
            
            if (response.ok) {
              const comment = await response.json()
              console.log("Comment submitted successfully:", comment)
              
              // Êñ∞„Åó„ÅÑ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
              const currentMarkersCount = this.markersContainerTarget.children.length
              this.createMarker(comment, currentMarkersCount + 1)
              
              // „Éû„Éº„Ç´„Éº„ÇíË°®Á§∫Áä∂ÊÖã„Å´Âàá„ÇäÊõø„Åà
              this.markersVisible = true
              if (this.hasMarkersContainerTarget) {
                this.markersContainerTarget.style.display = 'block'
              }
              this.updateToggleButton()
              
              // „Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
              this.hideForm()
              
              // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
              this.showSuccessMessage()
              
              // 1ÁßíÂæå„Å´„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÈÄöÂ∏∏„ÅÆ„Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞
              setTimeout(() => {
                window.location.reload()
              }, 1000)
            } else {
              const errorData = await response.json()
              console.error('Comment submission failed:', errorData)
              alert('„Ç≥„É°„É≥„Éà„ÅÆÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ')
            }
          } catch (error) {
            console.error('Error submitting comment:', error)
            alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ')
          }
        }

        showSuccessMessage() {
          const message = document.createElement('div')
          message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50'
          message.textContent = '„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ'
          document.body.appendChild(message)
          
          setTimeout(() => {
            message.remove()
          }, 3000)
        }

        toggleMarkers() {
          console.log("Toggling markers visibility")
          console.log("Current state:", this.markersVisible)
          console.log("Has markers container:", this.hasMarkersContainerTarget)
          
          this.markersVisible = !this.markersVisible
          console.log("New state:", this.markersVisible)
          
          if (this.hasMarkersContainerTarget) {
            const container = this.markersContainerTarget
            console.log("Container children count:", container.children.length)
            container.style.display = this.markersVisible ? 'block' : 'none'
            console.log("Container display set to:", container.style.display)
          }
          
          this.updateToggleButton()
          
          // Ë©≥Á¥∞„Éö„Éº„Ç∏„ÅßÂÄãÂà•„Éà„Ç∞„É´„ÇíÊìç‰Ωú„Åó„ÅüÂ†¥Âêà„ÄÅ„Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã„ÇÇÊõ¥Êñ∞
          if (!this.readOnlyValue) {
            localStorage.setItem('globalCommentPinsVisible', this.markersVisible)
            // „Ç∞„É≠„Éº„Éê„É´„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„Å´„ÇÇÈÄöÁü•
            const globalController = document.querySelector('[data-controller*="global-comment-pins"]')
            if (globalController) {
              const controller = this.application.getControllerForElementAndIdentifier(globalController, 'global-comment-pins')
              if (controller) {
                controller.syncFromIndividual(this.markersVisible)
              }
            }
          }
        }

        updateToggleButton() {
          if (!this.hasToggleButtonTarget) return
          
          const button = this.toggleButtonTarget
          const icon = this.hasToggleIconTarget ? this.toggleIconTarget : null
          const text = this.hasToggleTextTarget ? this.toggleTextTarget : null
          const count = this.hasMarkerCountTarget ? this.markerCountTarget : null
          
          if (this.markersVisible) {
            // „Éû„Éº„Ç´„ÉºË°®Á§∫‰∏≠„ÅÆÁä∂ÊÖã
            button.classList.remove('border-gray-300', 'hover:bg-gray-50')
            button.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700')
            if (icon) icon.textContent = 'üôà'
            if (text) text.textContent = '„Ç≥„É°„É≥„Éà„Éî„É≥„ÇíÈùûË°®Á§∫'
          } else {
            // „Éû„Éº„Ç´„ÉºÈùûË°®Á§∫‰∏≠„ÅÆÁä∂ÊÖã
            button.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700')
            button.classList.add('border-gray-300', 'hover:bg-gray-50')
            if (icon) icon.textContent = 'üëÅÔ∏è'
            if (text) text.textContent = '„Ç≥„É°„É≥„Éà„Éî„É≥„ÇíË°®Á§∫'
          }
          
          // „Éû„Éº„Ç´„ÉºÊï∞„ÇíË°®Á§∫
          if (count && this.hasMarkersContainerTarget) {
            const markerCount = this.markersContainerTarget.children.length
            if (markerCount > 0) {
              count.textContent = `(${markerCount}‰ª∂„ÅÆ„Ç≥„É°„É≥„Éà)`
            } else {
              count.textContent = ''
            }
          }
        }

        // „Ç∞„É≠„Éº„Éê„É´„Éî„É≥Âàá„ÇäÊõø„Åà„Ç§„Éô„É≥„Éà„ÅÆ„Éè„É≥„Éâ„É©„Éº
        handleGlobalToggle(event) {
          console.log("Global toggle received:", event.detail.visible, "ReadOnly:", this.readOnlyValue)
          this.markersVisible = event.detail.visible
          if (this.hasMarkersContainerTarget) {
            this.markersContainerTarget.style.display = this.markersVisible ? 'block' : 'none'
          }
          this.updateToggleButton()
        }

        // „Ç∞„É≠„Éº„Éê„É´„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„ÇãÈñ¢Êï∞
        setGlobalMarkersVisibility(visible) {
          console.log("Setting global visibility:", visible, "ReadOnly:", this.readOnlyValue)
          this.markersVisible = visible
          if (this.hasMarkersContainerTarget) {
            this.markersContainerTarget.style.display = this.markersVisible ? 'block' : 'none'
          }
          this.updateToggleButton()
        }

        disconnect() {
          // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§Ôºà„Åô„Åπ„Å¶„ÅÆ„É¢„Éº„Éâ„ÅßÔºâ
          window.removeEventListener('globalCommentPinsToggled', this.handleGlobalToggle.bind(this))
        }
      }

      // Global Comment Pins Controller
      class GlobalCommentPinsController extends Controller {
        static targets = ["toggleButton", "toggleIcon", "toggleText"]

        connect() {
          console.log("Global Comment Pins Controller connected!")
          this.globalPinsVisible = localStorage.getItem('globalCommentPinsVisible') === 'true'
          this.updateButtonState()
          this.updateAllPins()
        }

        toggleGlobalPins() {
          console.log("Toggling global comment pins")
          this.globalPinsVisible = !this.globalPinsVisible
          localStorage.setItem('globalCommentPinsVisible', this.globalPinsVisible)
          
          this.updateButtonState()
          this.updateAllPins()
          
          // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åó„Å¶‰ªñ„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„Å´ÈÄöÁü•
          window.dispatchEvent(new CustomEvent('globalCommentPinsToggled', {
            detail: { visible: this.globalPinsVisible }
          }))
        }

        updateButtonState() {
          if (!this.hasToggleButtonTarget) return
          
          const button = this.toggleButtonTarget
          const icon = this.hasToggleIconTarget ? this.toggleIconTarget : null
          const text = this.hasToggleTextTarget ? this.toggleTextTarget : null
          
          if (this.globalPinsVisible) {
            button.classList.remove('border-gray-300', 'hover:bg-gray-50')
            button.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700')
            if (icon) icon.textContent = 'üôà'
            if (text) text.textContent = '„Ç≥„É°„É≥„Éà„Éî„É≥‰∏ÄÊã¨ÈùûË°®Á§∫'
          } else {
            button.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700')
            button.classList.add('border-gray-300', 'hover:bg-gray-50')
            if (icon) icon.textContent = 'üëÅÔ∏è'
            if (text) text.textContent = '„Ç≥„É°„É≥„Éà„Éî„É≥‰∏ÄÊã¨Ë°®Á§∫'
          }
        }

        updateAllPins() {
          // „Åô„Åπ„Å¶„ÅÆimage-comments„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÅÆ„Éû„Éº„Ç´„Éº„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
          const imageCommentsElements = document.querySelectorAll('[data-controller*="image-comments"]')
          imageCommentsElements.forEach(element => {
            const controller = this.application.getControllerForElementAndIdentifier(element, 'image-comments')
            if (controller) {
              controller.setGlobalMarkersVisibility(this.globalPinsVisible)
            }
          })
        }

        // ÂÄãÂà•„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„Åã„Çâ„ÅÆÂêåÊúü
        syncFromIndividual(visible) {
          this.globalPinsVisible = visible
          this.updateButtonState()
        }
      }
      
      // AI Comment Assistant Controller
      class AiCommentAssistantController extends Controller {
        static targets = [
          "toggleButton", "assistantContent", "loading", "results", "error",
          "commentExamples", "observationPoints", "observationToggle", "observationIcon"
        ]
        static values = { postId: Number }

        connect() {
          console.log("AI Comment Assistant Controller connected!")
          console.log("Post ID:", this.postIdValue)
        }

        async toggleAssistant() {
          const isHidden = this.assistantContentTarget.classList.contains('hidden')
          
          if (isHidden) {
            // Ë£úÂä©Ê©üËÉΩ„ÇíÈñãÂßã
            this.assistantContentTarget.classList.remove('hidden')
            this.toggleButtonTarget.textContent = 'Ë£úÂä©„ÇíÈñâ„Åò„Çã'
            this.toggleButtonTarget.classList.remove('bg-blue-600', 'hover:bg-blue-700')
            this.toggleButtonTarget.classList.add('bg-gray-500', 'hover:bg-gray-600')
            
            // Êó¢„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂàÜÊûê„Çí„Çπ„Ç≠„ÉÉ„Éó
            if (!this.resultsTarget.classList.contains('hidden')) {
              return
            }
            
            // AIÂàÜÊûê„ÇíÈñãÂßã
            await this.analyzePost()
          } else {
            // Ë£úÂä©Ê©üËÉΩ„ÇíÈñâ„Åò„Çã
            this.assistantContentTarget.classList.add('hidden')
            this.toggleButtonTarget.textContent = 'Ë£úÂä©„ÇíÈñãÂßã'
            this.toggleButtonTarget.classList.remove('bg-gray-500', 'hover:bg-gray-600')
            this.toggleButtonTarget.classList.add('bg-blue-600', 'hover:bg-blue-700')
          }
        }

        async analyzePost() {
          // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
          this.showLoading()
          
          try {
            const response = await fetch(`/posts/${this.postIdValue}/ai_comment_assistant/analyze`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
              }
            })
            
            const data = await response.json()
            
            if (data.success) {
              this.displayResults(data.comment_examples, data.observation_points)
            } else {
              this.showError(data.error || 'AIÂàÜÊûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ')
            }
          } catch (error) {
            console.error('AI Comment Assistant Error:', error)
            this.showError('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ')
          }
        }

        showLoading() {
          this.hideAllStates()
          this.loadingTarget.classList.remove('hidden')
        }

        displayResults(commentExamples, observationPoints) {
          this.hideAllStates()
          
          // „Ç≥„É°„É≥„Éà‰æã„ÇíË°®Á§∫
          this.renderCommentExamples(commentExamples)
          
          // Ë¶≥ÂØü„Éù„Ç§„É≥„Éà„ÇíË°®Á§∫
          this.renderObservationPoints(observationPoints)
          
          this.resultsTarget.classList.remove('hidden')
        }

        showError(message) {
          this.hideAllStates()
          this.errorTarget.textContent = message
          this.errorTarget.classList.remove('hidden')
        }

        hideAllStates() {
          this.loadingTarget.classList.add('hidden')
          this.resultsTarget.classList.add('hidden')
          this.errorTarget.classList.add('hidden')
        }

        renderCommentExamples(examples) {
          this.commentExamplesTarget.innerHTML = ''
          
          examples.forEach((example, index) => {
            const exampleDiv = document.createElement('div')
            exampleDiv.className = 'p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer'
            exampleDiv.innerHTML = `
              <div class="flex items-start gap-3">
                <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-semibold">${index + 1}</span>
                <div class="flex-1">
                  <p class="text-gray-800 leading-relaxed">${this.escapeHtml(example)}</p>
                  <div class="mt-2 flex gap-2">
                    <button type="button" 
                            class="text-xs text-blue-600 hover:text-blue-800 font-medium"
                            data-action="click->ai-comment-assistant#useComment"
                            data-comment="${this.escapeHtml(example)}">
                      „Åì„ÅÆ„Ç≥„É°„É≥„Éà„Çí‰ΩøÁî®
                    </button>
                    <button type="button" 
                            class="text-xs text-gray-500 hover:text-gray-700 font-medium"
                            data-action="click->ai-comment-assistant#editComment"
                            data-comment="${this.escapeHtml(example)}">
                      Á∑®ÈõÜ„Åó„Å¶‰ΩøÁî®
                    </button>
                  </div>
                </div>
              </div>
            `
            this.commentExamplesTarget.appendChild(exampleDiv)
          })
        }

        renderObservationPoints(points) {
          this.observationPointsTarget.innerHTML = ''
          
          const pointsList = document.createElement('ul')
          pointsList.className = 'space-y-2'
          
          points.forEach(point => {
            const li = document.createElement('li')
            li.className = 'flex items-start gap-2 text-gray-700'
            li.innerHTML = `
              <span class="flex-shrink-0 w-2 h-2 bg-blue-400 rounded-full mt-2"></span>
              <span>${this.escapeHtml(point)}</span>
            `
            pointsList.appendChild(li)
          })
          
          this.observationPointsTarget.appendChild(pointsList)
        }

        toggleObservationPoints() {
          const isHidden = this.observationPointsTarget.classList.contains('hidden')
          
          if (isHidden) {
            this.observationPointsTarget.classList.remove('hidden')
            this.observationIconTarget.textContent = '‚ñ≤'
          } else {
            this.observationPointsTarget.classList.add('hidden')
            this.observationIconTarget.textContent = '‚ñº'
          }
        }

        useComment(event) {
          const comment = event.currentTarget.dataset.comment
          this.insertCommentIntoForm(comment)
        }

        editComment(event) {
          const comment = event.currentTarget.dataset.comment
          this.insertCommentIntoForm(comment)
          
          // „Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É†„Å´„Éï„Ç©„Éº„Ç´„Çπ„ÇíÂΩì„Å¶„Çã
          const commentTextArea = document.querySelector('textarea[name="comment[body]"]')
          if (commentTextArea) {
            commentTextArea.focus()
            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÊúÄÂæå„Å´„Ç´„Éº„ÇΩ„É´„ÇíÁßªÂãï
            commentTextArea.setSelectionRange(commentTextArea.value.length, commentTextArea.value.length)
          }
        }

        insertCommentIntoForm(comment) {
          const commentTextArea = document.querySelector('textarea[name="comment[body]"]')
          if (commentTextArea) {
            commentTextArea.value = comment
            
            // È´ò„Åï„ÇíËá™ÂãïË™øÊï¥Ôºà„ÇÇ„Åóauto-resize„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
            commentTextArea.dispatchEvent(new Event('input', { bubbles: true }))
            
            // ÊàêÂäü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            this.showSuccessMessage('„Ç≥„É°„É≥„Éà„Çí„Éï„Ç©„Éº„É†„Å´ÊåøÂÖ•„Åó„Åæ„Åó„Åü')
          } else {
            console.error('Comment textarea not found')
            alert('„Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')
          }
        }

        showSuccessMessage(message) {
          const successDiv = document.createElement('div')
          successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-0 opacity-100 transition-all duration-300'
          successDiv.textContent = message
          
          document.body.appendChild(successDiv)
          
          // 3ÁßíÂæå„Å´„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
          setTimeout(() => {
            successDiv.classList.add('translate-x-full', 'opacity-0')
            setTimeout(() => {
              if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv)
              }
            }, 300)
          }, 3000)
        }

        escapeHtml(text) {
          const div = document.createElement('div')
          div.textContent = text
          return div.innerHTML
        }
      }
      
      // Compact Comments Controller
      class CompactCommentsController extends Controller {
        static targets = ["toggleButton", "toggleIcon", "commentsList"]

        connect() {
          console.log("Compact Comments Controller connected!")
          this.isExpanded = false
        }

        toggleComments() {
          this.isExpanded = !this.isExpanded
          
          if (this.isExpanded) {
            // „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇíË°®Á§∫
            this.commentsListTarget.classList.remove('hidden')
            this.toggleIconTarget.textContent = '‚ñ≤'
          } else {
            // „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇíÈùûË°®Á§∫
            this.commentsListTarget.classList.add('hidden')
            this.toggleIconTarget.textContent = '‚ñº'
          }
        }

        // „Ç≥„É≥„Éë„ÇØ„Éà„Ç≥„É°„É≥„Éà„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÊôÇ„ÅÆÂá¶ÁêÜ
        highlightComment(event) {
          const commentElement = event.currentTarget
          const commentId = commentElement.dataset.commentId
          
          // Êó¢Â≠ò„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Çí„É™„Çª„ÉÉ„Éà
          document.querySelectorAll('.compact-comment-highlight').forEach(el => {
            el.classList.remove('compact-comment-highlight')
          })
          
          // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Ç≥„É°„É≥„Éà„Çí„Éè„Ç§„É©„Ç§„Éà
          commentElement.classList.add('compact-comment-highlight')
          
          // ÂØæÂøú„Åô„Çã„Éî„É≥„Åå„ÅÇ„Çå„Å∞„Éè„Ç§„É©„Ç§„ÉàÔºàÊó¢Â≠ò„ÅÆÊ©üËÉΩ„ÇíÊ¥ªÁî®Ôºâ
          if (commentId) {
            const imageController = document.querySelector('[data-controller*="image-comments"]')
            if (imageController) {
              const event = new CustomEvent('highlightMarker', {
                detail: { commentId: commentId }
              })
              imageController.dispatchEvent(event)
            }
          }
          
          // 2ÁßíÂæå„Å´„Éè„Ç§„É©„Ç§„Éà„ÇíÂâäÈô§
          setTimeout(() => {
            commentElement.classList.remove('compact-comment-highlight')
          }, 2000)
        }
      }

      // AI Sidebar Controller
      class AiSidebarController extends Controller {
        static targets = [
          "toggleButton", "toggleIcon", "toggleText", 
          "initialMessage", "loading", "aiContent",
          "commentSuggestions", "summary"
        ]
        static values = { postId: Number }

        connect() {
          console.log("AI Sidebar Controller connected!")
          this.aiLoaded = false
        }

        toggleAI() {
          const isAIVisible = !this.aiContentTarget.classList.contains('hidden')
          
          if (isAIVisible) {
            // AIÊ©üËÉΩ„ÇíÈñâ„Åò„Çã
            this.closeAI()
          } else {
            // AIÊ©üËÉΩ„ÇíÈñãÂßã
            this.startAI()
          }
        }

        async startAI() {
          // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈö†„Åô
          this.initialMessageTarget.classList.add('hidden')
          
          // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
          this.loadingTarget.classList.remove('hidden')
          
          // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
          this.toggleIconTarget.textContent = '‚è≥'
          this.toggleTextTarget.textContent = 'AIÂàÜÊûê‰∏≠...'
          this.toggleButtonTarget.disabled = true

          try {
            if (!this.aiLoaded) {
              // AIÊ©üËÉΩ„ÇíÂàùÂõû„ÅÆ„ÅøË™≠„ÅøËæº„Åø
              await this.loadAIContent()
              this.aiLoaded = true
            }
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíÈö†„Åó„Å¶„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
            this.loadingTarget.classList.add('hidden')
            this.aiContentTarget.classList.remove('hidden')
            
            // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            this.toggleIconTarget.textContent = '‚úñÔ∏è'
            this.toggleTextTarget.textContent = 'AIË£úÂä©„ÇíÈñâ„Åò„Çã'
            this.toggleButtonTarget.classList.remove('bg-purple-600', 'hover:bg-purple-700')
            this.toggleButtonTarget.classList.add('bg-gray-600', 'hover:bg-gray-700')
            
          } catch (error) {
            console.error('AI loading error:', error)
            this.showError()
          } finally {
            this.toggleButtonTarget.disabled = false
          }
        }

        closeAI() {
          // „Åô„Åπ„Å¶„ÅÆAIÈñ¢ÈÄ£Ë¶ÅÁ¥†„ÇíÈö†„Åô
          this.loadingTarget.classList.add('hidden')
          this.aiContentTarget.classList.add('hidden')
          
          // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
          this.initialMessageTarget.classList.remove('hidden')
          
          // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
          this.toggleIconTarget.textContent = 'ü§ñ'
          this.toggleTextTarget.textContent = 'AIË£úÂä©„ÇíÈñãÂßã'
          this.toggleButtonTarget.classList.remove('bg-gray-600', 'hover:bg-gray-700')
          this.toggleButtonTarget.classList.add('bg-purple-600', 'hover:bg-purple-700')
        }

        async loadAIContent() {
          try {
            // ÂÆüÈöõ„ÅÆAIÂàÜÊûêAPI„ÇíÂëº„Å≥Âá∫„Åó
            const response = await fetch(`/posts/${this.postIdValue}/ai_comment_assistant/analyze`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
              }
            })
            
            const data = await response.json()
            
            if (data.success) {
              // AIÂàÜÊûêÁµêÊûú„ÇíË°®Á§∫
              this.renderSuggestions(data.comment_examples)
              
              // Ë¶≥ÂØü„Éù„Ç§„É≥„Éà„ÇíË¶ÅÁ¥Ñ„Å®„Åó„Å¶Ë°®Á§∫
              if (this.hasSummaryTarget && data.observation_points) {
                const summary = data.observation_points.join(' / ')
                this.summaryTarget.textContent = `Ë¶≥ÂØü„Éù„Ç§„É≥„Éà: ${summary}`
              }
            } else {
              // „Ç®„É©„ÉºÊôÇ„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
              this.renderFallbackContent()
            }
          } catch (error) {
            console.error('AI analysis error:', error)
            this.renderFallbackContent()
          }
        }

        renderFallbackContent() {
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ
          const fallbackSuggestions = [
            "„Åì„ÅÆÊäïÁ®ø„ÅÆË°®ÁèæÂäõ„ÅåÁ¥†Êô¥„Çâ„Åó„ÅÑ„Åß„Åô„Å≠„ÄÇÁâπ„Å´Âç∞Ë±°ÁöÑ„Å™ÈÉ®ÂàÜ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
            "„Å®„Å¶„ÇÇËààÂë≥Ê∑±„ÅÑÂÜÖÂÆπ„Åß„Åô„ÄÇ„Å©„ÅÆ„Çà„ÅÜ„Å™ÊÄù„ÅÑ„ÅßÂà∂‰Ωú„Åï„Çå„Åü„ÅÆ„Åß„Åó„Çá„ÅÜ„ÅãÔºü",
            "ÊäÄË°ìÁöÑ„Å™Â∑•Â§´„ÅåÊÑü„Åò„Çâ„Çå„ÇãÊäïÁ®ø„Åß„Åô„Å≠„ÄÇ‰ªäÂæå„ÅÆ‰ΩúÂìÅ„ÇÇÊ•Ω„Åó„Åø„Åß„Åô„ÄÇ"
          ]
          
          this.renderSuggestions(fallbackSuggestions)
          
          if (this.hasSummaryTarget) {
            this.summaryTarget.textContent = "ÊäïÁ®ø„ÅÆÂÜÖÂÆπ„ÇÑÊäÄÊ≥ï„Å´Ê≥®ÁõÆ„Åó„Å¶„ÄÅÂª∫Ë®≠ÁöÑ„Å™„Ç≥„É°„É≥„Éà„ÇíÂøÉ„Åå„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ"
          }
        }

        renderSuggestions(suggestions) {
          this.commentSuggestionsTarget.innerHTML = ''
          
          suggestions.forEach((suggestion, index) => {
            const suggestionElement = document.createElement('div')
            suggestionElement.className = 'p-2 bg-purple-50 rounded border cursor-pointer hover:bg-purple-100 transition-colors text-sm mb-2'
            suggestionElement.innerHTML = `
              <p class="text-gray-700 mb-2">${suggestion}</p>
              <button class="text-xs text-purple-600 hover:text-purple-800 font-medium" 
                      data-action="click->ai-sidebar#applySuggestion" 
                      data-suggestion="${suggestion}">
                „Åì„ÅÆ„Ç≥„É°„É≥„Éà„Çí‰ΩøÁî®
              </button>
            `
            this.commentSuggestionsTarget.appendChild(suggestionElement)
          })
        }

        simulateAIProcessing() {
          // AIÂá¶ÁêÜ„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
          return new Promise(resolve => {
            setTimeout(resolve, 1500)
          })
        }

        showError() {
          this.loadingTarget.classList.add('hidden')
          this.initialMessageTarget.classList.remove('hidden')
          
          const errorMessage = document.createElement('div')
          errorMessage.className = 'text-center py-4 text-red-600 text-sm'
          errorMessage.textContent = 'AIÊ©üËÉΩ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
          
          this.initialMessageTarget.appendChild(errorMessage)
          
          setTimeout(() => {
            errorMessage.remove()
          }, 5000)
        }

        applySuggestion(event) {
          const suggestion = event.currentTarget.dataset.suggestion
          this.insertIntoCommentField(suggestion)
        }

        applyTone(event) {
          const tone = event.currentTarget.dataset.tone
          const currentText = this.getCurrentCommentText()
          
          let tonePrefix = ""
          switch(tone) {
            case "Ë§í„ÇÅ„Çã":
              tonePrefix = "Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ"
              break
            case "Ë≥™Âïè":
              tonePrefix = "ËààÂë≥Ê∑±„ÅÑ„Åß„Åô„Å≠„ÄÇ"
              break
            case "Âª∫Ë®≠ÁöÑ":
              tonePrefix = "ÊîπÂñÑÊ°à„Å®„Åó„Å¶„ÄÅ"
              break
            case "Âä±„Åæ„Åó":
              tonePrefix = "È†ëÂºµ„Å£„Å¶„ÅÑ„Åæ„Åô„Å≠ÔºÅ"
              break
          }
          
          const newText = currentText ? `${tonePrefix} ${currentText}` : tonePrefix
          this.insertIntoCommentField(newText)
        }

        insertIntoCommentField(text) {
          // „É°„Ç§„É≥„ÅÆ„Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åô
          const commentField = document.querySelector('textarea[name="comment[body]"]')
          if (commentField) {
            commentField.value = text
            commentField.focus()
            // ÂÖ•Âäõ„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åó„Å¶„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Á≠â„Çí„Éà„É™„Ç¨„Éº
            commentField.dispatchEvent(new Event('input', { bubbles: true }))
            
            // ÊàêÂäü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            this.showAppliedFeedback()
          }
        }

        getCurrentCommentText() {
          const commentField = document.querySelector('textarea[name="comment[body]"]')
          return commentField ? commentField.value : ""
        }

        showAppliedFeedback() {
          // ‰∏ÄÊôÇÁöÑ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
          const feedback = document.createElement('div')
          feedback.className = 'fixed top-4 right-4 bg-purple-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300'
          feedback.textContent = 'ÊèêÊ°à„ÇíÈÅ©Áî®„Åó„Åæ„Åó„ÅüÔºÅ'
          document.body.appendChild(feedback)
          
          // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
          setTimeout(() => {
            feedback.style.transform = 'translateY(-10px)'
            feedback.style.opacity = '0'
          }, 2000)
          
          setTimeout(() => {
            feedback.remove()
          }, 2500)
        }
      }

      // Register controllers
      application.register("image-test", ImageTestController)
      application.register("image-comments", ImageCommentsController)
      application.register("global-comment-pins", GlobalCommentPinsController)
      application.register("ai-comment-assistant", AiCommentAssistantController)
      application.register("compact-comments", CompactCommentsController)
      application.register("ai-sidebar", AiSidebarController)
      
      // „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®
      window.application = application
      
      console.log("Stimulus application started and controllers registered!")
    </script>
  </head>

  <body class="bg-gray-100 text-gray-800">
    <div class="flex">
      <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
      <%= render 'layouts/sidebar' %>

      <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
      <main class="flex-1 p-8 ml-64">
        <% if notice %>
          <div class="bg-green-100 text-green-800 p-4 rounded mb-4"><%= notice %></div>
        <% end %>

        <% if alert %>
          <div class="bg-red-100 text-red-800 p-4 rounded mb-4"><%= alert %></div>
        <% end %>

        <%= yield %>
      </main>
    </div>
  </body>
</html>